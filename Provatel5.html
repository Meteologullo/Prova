
<!DOCTYPE html><html lang="it"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Meteo Calabria¬†‚Äî Dashboard¬†Pro¬†v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Baloo+2:wght@600&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
:root{--bg:linear-gradient(135deg,#e0efff,#bee1ff 40%,#a5d4ff);
--panel:rgba(255,255,255,.3);--blur:18px;--radius:18px;
--accent:#0ea5e9;--accent-alt:#38bdf8;--text:#07223a;--text-dim:#32506e;
--marker-size:clamp(22px,5vw,48px);--good:#16a34a;--bad:#dc2626}
@media(prefers-color-scheme:dark){
 :root{--bg:linear-gradient(135deg,#001219,#004065 40%,#006494);
       --panel:rgba(255,255,255,.08);--text:#ecf1f8;--text-dim:#96a3ba}}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html,body{height:100%}
body{font-family:"Inter",sans-serif;background:var(--bg);color:var(--text);
      display:flex;flex-direction:column;align-items:center;gap:22px;padding:22px 12px}
#searchForm{display:flex;gap:.6rem;width:100%;max-width:820px}
#cityInput{flex:1;border:none;border-radius:var(--radius);background:var(--panel);
           backdrop-filter:blur(var(--blur));padding:.9rem 1.1rem;font-size:1rem;outline:none;color:var(--text)}
#searchForm button{border:none;border-radius:var(--radius);
                   background:linear-gradient(135deg,var(--accent),var(--accent-alt));
                   color:#fff;font-weight:700;font-size:1rem;padding:.9rem 1.35rem;cursor:pointer}
#widget{width:100%;max-width:820px;display:grid;grid-template-columns:1fr auto;
        grid-template-areas:"header header""map forecast""bottom bottom";gap:0;
        border-radius:22px;overflow:hidden;box-shadow:0 14px 40px rgba(0,0,0,.28);
        position:relative;background:var(--panel);backdrop-filter:blur(var(--blur))}
@media(max-width:600px){
 #widget{grid-template-columns:1fr;grid-template-areas:"header""map""forecast""bottom"}}
header{grid-area:header;padding:20px;font-family:"Baloo 2",cursive;text-shadow:0 2px 10px rgba(0,0,0,.3)}
header h1{font-size:clamp(28px,7vw,40px);font-weight:800}
header p{font-size:clamp(14px,3vw,18px);font-weight:600;opacity:.9}
#mapArea{grid-area:map;position:relative;padding-bottom:70%;margin:0 16px;border-radius:10px;overflow:hidden}
#mapArea img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none;opacity:.3}
.marker{position:absolute;left:0;top:0;transform:translate(-50%,-50%);
        font-size:var(--marker-size);cursor:var(--cursor,default);
        filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));user-select:none}
.marker.editing{animation:pulse 1.2s infinite}@keyframes pulse{0%{transform:translate(-50%,-50%) scale(1)}
50%{transform:translate(-50%,-50%) scale(1.15)}100%{transform:translate(-50%,-50%) scale(1)}}
#forecastWrapper{grid-area:forecast;display:flex;overflow-x:auto;padding-bottom:4px;margin-right:16px}
#forecast{border-collapse:collapse;font-size:.9rem;min-width:260px;background:var(--panel);backdrop-filter:blur(10px);
          border-radius:12px;overflow:hidden;margin:auto}
#forecast th,#forecast td{padding:6px 12px;white-space:nowrap}
#forecast th{background:rgba(255,255,255,.2);font-family:"Baloo 2",cursive}
#forecast tr:nth-child(even){background:rgba(255,255,255,.08)}
#forecast tr:hover{background:rgba(255,255,255,.14)}
#forecast td:nth-child(2),#forecast td:nth-child(3){font-weight:700;font-size:18px}
#bottomBar{grid-area:bottom;display:flex;align-items:center;gap:10px;background:var(--panel);backdrop-filter:blur(8px);padding:10px 16px}
#nav{flex:1;display:flex;gap:6px;overflow-x:auto}
#nav button{background:transparent;border:none;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer;color:var(--text);transition:.2s}
#nav button:hover{background:rgba(255,255,255,.3)}#nav button.active{background:var(--accent);color:#fff}
.fab-btn{width:46px;height:46px;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 6px 14px rgba(0,0,0,.3);transition:transform .2s}
.fab-btn:hover{transform:scale(1.1)}
.loading{position:absolute;inset:0;background:#0004;display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;backdrop-filter:blur(2px);z-index:10;text-align:center;padding:0 10px}
@media(max-width:400px){#forecast td:nth-child(2),#forecast td:nth-child(3){font-size:16px}}
</style>
</head><body>

<form id="searchForm">
 <label for="cityInput" class="sr-only">Cerca citt√†</label>
 <input id="cityInput" placeholder="Scrivi una citt√† o usa üìç‚Ä¶" autocomplete="off" required>
 <button type="submit" aria-label="Cerca"><i class="fa-solid fa-search"></i></button>
</form>

<div id="widget">
 <div class="loading" id="loader" aria-live="polite">Carico dati‚Ä¶</div>
 <header><h1 id="hDay">GIORNO¬†1</h1><p id="hDate"></p></header>
 <div id="mapArea">
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Map_of_region_of_Calabria%2C_Italy.svg/565px-Map_of_region_of_Calabria%2C_Italy.svg.png" alt="Mappa Calabria">
 </div>
 <div id="forecastWrapper"><table id="forecast"></table></div>
 <div id="bottomBar">
  <button class="fab-btn" id="editBtn" title="Modifica mappa" aria-label="Modifica mappa"><i class="fa-solid fa-pen-to-square"></i></button>
  <nav id="nav" aria-label="Seleziona giorno previsioni"></nav>
  <button class="fab-btn" id="adminBtn" title="Pannello admin" aria-label="Pannello admin"><i class="fa-solid fa-gear"></i></button>
 </div>
</div>

<footer style="font-size:.8rem;color:var(--text-dim);max-width:820px;text-align:center">
Previsioni automatiche ‚Äì dati <a href="https://open-meteo.com" target="_blank">Open‚ÄëMeteo</a> e rete privata¬†MLG.</footer>

<script>
const MAP_BOUNDS={latMin:37.90,latMax:40.30,lonMin:15.60,lonMax:17.30};
const DEFAULT_MARKERS=[{city:"Cosenza",lat:39.299,lon:16.253},{city:"Catanzaro",lat:38.909,lon:16.587},
{city:"Reggio Calabria",lat:38.114,lon:15.65},{city:"Crotone",lat:39.083,lon:17.125},
{city:"Vibo Valentia",lat:38.673,lon:16.104}];

let markers;
try{
  const saved=localStorage.getItem("calabriaMarkers");
  markers=saved?JSON.parse(saved):DEFAULT_MARKERS.slice();
}catch(e){
  console.warn("JSON storage parse error",e);
  markers=DEFAULT_MARKERS.slice();
}

let DAYS=[],curDay=0,editMode=false;
const $=q=>document.querySelector(q);

function showError(msg){
  const l=$("#loader");l.textContent=msg;l.style.display="flex";
}

window.addEventListener("error",e=>{showError("Errore JS: "+e.message)});
window.addEventListener("unhandledrejection",e=>{showError("Errore di rete/Promise")});

function latLonToXY(lat,lon){
  return {
    x:(lon-MAP_BOUNDS.lonMin)/(MAP_BOUNDS.lonMax-MAP_BOUNDS.lonMin)*100,
    y:(1-(lat-MAP_BOUNDS.latMin)/(MAP_BOUNDS.latMax-MAP_BOUNDS.latMin))*100
  };
}
function wmo(code,night){
  const d={0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖÔ∏è",3:"üå•Ô∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",
    51:"üå¶Ô∏è",53:"üå¶Ô∏è",55:"üå¶Ô∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",80:"üåßÔ∏è",81:"üåßÔ∏è",82:"üåßÔ∏è",
    66:"üå®Ô∏è",67:"üå®Ô∏è",71:"üå®Ô∏è",73:"üå®Ô∏è",75:"üå®Ô∏è",77:"üå®Ô∏è",85:"üå®Ô∏è",86:"üå®Ô∏è",95:"‚õàÔ∏è",96:"‚õàÔ∏è",99:"‚õàÔ∏è"};
  const n=Object.assign({},d,{0:"üåô",1:"üåô",2:"‚õÖÔ∏è",3:"‚òÅÔ∏è"});
  return (night?n:d)[code]||"‚ùì";
}
function fetchForecast(lat,lon){
  const url="https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&timezone=auto&daily=temperature_2m_max,temperature_2m_min,weathercode,sunrise,sunset";
  return fetch(url).then(r=>{
    if(!r.ok)throw new Error(r.status);
    return r.json();
  });
}

function buildNav(){
  $("#nav").innerHTML=DAYS.map((d,i)=>'<button '+(i===curDay?'class="active"':'')+' data-i="'+i+'">'+d.label+'</button>').join("");
  $("#nav").querySelectorAll("button").forEach(b=>b.addEventListener("click",e=>{
      curDay=parseInt(e.currentTarget.dataset.i,10);updateNav();render();
  }));
}
function updateNav(){$("#nav").querySelectorAll("button").forEach((b,i)=>b.classList.toggle("active",i===curDay));}
function render(){
  if(!DAYS[curDay])return;
  const d=DAYS[curDay];
  $("#hDay").textContent=d.label;
  const dt=new Date();dt.setDate(dt.getDate()+d.offset);
  $("#hDate").textContent=dt.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long"}).toUpperCase();
  const area=$("#mapArea");area.querySelectorAll(".marker").forEach(m=>m.remove());
  d.points.forEach(p=>{
     const mk=document.createElement("div");
     mk.className="marker"+(editMode?" editing":"");
     mk.style.left=p.x+"%";mk.style.top=p.y+"%";
     mk.textContent=p.icon;mk.title=p.city+": "+p.tmax+"¬∞ / "+p.tmin+"¬∞";
     area.appendChild(mk);
  });
  const tbl=$("#forecast");
  tbl.innerHTML="<tr><th>Citt√†</th><th>‚¨ÜÔ∏è</th><th>‚¨áÔ∏è</th></tr>"+d.points.map(p=>'<tr><td>'+p.city+"</td><td>"+p.tmax+"¬∞</td><td>"+p.tmin+"¬∞</td></tr>").join("");
  $("#loader").style.display="none";
}

async function loadData(){
  $("#loader").style.display="flex";
  let timedOut=false;
  const timer=setTimeout(()=>{timedOut=true;showError("Timeout rete. Riprova pi√π tardi.");},15000);
  try{
    const results=await Promise.all(markers.map(m=>fetchForecast(m.lat,m.lon).catch(e=>null)));
    if(timedOut)return;
    clearTimeout(timer);
    if(results.some(r=>!r)){showError("Errore connessione dati meteo.");return;}
    const len=results[0].daily.time.length;
    DAYS=[];
    for(let d=0;d<len;d++){
      const o={label:"GIORNO¬†"+(d+1),offset:d,points:[]};
      markers.forEach((m,idx)=>{
        const fc=results[idx];
        const sunrise=new Date(fc.daily.sunrise[d]);const sunset=new Date(fc.daily.sunset[d]);
        const nowDate=new Date();const night=nowDate<sunrise||nowDate>sunset;
        const xy=latLonToXY(m.lat,m.lon);
        o.points.push({city:m.city,x:xy.x,y:xy.y,
          icon:wmo(fc.daily.weathercode[d],night),
          tmax:Math.round(fc.daily.temperature_2m_max[d]),
          tmin:Math.round(fc.daily.temperature_2m_min[d])});
      });
      DAYS.push(o);
    }
    buildNav();render();
  }catch(e){showError("Errore: "+e.message);}
}
loadData();

$("#editBtn").addEventListener("click",function(){
  editMode=!editMode;
  $("#editBtn i").className=editMode?"fa-solid fa-eye":"fa-solid fa-pen-to-square";
  document.querySelectorAll(".marker").forEach(m=>m.classList.toggle("editing",editMode));
});

document.getElementById("mapArea").addEventListener("dblclick",function(e){
  if(!editMode)return;
  const rect=this.getBoundingClientRect();
  const x=(e.clientX-rect.left)/rect.width;
  const y=(e.clientY-rect.top)/rect.height;
  const lat=MAP_BOUNDS.latMax-(MAP_BOUNDS.latMax-MAP_BOUNDS.latMin)*y;
  const lon=MAP_BOUNDS.lonMin+(MAP_BOUNDS.lonMax-MAP_BOUNDS.lonMin)*x;
  const city=prompt("Nome citt√†:");
  if(city){
    markers.push({city:city,lat:+lat.toFixed(3),lon:+lon.toFixed(3)});saveMarkers();
  }
});
function saveMarkers(){localStorage.setItem("calabriaMarkers",JSON.stringify(markers));loadData();}
</script>
</body></html>
