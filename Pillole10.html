<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Meteo Lo Gullo — Pillole con barra nav (V20)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  :root{--brand:#1e5bff; --bg:#f6f7fb; --panel:#3c3f44; --panel-ink:#fff; --panel-muted:#aeb3bd;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:#111}
  header{background:var(--brand);color:#fff;padding:10px 14px;font-weight:700;letter-spacing:.2px;font-size:16px}
  #map-wrap{position:relative;margin:12px}
  #map{height:calc(100vh - 220px);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.12);background:#fff}
  .controls{display:flex;gap:8px;align-items:center;margin:8px 12px 6px 12px;flex-wrap:wrap}
  label{font-size:12px;color:#555}
  input[type=number]{padding:6px 8px;border:1px solid #d1d5db;border-radius:10px;min-width:120px;background:#fff}
  button{padding:7px 10px;border-radius:11px;border:0;background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#e5e7eb;color:#111}
  .muted{opacity:.75}

  /* === CHIP (pilloline) === */
  .leaflet-marker-icon.t-label{ background:transparent; border:none; transform: translate(-50%, -50%); }
  .leaflet-div-icon.t-label{ background:transparent; border:none; }
  .t-chip{
    display:inline-flex;align-items:center;justify-content:center;
    padding:1px 6px;border-radius:999px;font-weight:900;font-size:11px;
    line-height:1;min-width:28px;height:19px;border:1px solid rgba(0,0,0,.35);
    box-shadow:0 1px 2px rgba(0,0,0,.18);user-select:none;-webkit-font-smoothing:antialiased;
    color:#000;text-shadow:none;font-variant-numeric:tabular-nums
  }
  .t-chip.pulse{ animation:pulse 0.9s ease-in-out 0s 3; }
  @keyframes pulse{
    0%{ transform:scale(1) translateZ(0) }
    50%{ transform:scale(1.15) translateZ(0) }
    100%{ transform:scale(1) translateZ(0) }
  }

  /* === LEGEND (progress + gradient scale) === */
  .legend{margin:0 12px 10px 12px;font-size:13px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef0f3}
  .dot{width:9px;height:9px;border-radius:999px;display:inline-block}
  .scale-wrap{display:flex;align-items:center;gap:10px;margin:6px 12px 2px 12px}
  .scale-bar{height:12px;width:300px;border-radius:10px;border:1px solid #ccc;background:linear-gradient(90deg,#eee,#333)}
  .scale-labels{display:flex;justify-content:space-between;font-size:11px;color:#555;margin:2px 12px 0 12px;width:300px}

  /* removed search */
      
  /* === VERTICAL TOOLBAR === */
  .toolbar{
    position:absolute;left:10px;top:10px;height:calc(100% - 20px);width:38px;
    background:rgba(60,63,68,.95);border-radius:10px;z-index:550;
    box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column;align-items:center;padding:6px 0;gap:10px
  }
  .toolbtn{
    width:28px;height:28px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
    display:grid;place-items:center;background:transparent;color:var(--panel-ink);cursor:pointer;
    transition:transform .12s ease, background .12s ease, color .12s ease
  }
  .toolbtn:hover{ transform:translateY(-1px) }
  .toolbtn svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2}
  .toolbtn.active{ background:#2a7fff;color:#fff;border-color:#2a7fff }
  .divider{width:70%;height:1px;background:rgba(255,255,255,.15);margin:2px 0 1px 0}

  .tooltip{position:absolute;left:44px;transform:translateY(-50%);background:rgba(16,18,20,.9);color:#fff;
           padding:4px 8px;border-radius:7px;font-size:12px;white-space:nowrap;pointer-events:none;opacity:0;transition:.12s}
  .toolwrap{position:relative}
  .toolwrap:hover .tooltip{opacity:1}

  @media (max-width:740px){
        .scale-bar,.scale-labels{width:220px}
  }
</style>
</head>
<body>
<header>- Meteo Lo Gullo · MeteoHub (V20 — barra nav, metriche live)</header>

<div class="controls" style="display:none">
  <label>Finestra (ore): <input id="hours" type="number" value="24" min="1" max="168"></label>
  <button id="reload">Ricarica</button>
  <button id="fit" class="secondary">Centra mappa</button>
  <span id="status" class="muted"></span>
</div>

<div class="scale-wrap">
  <div id="dyn-scale" class="scale-bar" title="Scala dinamica"></div>
  <div id="dyn-label" style="font-size:11px;color:#555"></div>
</div>
<div id="dyn-labels" class="scale-labels"></div>

<div id="map-wrap">
  <div id="map"></div>

  <!-- Vertical toolbar inside map -->
  <div class="toolbar" id="toolbar">
    <div class="toolwrap">
      <button class="toolbtn active" data-mode="t" title="Temperatura">
        <svg viewBox="0 0 24 24"><path d="M14 14.76V5a2 2 0 10-4 0v9.76a4 4 0 106.66 3.1"/><path d="M10 10h4"/></svg>
      </button>
      <div class="tooltip">Temperatura</div>
    <div class="toolwrap">
      <button class="toolbtn" data-mode="tmin" title="Temperatura minima">
        <svg viewBox="0 0 24 24"><path d="M14 14.76V5a2 2 0 10-4 0v9.76a4 4 0 106.66 3.1"/><path d="M8 18h8"/></svg>
      </button>
      <div class="tooltip">Minima</div>
    </div>
    <div class="toolwrap">
      <button class="toolbtn" data-mode="tmax" title="Temperatura massima">
        <svg viewBox="0 0 24 24"><path d="M14 14.76V5a2 2 0 10-4 0v9.76a4 4 0 106.66 3.1"/><path d="M8 6h8"/></svg>
      </button>
      <div class="tooltip">Massima</div>
    </div>

    </div>
    <div class="divider"></div>
    <div class="toolwrap">
      <button class="toolbtn" data-mode="rh" title="Umidità">
        <svg viewBox="0 0 24 24"><path d="M12 3C12 3 6 9 6 13a6 6 0 0012 0c0-4-6-10-6-10z"/></svg>
      </button>
      <div class="tooltip">Umidità</div>
    </div>
    <div class="toolwrap">
      <button class="toolbtn" data-mode="ws" title="Vento">
        <svg viewBox="0 0 24 24"><path d="M3 8h10a3 3 0 100-6 3 3 0 00-3 3"/><path d="M3 14h14a3 3 0 110 6 3 3 0 01-3-3"/></svg>
      </button>
      <div class="tooltip">Vento</div>
    </div>
    <div class="toolwrap">
      <button class="toolbtn" data-mode="wg" title="Raffica">
        <svg viewBox="0 0 24 24"><path d="M4 12h12a4 4 0 110 8 4 4 0 01-4-4"/><path d="M3 7h9a3 3 0 100-6"/></svg>
      </button>
      <div class="tooltip">Raffica</div>
    </div>
    <div class="toolwrap">
      <button class="toolbtn" data-mode="rain" title="Pioggia odierna">
        <svg viewBox="0 0 24 24"><path d="M16 13a4 4 0 10-8 0"/><path d="M12 2v2"/><path d="M5 22l1.5-3M10 22l1.5-3M15 22l1.5-3M20 22l1.5-3"/></svg>
      </button>
      <div class="tooltip">Pioggia odierna</div>
    </div>
    <div class="toolwrap">
      <button class="toolbtn" data-mode="range" title="Escursione termica">
        <svg viewBox="0 0 24 24"><path d="M4 18V6M20 6v12M4 12h16M8 8l3 3-3 3M16 8l-3 3 3 3"/></svg>
      </button>
      <div class="tooltip">Escursione termica</div>
    </div>
    <div class="divider"></div>
    <div class="toolwrap">
      <button class="toolbtn" id="btn-reload" title="Aggiorna">
        <svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 10-3.51 7.06"/><path d="M21 12l-3-3M21 12l-3 3"/></svg>
      </button>
      <div class="tooltip">Aggiorna dati</div>
    </div>
  </div>

<div id="note" class="legend"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function(){
  // ---------- UTIL ----------
  function safeGet(obj, path){
    try{ var cur=obj; path.split('.').forEach(function(p){ cur = cur ? cur[p] : undefined; }); return cur;
    }catch(e){ return undefined; }
  }
  function toNum(v){ var n = Number(v); return isFinite(n)? n : null; }
  function notNull(x){ return x!==undefined && x!==null; }
  function pad(n){ return String(n).padStart(2, '0'); }
  function fmtSpace(dt){ return dt.getUTCFullYear() + '-' + pad(dt.getUTCMonth()+1) + '-' + pad(dt.getUTCDate()) + ' ' + pad(dt.getUTCHours()) + ':' + pad(dt.getUTCMinutes()); }
  function fmtLocal(dt){ try{ var d=(dt instanceof Date)? dt : new Date(dt); if(!isFinite(d)) return null; return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes()); }catch(_){ return null; } }

  var DECIMALS = 1;
  function fmtTemp(v){ return (v==null || !isFinite(v))? '&ndash;' : Number(v).toFixed(DECIMALS).replace('.', ','); }

  // ---------- MAP ----------
  var map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap', maxZoom:18}).addTo(map);

  // === Centri (come V19) ===
  var CENTERS = [
    {"key":"A","name":"Centro A","lat":39.25,"lon":16.43583,"color":"#4f46e5"},
    {"key":"B","name":"Centro B","lat":39.28731,"lon":16.26483,"color":"#16a34a"},
    {"key":"C","name":"Nocelle-Arvo","lat":39.24722,"lon":16.54444,"color":"#ef4444"},
    {"key":"D","name":"Cecita","lat":39.4,"lon":16.5375,"color":"#22c55e"},
    {"key":"E","name":"Monte Curcio-Camigl.","lat":39.32139,"lon":16.42889,"color":"#3b82f6"},
    {"key":"F","name":"Gambarie","lat":38.19278,"lon":15.84417,"color":"#eab308"},
    {"key":"G","name":"Albidona","lat":39.92611,"lon":16.46639,"color":"#a855f7"},
    {"key":"H","name":"Antonimina","lat":38.275,"lon":16.14722,"color":"#f97316"},
    {"key":"I","name":"Limina","lat":38.37139,"lon":16.18917,"color":"#06b6d4"},
    {"key":"J","name":"Plati'","lat":38.22222,"lon":16.04444,"color":"#84cc16"},
    {"key":"K","name":"Roccaforte del Greco","lat":38.04444,"lon":15.90278,"color":"#ec4899"},
    {"key":"L","name":"Rogliano","lat":39.18361,"lon":16.32583,"color":"#10b981"},
    {"key":"M","name":"S.Agata del Bianco","lat":38.09167,"lon":16.08194,"color":"#8b5cf6"},
    {"key":"N","name":"Villapiana","lat":39.79694,"lon":16.48139,"color":"#f59e0b"},
    {"key":"O","name":"Campo Tenese","lat":39.855,"lon":16.08778,"color":"#ef4444"},
    {"key":"P","name":"Belvedere Marittimo","lat":39.62972,"lon":15.85167,"color":"#22c55e"},
    {"key":"Q","name":"Oriolo","lat":40.05,"lon":16.44694,"color":"#3b82f6"},
    {"key":"R","name":"Serrarossa","lat":39.06889,"lon":16.89056,"color":"#eab308"},
    {"key":"S","name":"Rosarno","lat":38.49972,"lon":15.98361,"color":"#a855f7"},
    {"key":"T","name":"Montebello Ionico","lat":37.9875,"lon":15.72861,"color":"#f97316"},
    {"key":"U","name":"Joppolo","lat":38.58278,"lon":15.8925,"color":"#06b6d4"},
    {"key":"V","name":"Roseto Capo Spulico","lat":39.99111,"lon":16.60667,"color":"#84cc16"},
    {"key":"W","name":"Botricello","lat":38.93778,"lon":16.85639,"color":"#ec4899"},
    {"key":"X","name":"Corigliano Calabro","lat":39.58694,"lon":16.52111,"color":"#10b981"},
    {"key":"Y","name":"Amantea","lat":39.15,"lon":16.07806,"color":"#8b5cf6"},
    {"key":"Z","name":"Spineto","lat":39.16333,"lon":16.54,"color":"#f59e0b"},
    {"key":"AA","name":"Arena","lat":38.55806,"lon":16.21278,"color":"#ef4444"},
    {"key":"AB","name":"Capo Vaticano","lat":38.61917,"lon":15.8325,"color":"#22c55e"},
    {"key":"AC","name":"Parenti","lat":39.16361,"lon":16.40556,"color":"#3b82f6"},
    {"key":"AD","name":"Cenadi - Serralta","lat":38.73361,"lon":16.34389,"color":"#eab308"},
    {"key":"AE","name":"Serra S.Bruno","lat":38.56611,"lon":16.3125,"color":"#a855f7"},
    {"key":"AF","name":"S.Cristina d'Aspr.","lat":38.25278,"lon":15.97361,"color":"#f97316"},
    {"key":"AG","name":"Cardeto","lat":38.11111,"lon":15.81444,"color":"#06b6d4"},
    {"key":"AH","name":"Gioiosa Ionica","lat":38.30139,"lon":16.32556,"color":"#84cc16"},
    {"key":"AI","name":"Cropalati","lat":39.51389,"lon":16.73056,"color":"#ec4899"},
    {"key":"AJ","name":"Fitterizzi Meteo","lat":39.52401,"lon":16.16225,"color":"#10b981"},
    {"key":"AK","name":"Torano Scalo","lat":39.47444,"lon":16.20083,"color":"#8b5cf6"},
    {"key":"AL","name":"Cosenza Crati","lat":39.28731,"lon":16.26483,"color":"#f59e0b"},
    {"key":"AM","name":"Satriano","lat":38.67528,"lon":16.53278,"color":"#ef4444"},
    {"key":"AN","name":"Chiaravalle","lat":38.67222,"lon":16.40167,"color":"#22c55e"},
    {"key":"AO","name":"Spadola","lat":38.60278,"lon":16.33722,"color":"#3b82f6"},
    {"key":"AP","name":"Catanzaro","lat":38.9125,"lon":16.58194,"color":"#eab308"},
    {"key":"AQ","name":"Vibo Valentia","lat":38.67361,"lon":16.10278,"color":"#a855f7"},
    {"key":"AR","name":"Botte Donato","lat":39.25,"lon":16.43583,"color":"#f97316"},
    {"key":"AS","name":"Fabrizia","lat":38.49167,"lon":16.30278,"color":"#06b6d4"},
    {"key":"AT","name":"Mongiana P.","lat":38.51667,"lon":16.31944,"color":"#84cc16"},
    {"key":"AU","name":"Cassari","lat":38.44444,"lon":16.29167,"color":"#ec4899"},
    {"key":"AV","name":"Canolo Nuovo","lat":38.33222,"lon":16.15333,"color":"#10b981"},
    {"key":"AW","name":"Castrovillari","lat":39.78611,"lon":16.25556,"color":"#8b5cf6"},
    {"key":"AX","name":"Reggio Calabria","lat":38.10278,"lon":15.63889,"color":"#f59e0b"},
    {"key":"AY","name":"Lamezia","lat":38.86528,"lon":16.24417,"color":"#ef4444"},
    {"key":"AZ","name":"Papanice","lat":39.07222,"lon":17.02778,"color":"#22c55e"},
    {"key":"BA","name":"Cutro","lat":39.03667,"lon":17.01528,"color":"#3b82f6"},
    {"key":"BB","name":"Salica","lat":39.01389,"lon":17.12778,"color":"#eab308"},
    {"key":"BC","name":"Crotone Molo Giunti","lat":39.08221,"lon":17.13555,"color":"#a855f7"},
    {"key":"BD","name":"Ciro' Marina","lat":39.40722,"lon":17.11083,"color":"#f97316"},
    {"key":"BE","name":"Tarsia","lat":39.6225,"lon":16.27806,"color":"#06b6d4"},
    {"key":"BF","name":"S.Sosti","lat":39.66111,"lon":16.02778,"color":"#84cc16"},
    {"key":"BG","name":"S.Pietro in Guarano","lat":39.34056,"lon":16.30417,"color":"#ec4899"},
    {"key":"BH","name":"Domanico","lat":39.21667,"lon":16.20278,"color":"#10b981"},
    {"key":"BI","name":"Tiriolo","lat":38.94639,"lon":16.51972,"color":"#8b5cf6"},
    {"key":"BJ","name":"Montalto Uffugo","lat":39.39806,"lon":16.12083,"color":"#f59e0b"},
    {"key":"BK","name":"Isola Capo Rizzuto","lat":38.93722,"lon":17.02333,"color":"#ef4444"},
    {"key":"BL","name":"Mileto","lat":38.60556,"lon":16.06056,"color":"#22c55e"},
    {"key":"BM","name":"Nicastro","lat":38.9775,"lon":16.30361,"color":"#3b82f6"},
    {"key":"BN","name":"Feroleto","lat":38.46583,"lon":16.06028,"color":"#eab308"},
    {"key":"BO","name":"Palermiti","lat":38.75333,"lon":16.44778,"color":"#a855f7"},
    {"key":"BP","name":"Cittanova","lat":38.35361,"lon":16.07861,"color":"#f97316"},
    {"key":"BQ","name":"Scilla","lat":38.25083,"lon":15.71389,"color":"#06b6d4"},
    {"key":"BR","name":"Paola","lat":39.36111,"lon":16.04167,"color":"#84cc16"},
    {"key":"BS","name":"S.Mauro Marchesato","lat":39.10278,"lon":16.92778,"color":"#ec4899"},
    {"key":"BT","name":"Soverato Marina","lat":38.69,"lon":16.54444,"color":"#10b981"},
    {"key":"BU","name":"Bovalino Marina","lat":38.15031,"lon":16.18149,"color":"#8b5cf6"},
    {"key":"BV","name":"Reggio Calabria - Catona","lat":38.185,"lon":15.63806,"color":"#f59e0b"},
    {"key":"BW","name":"Cortale","lat":38.83361,"lon":16.40222,"color":"#ef4444"},
    {"key":"BX","name":"Castrovillari - Camerata","lat":39.73316,"lon":16.27101,"color":"#22c55e"},
    {"key":"BY","name":"Martirano","lat":39.08306,"lon":16.23667,"color":"#3b82f6"},
    {"key":"BZ","name":"Rizziconi","lat":38.40778,"lon":15.97167,"color":"#eab308"},
    {"key":"CA","name":"Sant'Alessio in Aspromonte","lat":38.175,"lon":15.75611,"color":"#a855f7"},
    {"key":"CB","name":"Zungri","lat":38.65056,"lon":15.98222,"color":"#f97316"},
    {"key":"CC","name":"Crucoli","lat":39.42444,"lon":17.00361,"color":"#06b6d4"},
    {"key":"CD","name":"Acri","lat":39.5,"lon":16.40278,"color":"#84cc16"},
    {"key":"CE","name":"Cetraro Superiore","lat":39.5175,"lon":15.94056,"color":"#ec4899"},
    {"key":"CF","name":"Scilla - Tagli","lat":38.24917,"lon":15.76472,"color":"#10b981"},
    {"key":"CG","name":"Arasi'","lat":38.12056,"lon":15.73667,"color":"#8b5cf6"},
    {"key":"CH","name":"Punta Stilo","lat":38.43556,"lon":16.57,"color":"#f59e0b"},
    {"key":"CI","name":"Staiti","lat":38.00167,"lon":16.03417,"color":"#ef4444"},
    {"key":"CJ","name":"Bova Superiore","lat":37.99667,"lon":15.93,"color":"#22c55e"},
    {"key":"CK","name":"Stignano","lat":38.41889,"lon":16.46833,"color":"#3b82f6"},
    {"key":"CL","name":"Roccelletta","lat":38.81444,"lon":16.55972,"color":"#eab308"},
    {"key":"CM","name":"San Nicola da Crissa","lat":38.65917,"lon":16.29917,"color":"#a855f7"},
    {"key":"CN","name":"Monte Scrisi","lat":38.235,"lon":15.71583,"color":"#f97316"},
    {"key":"CO","name":"Altilia","lat":39.12944,"lon":16.25528,"color":"#06b6d4"},
    {"key":"CP","name":"Pietrastorta","lat":38.11972,"lon":15.68972,"color":"#84cc16"},
    {"key":"CQ","name":"Sellia Superiore","lat":38.98528,"lon":16.62083,"color":"#ec4899"},
    {"key":"CR","name":"Petilia Policastro","lat":39.11444,"lon":16.76639,"color":"#10b981"},
    {"key":"CS","name":"Allai","lat":38.02639,"lon":15.74861,"color":"#8b5cf6"},
    {"key":"CT","name":"Cosenza 118","lat":39.30583,"lon":16.23556,"color":"#f59e0b"},
    {"key":"CU","name":"Corbino","lat":38.95139,"lon":16.565,"color":"#ef4444"},
    {"key":"CV","name":"Belsito","lat":39.17528,"lon":16.28083,"color":"#22c55e"},
    {"key":"CW","name":"Mormanno","lat":39.885,"lon":15.99222,"color":"#3b82f6"},
    {"key":"CX","name":"Decollatura","lat":39.04917,"lon":16.335,"color":"#eab308"}
  ];
  var bounds = L.latLngBounds(CENTERS.map(function(c){return [c.lat, c.lon];}));
  map.fitBounds(bounds.pad(0.25));

  // ---------- SCALES (colori dedicati per metrica) ----------
  function lerp(a,b,t){ return a + (b-a)*t; }
  function hsl(h,s,l){ return 'hsl('+h+','+s+'%,'+l+'%)'; }
  function interpStops(stops, x){
    if (x==null || !isFinite(x)) return '#e5e7eb';
    var i=0;
    if (x<=stops[0].x) return stops[0].c;
    while(i<stops.length-1 && x>stops[i+1].x) i++;
    var A=stops[i], B=stops[Math.min(i+1,stops.length-1)];
    var k = (x - A.x)/Math.max(1e-9,(B.x-A.x));
    // Interpola HSL se i colori sono come {h,s,l}
    if (A.h!=null){
      var dh = ((B.h - A.h + 540) % 360) - 180;
      var hh = (A.h + k*dh + 360)%360;
      return hsl(hh, lerp(A.s,B.s,k), lerp(A.l,B.l,k));
    }
    // Interpola hex -> lasciamo step
    return k<.5? A.c : B.c;
  }

  // Temperatura (-15..50 °C) — ricca e “sensibile”
  var SCALE_T = [
    {x:-15,h:275,s:85,l:35},{x:-10,h:250,s:85,l:40},{x:-5,h:220,s:85,l:45},
    {x:0,h:200,s:85,l:45},{x:5,h:190,s:80,l:50},{x:10,h:170,s:75,l:45},
    {x:15,h:150,s:75,l:40},{x:20,h:120,s:80,l:45},{x:25,h:90,s:85,l:50},
    {x:30,h:60,s:95,l:55},{x:35,h:40,s:95,l:52},{x:38,h:20,s:95,l:50},
    {x:40,h:0,s:95,l:45},{x:42,h:345,s:90,l:55},{x:45,h:315,s:85,l:60},{x:50,h:290,s:80,l:65}
  ];

  // Umidità 0..100% — dal secco (giallo/sabbia) al saturo (blu intenso)
  var SCALE_RH = [
    {x:0,h:45,s:95,l:80},{x:20,h:50,s:95,l:70},{x:40,h:95,s:70,l:55},
    {x:60,h:140,s:60,l:45},{x:80,h:195,s:70,l:50},{x:100,h:220,s:80,l:55}
  ];

  // Vento (km/h) — ispirato a Beaufort: calmo grigio, moderato verde, forte arancio/rosso, tempesta magenta
  var SCALE_WS = [
    {x:0,h:0,s:0,l:90},{x:5,h:120,s:10,l:75},{x:10,h:120,s:40,l:55},{x:20,h:90,s:70,l:50},
    {x:30,h:48,s:95,l:55},{x:50,h:25,s:95,l:52},{x:75,h:5,s:95,l:45},{x:100,h:315,s:80,l:60},{x:140,h:285,s:75,l:65}
  ];

  // Raffica (km/h) — stessa palette ma shiftata verso toni più “caldi”
  var SCALE_WG = [
    {x:0,h:0,s:0,l:90},{x:15,h:90,s:60,l:55},{x:30,h:60,s:95,l:55},
    {x:50,h:35,s:95,l:52},{x:75,h:15,s:95,l:50},{x:100,h:350,s:95,l:48},{x:140,h:315,s:85,l:58}
  ];

  // Pioggia giornaliera (mm) — azzurro -> blu -> viola, molto sensibile 0..200+
  var SCALE_RAIN = [
    {x:0,h:0,s:0,l:92},{x:0.2,h:200,s:35,l:85},{x:1,h:210,s:50,l:75},{x:5,h:215,s:60,l:65},
    {x:10,h:220,s:70,l:55},{x:20,h:225,s:75,l:48},{x:35,h:230,s:80,l:45},
    {x:50,h:255,s:80,l:45},{x:75,h:270,s:70,l:45},{x:100,h:285,s:70,l:45},{x:150,h:295,s:60,l:45},{x:220,h:300,s:60,l:42}
  ];

  // Escursione termica (°C) — grigio -> giallo/ambra -> rosso vivo (0..30+)
  var SCALE_RANGE = [
    {x:0,h:0,s:0,l:92},{x:2,h:55,s:95,l:70},{x:5,h:45,s:95,l:55},{x:8,h:35,s:95,l:52},
    {x:12,h:25,s:95,l:50},{x:16,h:15,s:95,l:48},{x:20,h:5,s:95,l:46},{x:26,h:345,s:90,l:50},{x:32,h:330,s:85,l:55}
  ];

  function colorByMode(mode, val){
    switch(mode){
      case 'tmin':
      case 'tmax':
      case 'rh': return interpStops(SCALE_RH, val);
      case 'ws': return interpStops(SCALE_WS, val);
      case 'wg': return interpStops(SCALE_WG, val);
      case 'rain': return interpStops(SCALE_RAIN, val);
      case 'range': return interpStops(SCALE_RANGE, val);
      default: return interpStops(SCALE_T, val);
    }
  }

  // ---------- ICON + POPUP ----------
  function formatByMode(mode, st){
    if (mode==='rh') return (st.rh==null? '&ndash;' : Number(st.rh).toFixed(0));
    if (mode==='ws') return (st.ws==null? '&ndash;' : Number(st.ws).toFixed(0));
    if (mode==='wg') return (st.wg==null? '&ndash;' : Number(st.wg).toFixed(0));
    if (mode==='rain') return (st.rain==null? '&ndash;' : Number(st.rain).toFixed(1).replace('.', ','));
    if (mode==='tmin') return (st.tMin==null? '&ndash;' : Number(st.tMin).toFixed(1).replace('.', ','));
    if (mode==='tmax') return (st.tMax==null? '&ndash;' : Number(st.tMax).toFixed(1).replace('.', ','));
    if (mode==='range'){
      var d = (st.tMax!=null && st.tMin!=null)? (st.tMax - st.tMin) : null;
      return (d==null? '&ndash;' : Number(d).toFixed(1).replace('.', ','));
    }
    return fmtTemp(st.t); // default temp
  }
  function valueByMode(mode, st){
    if (mode==='rh') return st.rh;
    if (mode==='ws') return st.ws;
    if (mode==='wg') return st.wg;
    if (mode==='rain') return st.rain;
    if (mode==='tmin') return st.tMin;
    if (mode==='tmax') return st.tMax;
    if (mode==='range') return (st.tMax!=null && st.tMin!=null)? (st.tMax - st.tMin) : null;
    return st.t;
  }
  function chipIconGeneric(mode, st){
    var v = valueByMode(mode, st);
    var col = colorByMode(mode, v);
    var txt = formatByMode(mode, st);
    var html = '<div class="t-chip" data-id="'+(st.id||'')+'" style="background:'+col+'">'+txt+'</div>';
    return L.divIcon({className:'t-label', html:html, popupAnchor:[0,-12]});
  }

  function buildPopupHTML(st){
    var ventoPart = (st.ws!=null? (st.ws.toFixed(0) + ' km/h') : '--');
    if (st.wd!=null) ventoPart += ' ('+st.wd.toFixed(0)+'&deg;)';
    var rafficaPart = (st.wg!=null? (st.wg.toFixed(0)+' km/h') : '--');
    var updated = st.updatedAt ? ('<div style="font-size:11px;color:#666;margin-top:4px">Aggiornato: '+fmtLocal(st.updatedAt)+'</div>') : '';
    var esc = (st.tMin!=null && st.tMax!=null)? (Number(st.tMax - st.tMin).toFixed(1).replace('.', ',')) : '&ndash;';
    return ''
      + '<div style="font-weight:700;margin-bottom:4px">'+(st.name||'Stazione')+(st.id? ' <small style="color:#666">('+st.id+')</small>' : '')+'</div>'
      + '<div><b>Temp:</b> '+(st.t!=null? fmtTemp(st.t)+'&nbsp;&deg;C' : '--')+'</div>'
      + '<div><b>Umidit&agrave;:</b> '+(st.rh!=null? st.rh.toFixed(0)+'%' : '--')+'</div>'
      + '<div><b>Min:</b> '+(st.tMin!=null? fmtTemp(st.tMin)+'&nbsp;&deg;C' : '--')+' / <b>Max:</b> '+(st.tMax!=null? fmtTemp(st.tMax)+'&nbsp;&deg;C' : '--')+'</div>'
      + '<div><b>Escursione:</b> '+esc+'&nbsp;&deg;C</div>'
      + '<div><b>Vento:</b> '+ventoPart+' / <b>Raffica:</b> '+rafficaPart+'</div>'
      + '<div><b>Pioggia odierna:</b> '+((st.rain!=null? st.rain:0).toFixed(1))+' mm</div>'
      + updated;
  }

  // ---------- NORMALIZZAZIONE DATI (come V19) ----------
  function productPool(st){ return st && (st.prod || st.products || st['var'] || st.variables || st); }
  function getProd(st, code){
    var P = productPool(st); if (!P) return null;
    if (Array.isArray(P)){
      for (var i=0;i<P.length;i++){ var p=P[i]; var v=(p.var||p.code||'')+''; if (v.toUpperCase()===(code+'').toUpperCase()) return p; } return null;
    }
    if (typeof P === 'object') return P[code] || P[String(code)] || null;
    return null;
  }
  function series(prod){
    var raw = prod && (prod.val || prod.values || prod.series || prod.data || prod);
    var out=[];
    if (Array.isArray(raw)){
      for (var i=0;i<raw.length;i++){
        var r=raw[i], val=r&&(notNull(r.val)? r.val : r.value), time=r&&(r.ref||r.reftime||r.time||r.ts);
        if (notNull(val)) out.push({val: Number(val), time: time});
      }
    }
    return out.filter(function(x){return x.val!=null;});
  }
  function todayOnly(arr){
    var d=new Date(); var y=d.getUTCFullYear(), m=d.getUTCMonth()+1, dd=d.getUTCDate();
    var dayStr = y+'-'+String(m).padStart(2,'0')+'-'+String(dd).padStart(2,'0');
    var s=(arr||[]).filter(function(p){ return p.time && String(p.time).slice(0,10)===dayStr; });
    s.sort(function(a,b){ return new Date(a.time)-new Date(b.time); }); return s;
  }
  function rainTodayCalc(seriesAll){
    var s=todayOnly(seriesAll); if (!s.length) return 0;
    var nonDec=true; for(var i=1;i<s.length;i++){ if (s[i].val < s[i-1].val - 1e-6){ nonDec=false; break; } }
    if (nonDec) return Math.max(0, s[s.length-1].val - s[0].val);
    var sum=0; for (var j=0;j<s.length;j++){ if (s[j].val >= 0) sum += s[j].val; } return sum;
  }
  function lastVal(prod){
    var s = series(prod); if (s.length) return s[s.length-1].val;
    return toNum(prod && (prod.val!=null? prod.val : prod.value));
  }
  function latestObsTime(){ var best=null; var args=Array.prototype.slice.call(arguments);
    for (var i=0;i<args.length;i++){ var p=args[i]; if(!p) continue; var s=series(p); if(s && s.length){ var tt=new Date(s[s.length-1].time); if(isFinite(tt)) best = (best && best>tt)? best : tt; } } return best; }
  function pickName(st){
    var S = st.station || st.stat || st.stationDetails || st.details || {};
    var cand = [
      st.assignedName, st.assigned_name, st.stationAssignedName,
      S.assignedName, S.assigned_name,
      st.name, S.name, st.station_name, st.stationName, S.stationName,
      st.label, S.label, S.description, S.desc,
      st.siteName, S.siteName, S.site,
      st.locationName, S.locationName, st.localita, st['località'], S.localita, S['località'],
      st.city, S.city, st.municipality, S.municipality, st.comune, S.comune,
      safeGet(st,'stat.details.name'), safeGet(st,'stat.details.val')
    ];
    for (var i=0;i<cand.length;i++){ if (cand[i] && String(cand[i]).trim()) return String(cand[i]).trim(); }
    return 'Stazione';
  }
  function normalize(st){
    var S = st.station || st.stat || st.stationDetails || st.details || {};
    var id  = st.id || st.station_id || st.code || S.id || S.code || null;
    var lat = toNum(st.lat || st.latitude || S.lat || S.latitude || safeGet(st,'stat.lat') || safeGet(st,'stat.latitude'));
    var lon = toNum(st.lon || st.longitude || S.lon || S.longitude || safeGet(st,'stat.lon') || safeGet(st,'stat.longitude'));
    var name = pickName(st);
    var T   = getProd(st,'B12101');
    var RH  = getProd(st,'B13003');
    var WS  = getProd(st,'B11002');
    var WG  = getProd(st,'B11041') || getProd(st,'B11042');
    var WD  = getProd(st,'B11001');
    var RR  = getProd(st,'B13011');
    var tS = series(T).map(function(p){ return {val:(p.val>120? p.val-273.15:p.val), time:p.time}; });
    var tToday = todayOnly(tS);
    var tMin = tToday.length ? Math.min.apply(null, tToday.map(function(x){return x.val;})) : (tS.length? tS[tS.length-1].val : null);
    var tMax = tToday.length ? Math.max.apply(null, tToday.map(function(x){return x.val;})) : (tS.length? tS[tS.length-1].val : null);
    var tLast = tS.length? tS[tS.length-1].val : null;
    function asKmH(val, unit){
      if (val==null) return null; var u=(unit||'').toUpperCase();
      if (u.indexOf('M/S')>=0) return val*3.6;
      if (u.indexOf('KM/H')>=0 || u.indexOf('KMH')>=0) return val;
      if (u.indexOf('KT')>=0 || u.indexOf('KNOT')>=0) return val*1.852;
      return val<60? val*3.6 : val;
    }
    var rhLast = lastVal(RH);
    var wsKmH = asKmH(lastVal(WS), WS && WS.unit);
    var wgKmH = asKmH(lastVal(WG), WG && WG.unit);
    var wdDeg = lastVal(WD);
    var rainToday = rainTodayCalc(series(RR));
    var updatedAt = latestObsTime(T,RH,WS,WG,WD,RR);
    return {id:id,lat:lat,lon:lon,name:name,t:tLast,rh:rhLast,ws:wsKmH,wg:wgKmH,wd:wdDeg,rain:rainToday,tMin:tMin,tMax:tMax,updatedAt: updatedAt};
  }

  // ---------- FETCH ----------
  function buildURL(center, q){
    var base = new URL('https://meteohub.agenziaitaliameteo.it/api/observations');
    base.searchParams.set('q', q);
    base.searchParams.set('lat', center.lat);
    base.searchParams.set('lon', center.lon);
    base.searchParams.set('networks', 'dpcn-calabria');
    base.searchParams.set('stationDetails', 'true');
    base.searchParams.set('allStationProducts', 'true');
    base.searchParams.set('limit', '200');
    return base.toString();
  }
  function fetchJSON(u, timeoutMs){
    if (timeoutMs==null) timeoutMs = 15000;
    return new Promise(function(resolve, reject){
      var ctrl = new AbortController();
      var t = setTimeout(function(){ try{ctrl.abort();}catch(e){} reject(new Error('timeout')); }, timeoutMs);
      fetch(u, {cache:'no-store', signal: ctrl.signal}).then(function(r){
        if (!r.ok){ r.text().then(function(body){ clearTimeout(t); reject(new Error('HTTP '+r.status+(body? ' | body: '+body : ''))); }); return; }
        r.json().then(function(j){ clearTimeout(t); resolve(j); }).catch(function(e){ clearTimeout(t); reject(e); });
      }).catch(function(e){ clearTimeout(t); reject(e); });
    });
  }
  var PRODUCTS = 'B12101 or B13011 or B11002 or B11001 or B11041 or B11042 or B13003 or B10004';
  function buildStableQ(from, to){
    return 'reftime:>='+from+',<='+to+';timerange:254,0,0 or 1,0,3600;level:103,2000,0,0 or 1,0,0,0 or 103,10000,0,0;license:CCBY_COMPLIANT;product:'+PRODUCTS;
  }
  function buildMinimalQ(from, to){
    return 'reftime:>='+from+',<='+to+';timerange:1,0,3600;license:CCBY_COMPLIANT;product:B12101,B13011,B11002,B11001,B11041,B11042,B13003,B10004';
  }
  function fetchForCenter(center, fromStr, toStr){
    return new Promise(function(resolve, reject){
      var qStable = buildStableQ(fromStr, toStr);
      var qMinimal = buildMinimalQ(fromStr, toStr);
      var url = buildURL(center, qStable);
      fetchJSON(url).then(function(res){
        var list = Array.isArray(res)? res : (res.stations || res.data || res.results || []);
        resolve({center:center, list:list, variant:'stable'});
      }).catch(function(e){
        if (String(e && e.message).indexOf('HTTP 400')>=0){
          var url2 = buildURL(center, qMinimal);
          fetchJSON(url2).then(function(res2){
            var list2 = Array.isArray(res2)? res2 : (res2.stations || res2.data || res2.results || []);
            resolve({center:center, list:list2, variant:'minimal'});
          }).catch(function(e2){ reject(e2); });
        }else{
          reject(e);
        }
      });
    });
  }

  function pMap(items, mapper, opts){
    opts = opts||{};
    var concurrency = Math.min(opts.concurrency||10, items.length||0);
    return new Promise(function(resolve){
      var ret = new Array(items.length);
      var index=0, finished=0;
      function runNext(){
        if (index >= items.length){ if (++finished === concurrency) resolve(ret); return; }
        var myIndex = index++;
        mapper(items[myIndex], myIndex).then(function(val){
          ret[myIndex] = val;
          if (opts.onEach) try{ opts.onEach(val, myIndex); }catch(e){}
          runNext();
        }).catch(function(err){
          ret[myIndex] = {error:String(err), center:items[myIndex]};
          if (opts.onEach) try{ opts.onEach(ret[myIndex], myIndex); }catch(e){}
          runNext();
        });
      }
      for (var k=0;k<concurrency;k++) runNext();
    });
  }

  // ---------- STAZIONI & MARKER ----------
  var STATIONS = [];        // { ...normalized }
  var MARKERS  = [];        // Leaflet markers, same index as STATIONS
  var MODE = 't';           // default
  var statusEl = null;

  function bubbleMarker(st){
    var m = L.marker([st.lat, st.lon], {icon: chipIconGeneric(MODE, st)});
    m.bindPopup(buildPopupHTML(st));
    return m;
  }

  function addStations(list){
    for (var i=0;i<list.length;i++){
      var st=list[i];
      if (!isFinite(st.lat)||!isFinite(st.lon)) continue;
      STATIONS.push(st);
      var m=bubbleMarker(st).addTo(map);
      MARKERS.push(m);
    }
  }

  function updateMarkers(){
    for (var i=0;i<STATIONS.length;i++){
      var st=STATIONS[i], m=MARKERS[i];
      if (!m) continue;
      m.setIcon(chipIconGeneric(MODE, st));
    }
    updateScaleBar();
  }

  function clearStations(){
    for (var i=0;i<MARKERS.length;i++){ try{ map.removeLayer(MARKERS[i]); }catch(_){ } }
    STATIONS.length=0; MARKERS.length=0;
  }

  function updateLegend(progress){
    var html = '';
    for (var i=0;i<progress.length;i++){
      var cs = progress[i];
      html += '<span class=\"pill\"><span class=\"dot\" style=\"background:'+cs.color+'\"></span><b>'+cs.name+'</b>: '+cs.count+' stazioni ('+cs.variant+')</span>';
    }
    document.getElementById('note').innerHTML = html;
  }

  function updateScaleBar(){
    var bar = document.getElementById('dyn-scale');
    var lbl = document.getElementById('dyn-label');
    var ticks = document.getElementById('dyn-labels');
    var g=''; var labels=[];
    if (MODE==='t' || MODE==='tmin' || MODE==='tmax'){ g = 'linear-gradient(90deg,'+SCALE_T.map(s=>hsl(s.h,s.s,s.l)).join(',')+')'; lbl.textContent='Temperatura (°C)'; labels=['-15','-5','5','15','25','35','45+']; }
    else if (MODE==='rh'){ g='linear-gradient(90deg,'+SCALE_RH.map(s=>hsl(s.h,s.s,s.l)).join(',')+')'; lbl.textContent='Umidità relativa (%)'; labels=['0','20','40','60','80','100']; }
    else if (MODE==='ws'){ g='linear-gradient(90deg,'+SCALE_WS.map(s=>hsl(s.h,s.s,s.l)).join(',')+')'; lbl.textContent='Vento (km/h)'; labels=['0','10','20','30','50','75','100+']; }
    else if (MODE==='wg'){ g='linear-gradient(90deg,'+SCALE_WG.map(s=>hsl(s.h,s.s,s.l)).join(',')+')'; lbl.textContent='Raffica (km/h)'; labels=['0','30','50','75','100','140+']; }
    else if (MODE==='rain'){ g='linear-gradient(90deg,'+SCALE_RAIN.map(s=>hsl(s.h,s.s,s.l)).join(',')+')'; lbl.textContent='Pioggia odierna (mm)'; labels=['0','1','5','10','20','50','100','200+']; }
    else if (MODE==='range'){ g='linear-gradient(90deg,'+SCALE_RANGE.map(s=>hsl(s.h,s.s,s.l)).join(',')+')'; lbl.textContent='Escursione termica (°C)'; labels=['0','2','5','8','12','16','20','26','32+']; }
    bar.style.background = g;
    ticks.innerHTML = labels.map(function(x){ return '<span>'+x+'</span>'; }).join('');
  }

  // ---------- NETWORKING RUN ----------
  function run(){
    if(!statusEl) statusEl = document.getElementById('status');
    if (statusEl) statusEl.textContent = 'caricamento...';
    clearStations();
    var hours = Number(document.getElementById('hours')? document.getElementById('hours').value : 24)||24;
    var now = new Date();
    var from = new Date(now.getTime() - hours*3600*1000);
    var fromStr = fmtSpace(from), toStr = fmtSpace(now);
    var progress = CENTERS.map(function(c){ return {name:c.name, color:c.color, count:0, variant:'--'}; });
    updateLegend(progress);
    pMap(CENTERS, function(c){
      return fetchForCenter(c, fromStr, toStr).then(function(r){
        var norm = (r.list||[]).map(function(x){ var n = normalize(x); if(!n.name || String(n.name).trim()==='' || String(n.name).trim().toLowerCase()==='stazione'){ n.name = r.center && r.center.name ? r.center.name : n.name; } return n; });
        return {center:c, norm:norm, variant:r.variant};
      });
    }, {
      concurrency: 10,
      onEach: function(item, idx){
        var isErr = item && item.error;
        if (!isErr){
          addStations(item.norm);
          progress[idx] = {name:item.center.name, color:item.center.color, count:item.norm.length, variant:item.variant};
        }else{
          progress[idx] = {name:item.center.name, color:item.center.color, count:0, variant:'errore'};
        }
        updateLegend(progress);
      }
    }).then(function(){ updateMarkers(); if (statusEl) statusEl.textContent = ''; });
  }

  // ---- WUnderground PWS ----
  const WU_API_KEY = 'e1f10a1e78da46f5b10a1e78da96f525';
  const WU_STATIONS = [
    { id: 'IAMANT7',  label: 'Amantea (PWS)', lat: null, lon: null },
    { id: 'ICOSEN11', label: 'ICOSEN11',      lat: null, lon: null },
    { id: 'ICOSEN20', label: 'ICOSEN20',      lat: null, lon: null },
    { id: 'ICELIC3',  label: 'ICELIC3',       lat: null, lon: null },
    { id: 'IMENDI13', label: 'IMENDI13',      lat: null, lon: null },
    { id: 'ICASAL40', label: 'ICASAL40',      lat: null, lon: null },
    { id: 'ICOSEN12', label: 'ICOSEN12',      lat: null, lon: null },
    { id: 'ICOSEN19', label: 'ICOSEN19',      lat: null, lon: null },
    { id: 'IRENDE25', label: 'IRENDE25',      lat: null, lon: null },
    { id: 'ICASAL63', label: 'ICASAL63',      lat: null, lon: null },
    { id: 'ICELIC2',  label: 'ICELIC2',       lat: null, lon: null },
    { id: 'ICASAL84', label: 'ICASAL84',      lat: null, lon: null },
    { id: 'IRENDE5',  label: 'IRENDE5',       lat: null, lon: null }
  ];
  const WU_COLOR = '#111827';
  function numOrNull(v){ if (v === null || v === undefined) return null; var n = parseFloat(v); return isNaN(n)? null : n; }
  function fetchWUStation(stId, apiKey, customLabel, overrideLat, overrideLon){
    const base = new URL('https://api.weather.com/v2/pws/observations/current');
    base.searchParams.set('stationId', stId);
    base.searchParams.set('format', 'json');
    base.searchParams.set('units', 'm');
    base.searchParams.set('numericPrecision', 'decimal');
    base.searchParams.set('apiKey', apiKey);
    return fetchJSON(base.toString()).then(function(j){
      const o = (j && j.observations && j.observations[0]) || null;
      if (!o) return null;
      const met = o.metric || {};
      return {
        id: o.stationID || stId,
        lat: (numOrNull(overrideLat) != null ? numOrNull(overrideLat) : Number(o.lat)),
        lon: (numOrNull(overrideLon) != null ? numOrNull(overrideLon) : Number(o.lon)),
        name: (customLabel && customLabel.trim()) ? customLabel : ((o.neighborhood || stId) + ' (WU)'),
        t: met.temp!=null? Number(met.temp) : null,
        rh: o.humidity!=null? Number(o.humidity) : null,
        ws: met.windSpeed!=null? Number(met.windSpeed) : null,
        wg: met.windGust!=null? Number(met.windGust) : null,
        wd: o.winddir!=null? Number(o.winddir) : null,
        rain: met.precipTotal!=null? Number(met.precipTotal) : 0,
        tMin: null,tMax: null,
        updatedAt: (function(){ try{ if (o.obsTimeUtc) return new Date(o.obsTimeUtc); if (o.obsTimeLocal) return new Date(o.obsTimeLocal); if (o.epoch) return new Date(Number(o.epoch)*1000); }catch(_){ } return null; })()
      };
    }).catch(function(){ return null; });
  }
  function fetchWUAll(){
    if (!WU_API_KEY || !WU_STATIONS.length) return Promise.resolve({list:[], count:0});
    const proms = WU_STATIONS.map(function(s){ return fetchWUStation(s.id, WU_API_KEY, s.label || '', s.lat, s.lon); });
    return Promise.all(proms).then(function(items){
      const list = items.filter(function(x){ return x && isFinite(x.lat) && isFinite(x.lon); });
      for (var i=0;i<list.length;i++){
        STATIONS.push(list[i]);
        var m=bubbleMarker(list[i]).addTo(map);
        MARKERS.push(m);
      }
      updateMarkers();
      try{
        var pill = '<span class=\"pill\"><span class=\"dot\" style=\"background:'+WU_COLOR+'\"></span><b>WUnderground PWS</b>: '+(list.length||0)+' stazioni</span>';
        var el = document.getElementById('note'); el.innerHTML = el.innerHTML + pill;
      }catch(e){}
      return {list:list, count:list.length};
    });
  }

  // ---------- UI (toolbar + search) ----------
  function selectMode(m){
    MODE = m;
    var btns = document.querySelectorAll('.toolbtn[data-mode]');
    btns.forEach(function(b){ if (b.getAttribute('data-mode')===m) b.classList.add('active'); else b.classList.remove('active'); });
    updateMarkers();
  }
  document.getElementById('toolbar').addEventListener('click', function(ev){
    var b = ev.target.closest('.toolbtn');
    if (!b) return;
    var mode = b.getAttribute('data-mode');
    if (!mode){ if (b.id==='btn-reload'){ run(); } return; }
    selectMode(mode);
  });
  document.getElementById('btn-reload').addEventListener('click', function(){ run(); });

    // ---------- INIT ----------
  document.getElementById('fit')?.addEventListener('click', function(){ map.fitBounds(bounds.pad(0.25)); });
  document.getElementById('reload')?.addEventListener('click', function(){ run(); });
  updateScaleBar();
  run(); fetchWUAll();

})();</script>

<!-- Firestore stubs (lasciati no-op per compattezza del file da test) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
(function(){ window.fetchDailyExtremes = async function(){ return {min:null,max:null}; }; })();
</script>
</body>
</html>
