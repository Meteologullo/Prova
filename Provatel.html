
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Meteo Calabria Dashboard</title>

<!-- Fonts & Icon sets -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-o+UqUyIu7H8IOb0m0Rn4qUY06Hz1sjH31B9wJC0uYJGzZP+yzn6BX2OvrjMphNQxEijqVDWkjbeIzj4w3YCpDw==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css" integrity="sha512-PCA4HWSh4yTp2rBXp8jT9L6nvw23GeFNzIqKxEDrP+ygkUpXQU6qZW58xLcxM7PMqnA69pJT0mT5Qw6wpoxS8g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
:root{
 --bg:#0e1726;
 --fg:#f5f6fc;
 --accent:#29c5ff;
 --glass:rgba(255,255,255,.05);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
 font-family:"Inter",sans-serif;
 background:linear-gradient(160deg,#001021 0%,#012b4d 100%);
 color:var(--fg);
 display:flex;flex-direction:column;align-items:center;
 min-height:100vh;
}
header{padding:20px 0;text-align:center}
h1{font-weight:600;letter-spacing:.5px;margin-bottom:6px;font-size:1.65rem}
#widget{
 width:100%;max-width:820px;
 display:grid;grid-template-columns:1fr 1fr;
 grid-template-areas:"map forecast";
 gap:24px;padding:0 16px 48px;
}
@media(max-width:600px){
 #widget{grid-template-columns:1fr;grid-template-areas:"map" "forecast"}
}
#mapArea{
 grid-area:map;position:relative;border-radius:12px;overflow:hidden;
 box-shadow:0 8px 24px rgba(0,0,0,.4);
}
#mapArea::before{
 content:"";position:absolute;inset:0;background:var(--glass);backdrop-filter:blur(4px);
}
#map{
 position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
 filter:brightness(.9) contrast(1.1);
}
.marker{
 position:absolute;transform:translate(-50%,-100%);
 display:flex;flex-direction:column;align-items:center;
 font-size:22px;transition:transform .2s;
}
.marker i{text-shadow:0 0 3px rgba(0,0,0,.6)}
.marker span{font-size:12px;margin-top:2px}
body.edit .marker{cursor:grab}
body.edit .marker:active{cursor:grabbing}
#forecast{
 grid-area:forecast;background:var(--glass);backdrop-filter:blur(6px);
 padding:12px;border-radius:12px;overflow:auto;max-height:70vh
}
#forecast table{width:100%;border-collapse:collapse;font-size:14px}
#forecast th,#forecast td{padding:6px 8px;text-align:center}
#forecast th{font-weight:600;border-bottom:1px solid rgba(255,255,255,.15)}
footer{margin-top:auto;font-size:12px;padding:16px 0;color:rgba(255,255,255,.6)}
#settings{
 position:fixed;bottom:20px;right:20px;width:48px;height:48px;border-radius:50%;
 background:var(--accent);color:#00324f;display:flex;align-items:center;justify-content:center;
 font-size:24px;box-shadow:0 4px 10px rgba(0,0,0,.4);z-index:999;cursor:pointer;transition:transform .2s;
}
#settings:active{transform:scale(.92)}
</style>
</head>
<body>
<header><h1>Meteo Calabria</h1></header>

<section id="widget">
  <div id="mapArea">
    <img id="map" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/88/Calabria_in_Italy.svg/800px-Calabria_in_Italy.svg.png" alt="Mappa Calabria">
  </div>
  <div id="forecast">
    <table id="tblForecast"></table>
  </div>
</section>

<button id="settings" title="Doppio‑tap per modifica / click per refresh"><i class="fas fa-cog"></i></button>
<footer>Dati meteo © Open‑Meteo · Dashboard ereditata e rinnovata 2025</footer>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js" integrity="sha512-opSuFeUObt8A2ba7U2U5b2j7EzL93h9PPVNEU8EWmxbqYh9pYxa9Pb+EgnChP8A4yAj7+R41V/E66CpkFwB1mg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
const INITIAL_STATIONS=[
 {name:"Cosenza",lat:39.298,lon:16.253,icon:"wi-day-sunny"},
 {name:"Catanzaro",lat:38.905,lon:16.594,icon:"wi-day-cloudy"},
 {name:"Reggio Calabria",lat:38.114,lon:15.651,icon:"wi-day-sunny"}
];
const MAP_BOUNDS={latTop:40.3,latBottom:37.9,lonLeft:15.3,lonRight:17.2};
const mapArea=document.getElementById('mapArea');
const tbl=document.getElementById('tblForecast');
const settings=document.getElementById('settings');
let editMode=false;

/* ——— helpers ——— */
function latLonToXY(lat,lon){
 const x=(lon-MAP_BOUNDS.lonLeft)/(MAP_BOUNDS.lonRight-MAP_BOUNDS.lonLeft)*100;
 const y=100-(lat-MAP_BOUNDS.latBottom)/(MAP_BOUNDS.latTop-MAP_BOUNDS.latBottom)*100;
 return [x,y];
}
function codeToIcon(code,lat,lon){
 const now=new Date();
 const t=SunCalc.getTimes(now,lat,lon);
 const night=now<t.sunrise || now>t.sunset;
 const p=night?'wi-night-':'wi-day-';
 if(code===0) return p+'clear';
 if(code===1) return p+'sunny-overcast';
 if(code===2) return p+'cloudy';
 if(code===3) return 'wi-cloud';
 if([45,48].includes(code)) return 'wi-fog';
 if([51,53,55,56,57].includes(code)) return p+'rain';
 if([61,63,65,80,81,82].includes(code)) return 'wi-rain';
 if([71,73,75,77,85,86].includes(code)) return 'wi-snow';
 if([95,96,99].includes(code)) return 'wi-thunderstorm';
 return 'wi-na';
}
function makeDraggable(el){
 el.style.touchAction='none';
 el.addEventListener('pointerdown',startDrag);
 el.addEventListener('click',editIcon);
}
function disableDraggable(el){
 el.removeEventListener('pointerdown',startDrag);
 el.removeEventListener('click',editIcon);
}
function startDrag(e){
 if(!editMode) return;
 const el=e.currentTarget;
 const rect=mapArea.getBoundingClientRect();
 const shiftX=e.clientX-el.getBoundingClientRect().left;
 const shiftY=e.clientY-el.getBoundingClientRect().top;
 function moveAt(px,py){
   const pctX=(px-rect.left-shiftX)/rect.width*100;
   const pctY=(py-rect.top-shiftY)/rect.height*100;
   el.style.left=pctX+'%';el.style.top=pctY+'%';
 }
 moveAt(e.clientX,e.clientY);
 function onMove(ev){moveAt(ev.clientX,ev.clientY);}
 document.addEventListener('pointermove',onMove);
 document.addEventListener('pointerup',function up(){
   document.removeEventListener('pointermove',onMove);
   saveMarkers();
 },{once:true});
}
function editIcon(e){
 if(!editMode) return;
 const el=e.currentTarget;
 const cur=el.dataset.icon;
 const val=prompt('Codice icona Weather Icons',cur);
 if(val&&val!==cur){
   el.dataset.custom="1";
   el.dataset.icon=val;
   el.querySelector('i').className='wi '+val;
   saveMarkers();
 }
}
function saveMarkers(){
 const res=[...document.querySelectorAll('.marker')].map(m=>({
   name:m.dataset.name,
   icon:m.dataset.icon,
   x:parseFloat(m.style.left),
   y:parseFloat(m.style.top)
 }));
 localStorage.setItem('mlgMarkers',JSON.stringify(res));
}
function createMarker(obj){
 const m=document.createElement('div');
 m.className='marker';
 const [x,y]=obj.x!==undefined?[obj.x,obj.y]:latLonToXY(obj.lat,obj.lon);
 m.style.left=x+'%';m.style.top=y+'%';
 m.dataset.name=obj.name;m.dataset.icon=obj.icon||'wi-na';
 m.innerHTML='<i class="wi '+(obj.icon||'wi-na')+'"></i><span>'+obj.name+'</span>';
 mapArea.appendChild(m);
 if(editMode) makeDraggable(m);
}
function loadMarkers(){
 const stored=JSON.parse(localStorage.getItem('mlgMarkers')||'null');
 (stored||INITIAL_STATIONS).forEach(createMarker);
}
async function updateForecast(){
 const rows=['<tr><th>Località</th><th>Temp</th></tr>'];
 const markers=[...document.querySelectorAll('.marker')];
 for(const mk of markers){
   const st=INITIAL_STATIONS.find(s=>s.name===mk.dataset.name);
   if(!st){rows.push(`<tr><td>${mk.dataset.name}</td><td>‑</td></tr>`);continue;}
   const url=`https://api.open-meteo.com/v1/forecast?latitude=${st.lat}&longitude=${st.lon}&current=temperature_2m,weather_code&forecast_days=1`;
   try{
     const data=await fetch(url).then(r=>r.json());
     const temp=data?.current?.temperature_2m;
     const code=data?.current?.weather_code;
     const icon=codeToIcon(code,st.lat,st.lon);
     if(!mk.dataset.custom) mk.querySelector('i').className='wi '+icon;
     rows.push('<tr><td>'+st.name+'</td><td>'+Math.round(temp)+'°C</td></tr>');
   }catch(e){
     rows.push(`<tr><td>${st.name}</td><td>‑</td></tr>`);
   }
 }
 tbl.innerHTML=rows.join('');
}
function toggleEditMode(){
 editMode=!editMode;
 document.body.classList.toggle('edit',editMode);
 document.querySelectorAll('.marker').forEach(el=>{editMode?makeDraggable(el):disableDraggable(el)});
 if(!editMode) saveMarkers();
}
settings.addEventListener('click',()=>{if(!editMode) updateForecast()});
settings.addEventListener('dblclick',toggleEditMode);

window.addEventListener('load',()=>{
 loadMarkers();
 updateForecast();
});
</script>
</body>
</html>
