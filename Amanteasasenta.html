<!DOCTYPE html>

<html lang="it">
<head>
<style id="hideMarkerOpacity">.leaflet-marker-icon,.leaflet-marker-shadow{opacity:0;transition:opacity 0.15s linear;}</style>

<meta charset="utf-8"/>
<title>Mappa Meteo Calabria</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" rel="stylesheet"/>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDasXnVu7uIEjpwtQ-XbVilREGmAZSBjVE",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.firebasestorage.app",
    messagingSenderId: "469441159034",
    appId: "1:469441159034:web:b687adef4a7a742499c0c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.getExtremesFromFirebase = async function (stationId) {
    const q = query(collection(db, "osservazioni"), where("stationId", "==", stationId));
    const snapshot = await getDocs(q);
    let min = Infinity, max = -Infinity;
    snapshot.forEach(doc => {
      const temp = doc.data().temperatura;
      if (typeof temp === 'number') {
        if (temp < min) min = temp;
        if (temp > max) max = temp;
      }
    });
    return {
      min: min === Infinity ? null : min,
      max: max === -Infinity ? null : max
    };
  };


function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.pioggia !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const mm = parseFloat(d.pioggia) || 0;
        const colore = getColorPioggia(mm);

        // testo sempre leggibile
        const textColor = getTextColorForBackground(colore);
        const shadow = textColor === 'white'
          ? '0 0 3px rgba(0,0,0,0.7)'
          : '0 0 3px rgba(255,255,255,0.7)';

        el.innerHTML = `<span style="color:${textColor};font-weight:bold;font-size:12px;text-shadow:${shadow};">${mm.toFixed(1)}</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.borderRadius = '50%';
      }
    }
  });
}

  });
}


async function caricaDatiOpenMeteo() {
  for (const stazione of stazioni.filter(s => s.openMeteo)) {
    try {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${stazione.lat}&longitude=${stazione.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m`);
      const data = await res.json();
      datiTabella.push({
        stationId: stazione.stationId,
        temp: data.current.temperature_2m,
        tempVal: data.current.temperature_2m,
        pioggia: data.current.precipitation,
        umidita: data.current.relativehumidity_2m,
        raffica: data.current.wind_gusts_10m,
      });
    } catch (e) {
      console.error("Errore nel fetch OpenMeteo per", stazione.stationId, e);
    }
  }
}

</script>
<script>
window.extremiGiornalieri = {}; // rimosso statico

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    const valore = getEstremoGiornaliero(d.stationId, tipo);
    const colore = tipo === 'max' ? '#ff4444' : '#4466ff';
    const marker = markersById[d.stationId];
    if (valore && marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:white;'>${valore.toFixed(1)}°</span></div>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaAttuali() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.tempVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.tempVal);
        const textColor = getTextColorForBackground(colore);
        el.innerHTML = `<span style='color:${textColor};'>${d.temp}°</span></div>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaUmidita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:white;'>${d.umidita}%</span></div>`;
        el.style.backgroundColor = '#0099cc';
      }
    }
  });
}

function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:white;'>${d.raffica} km/h</span>`;
        el.style.backgroundColor = '#666';
      }
    }
  });
}


function getColorUmidita(val) {
  const r = Math.round(255 - (val * 2.0));
  const g = Math.round(140 - (val * 0.8));
  const b = Math.round(50 + (val * 2.0));
  return `rgb(${r < 0 ? 0 : r},${g < 0 ? 0 : g},${b > 255 ? 255 : b})</div>`;
}

function getColorVento(val) {
  const r = Math.min(255, Math.round(val * 5));
  const g = Math.max(0, 255 - Math.round(val * 3));
  return `rgb(${r},${g},60)</div>`;
}

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    const valore = getEstremoGiornaliero(d.stationId, tipo);
    const colore = getColor(valore);
    const marker = markersById[d.stationId];
    if (valore && marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaAttuali() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.tempVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.tempVal);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.temp}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaUmidita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorUmidita(d.umidita);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.umidita}%</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorVento(d.raffica);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.raffica}</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
      }
    }
  });
}


function getColorUmidita(val) {
  if (val <= 20) return "#ff5500";       // Secco intenso (arancio)
  if (val <= 40) return "#ffaa00";       // Secco moderato (giallo-arancio)
  if (val <= 60) return "#88cc44";       // Umido normale (verde chiaro)
  if (val <= 80) return "#44aaff";       // Umido (azzurro)
  return "#0055ff";                      // Molto umido (blu intenso)
}

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    const valore = getEstremoGiornaliero(d.stationId, tipo);
    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaAttuali() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.tempVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.tempVal);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.temp}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaUmidita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.umidita !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorUmidita(d.umidita);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.umidita}%</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.raffica !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorVento(d.raffica);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.raffica}</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
      }
    }
  });
}

</script>
<style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #f4f4f4; }

#banner {
  background-color: #1a3a9b; /* Colore blu */
  color: white;
  text-align: center;
  padding: 10px 0;
  font-size: 24px;
  font-weight: bold;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 1000;
}

#map {
  height: calc(100vh - 60px);
  width: 100%;
  border-bottom: 2px solid #ccc;
}

#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  padding: 20px;
}

.temperature-label {
  width: 26px !important;
  height: 26px !important;
  font-size: 13px !important;

  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-weight: bold;
  font-size: 15px;
  border: 2px solid #fff;
  color: #000;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.popup-title { font-size: 16px; font-weight: bold; }
.popup-sub { font-size: 13px; color: #666; margin-bottom: 6px; }
.popup-data { margin: 2px 0; font-size: 15px; }
.bold { font-weight: bold; }
.webcam-preview { width: 100%; max-height: 100px; object-fit: cover; margin-top: 5px; border-radius: 5px; }
.webcam-missing { font-size: 13px; color: #777; margin-top: 5px; text-align: center; }
.btn {
  display: inline-block;
  padding: 6px 10px;
  margin: 5px 5px 0 0;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-decoration: none;
  font-size: 13px;
}
.btn:hover { background-color: #0056b3; }
#popup-grafico {
  position: fixed;
  top: 10%;
  left: 5%;
  width: 90%;
  height: 80%;
  background: white;
  border: 2px solid #007bff;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  z-index: 10000;
}
#popup-grafico iframe { flex: 1; width: 100%; border: none; }
#popup-grafico .close-btn {
  background: red;
  color: white;
  padding: 5px;
  border: none;
  width: 100%;
  font-weight: bold;
  cursor: pointer;
}
a.btn { color: white !important; }
  
body {
  overflow-x: hidden;
}

#sidebar {
  pointer-events: auto;
  -ms-touch-action: none;
  touch-action: none;
}
#sidebar.sidebar-nascosta {
  transform: translateX(-50px);
  transition: transform 0.3s ease;
}

</style><style>
   .card.compact-extreme {
  font-size: 16px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fdfdfd;
  margin: 5px 0;
}
.card.compact-extreme span {
  font-size: 17px;
}
.card.compact-extreme .valore {
  font-size: 20px;
  color: #c00;
}
  </style><style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

html, body {
  scroll-padding-top: 60px; /* Compensa altezza banner fisso */
}
  </style><style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

#slide-banner.show {
  right: 0 !important;
}
  </style><style>
   .sidebar-btn.attivo {
  box-shadow: inset 0 0 4px #00000099;
  font-weight: bold;
  border-left: 2px solid #000;
}
  </style><style>
   /* Modernizzazione barra laterale */
#sidebar {
  background: linear-gradient(to bottom, #ffffffcc, #f0f0f0cc);
  border-right: 1px solid #bbb;
  box-shadow: 2px 0 6px rgba(0,0,0,0.15);
  backdrop-filter: blur(4px);
}

/* Pulsanti moderni */
.sidebar-btn {
  border-radius: 6px;
  margin: 6px 0;
  font-weight: 600;
  font-size: 11px;
  background-color: #e6e6e6;
  color: #333;
  border: 1px solid #ccc;
  transition: all 0.2s ease;
}

.sidebar-btn:hover {
  background-color: #d0d0d0;
  transform: scale(1.05);
}

.sidebar-btn.attivo {
  background-color: #007bff !important;
  color: white !important;
  border-left: 3px solid #004a99;
  box-shadow: inset 0 0 5px #00000033;
}
  </style><style>
   .highlight-temp {
    font-size: 36px;
    font-weight: bold;
}
  </style><style>
   .filter-button.active {
    background-color: #337ab7;
    color: white;
}
  </style><style>
   .filtro-box {
  background: white;
  padding: 12px;
  border-radius: 10px;
  margin: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.filtro-box label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}
.filtro-box select, .filtro-box input[type="checkbox"] {
  margin-top: 4px;
}
  </style><style>
   .card.compact-extreme {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #fefefe;
  margin: 6px 0;
  font-size: 15px;
}
.card.compact-extreme span.nome {
  font-weight: 600;
  flex: 1;
}
.card.compact-extreme span.valore {
  font-weight: bold;
  font-size: 16px;
  color: #c00;
  text-align: right;
}
  </style><style>
   #filtro-provincia, #filtro-ordinamento {
  margin-left: 6px;
  padding: 4px 8px;
  border-radius: 6px;
  background: #eef;
  font-weight: bold;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}
  </style><style>
   #filtro-provincia, #filtro-ordinamento {
  margin: 0;
  padding: 4px 6px;
  border-radius: 5px;
  background: #eef;
  font-weight: bold;
  font-size: 14px;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 6px;
}
.filtro-box label {
  font-size: 14px;
}
#filtro-mlg {
  transform: scale(0.9);
  margin-right: 4px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 13px;
  font-weight: 500;
  color: #333;
  margin-top: 4px;
}
  </style><style>
   /* Rendi tutto molto più compatto */
#filtro-provincia, #filtro-ordinamento {
  margin: 0;
  padding: 2px 5px;
  border-radius: 4px;
  background: #eef;
  font-weight: bold;
  font-size: 13px;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 4px;
  font-size: 13px;
}
.filtro-box label {
  font-size: 13px;
}
#filtro-mlg {
  transform: scale(0.85);
  margin-right: 4px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 12.5px;
  font-weight: 500;
  color: #333;
  margin: 2px 0 0 0;
}
  </style><style>
   /* Marker circle and label size adjustment */
.temperature-label, .leaflet-marker-icon {
  width: 26px !important;
  height: 26px !important;
  font-size: 11px !important;
  line-height: 26px !important;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  white-space: nowrap;
  border-radius: 50%;
}

/* MLG star size fix (assuming 'star-mlg' class or similar) */
.leaflet-marker-icon.star-mlg {
  width: 12px !important;
  height: 12px !important;
  transform: translate(-50%, -50%);
}
  </style><style>
   /* Marker circle and label size adjustment */
.temperature-label, .leaflet-marker-icon {
  width: 26px !important;
  height: 26px !important;
  font-size: 10px !important;
  line-height: 26px !important;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  white-space: nowrap;
  border-radius: 50%;
}

/* Visible and appropriately scaled MLG star icon */
.leaflet-marker-icon.star-mlg {
  width: 12px !important;
  height: 12px !important;
  transform: translate(-50%, -50%);
  display: inline-block !important;
  visibility: visible !important;
  z-index: 9999 !important;
}
  </style><style>
   #anteprima-live {
    background: linear-gradient(to bottom, #f8faff, #ffffff);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin: 16px auto;
    padding: 20px;
    max-width: 900px;
  }
  #anteprima-live h2 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 10px;
    color: #003366;
    text-align: center;
  }
  #preview-cards .card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffff;
    border: 1px solid #dde3ec;
    border-radius: 10px;
    padding: 12px 18px;
    margin-bottom: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    transition: transform 0.2s ease;
  }
  #preview-cards .card:hover {
    transform: scale(1.015);
  }
  #preview-cards .card .nome {
    font-weight: 600;
    font-size: 16px;
    color: #222;
  }
  #preview-cards .card .valore {
    font-size: 18px;
    font-weight: bold;
    color: #0055aa;
  }
  #preview-cards .card .btn {
    margin-left: auto;
    background-color: #007bff;
    border: none;
    padding: 6px 12px;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #preview-cards .card .btn:hover {
    background-color: #0056b3;
  }
  </style><style>
   #anteprima-live {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 500;
  background: rgba(255,255,255,0.95);
  border-top: 2px solid #ccc;
  padding: 14px 20px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  backdrop-filter: blur(6px);
}
  </style><style>
#map {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  height: auto;
  min-height: calc(100vh - 60px);
}
#anteprima-live {
  margin-top: auto;
}
</style><style>
/* MIGLIORAMENTO GRAFICO CARDS METEO PER MOBILE */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}

#tabella .card .intestazione {
  font-size: 17px;
  font-weight: 700;
  color: #003366;
  margin-bottom: 4px;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 14px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  display: inline-block;
  padding: 4px 6px;
  background: #007bff;
  color: white;
  font-size: 12px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 6px;
}

@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15px;
  }
}
}</style><style>
/* Stile migliorato per sezione anteprima testuale */
#anteprima-dati-testuali {
  position: absolute;
  top: calc(100vh - 160px);
  left: 0;
  width: 100%;
  background: linear-gradient(to bottom, #f9fbff, #ffffff);
  z-index: 9999;
  padding: 24px 18px;
  box-shadow: 0 -2px 14px rgba(0,0,0,0.15);
  border-top: 2px solid #ccd6e0;
  border-radius: 18px 18px 0 0;
  font-family: "Segoe UI", sans-serif;
}

#anteprima-dati-testuali > div:first-child {
  font-weight: 600;
  font-size: 17px;
  color: #003366;
  text-align: center;
  margin-bottom: 16px;
}

.filtro-box {
  background: #f0f4f8;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

.filtro-box label {
  font-weight: 500;
  font-size: 15px;
  display: block;
  color: #222;
}

.filtro-box input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.2);
}

.filtro-riga-select {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  font-size: 15px;
  margin-top: 10px;
}

.filtro-riga-select label {
  font-weight: 600;
}

#filtro-provincia, #filtro-ordinamento, #filtro-provincia-estremi {
  padding: 6px 10px;
  border-radius: 8px;
  background: #e6efff;
  border: 1px solid #aac4e6;
  font-size: 14px;
  font-weight: 500;
}

#filtro-prov-extremi-container {
  margin-top: 10px;
  background: #eef3f9;
  padding: 10px 12px;
  border-radius: 10px;
}

.mlg-label-small {
  font-size: 14px;
  color: #003366;
  font-weight: 500;
}

@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 18px 14px;
  }

  .filtro-box {
    padding: 10px;
  }

  .filtro-riga-select {
    flex-direction: column;
    align-items: flex-start;
  }

  #filtro-provincia, #filtro-ordinamento {
    width: 100%;
  }
}
</style><style>
/* SEZIONE ANTEPRIMA COMPLETAMENTE RIDISEGNATA PER MOBILE */

/* Contenitore principale */
#anteprima-dati-testuali {
  position: absolute;
  top: calc(100vh - 180px);
  left: 0;
  width: 100%;
  background: #f9fbff;
  z-index: 9999;
  padding: 26px 16px 20px;
  box-shadow: 0 -3px 14px rgba(0,0,0,0.12);
  border-top: 2px solid #b0c4de;
  border-radius: 20px 20px 0 0;
  font-family: "Segoe UI", sans-serif;
}

/* Titolo iniziale */
#anteprima-dati-testuali > div:first-child {
  font-weight: 700;
  font-size: 17px;
  color: #002b55;
  text-align: center;
  margin-bottom: 20px;
  margin-top: -6px;
}

/* Filtro box modernizzati */
.filtro-box {
  background: #eaf2f8;
  padding: 14px 16px;
  border-radius: 12px;
  margin-bottom: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}

.filtro-box label {
  font-weight: 500;
  font-size: 15px;
  color: #1a1a1a;
  display: flex;
  align-items: center;
}

.filtro-box input[type="checkbox"] {
  margin-right: 10px;
  transform: scale(1.1);
}

/* Riorganizzazione selettori */
.filtro-riga-select {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 15px;
  margin-bottom: 14px;
}

.filtro-riga-select label {
  font-weight: 600;
  margin-bottom: 4px;
}

/* Select dropdown */
#filtro-provincia, #filtro-ordinamento, #filtro-provincia-estremi {
  padding: 7px 12px;
  border-radius: 10px;
  background: #e0edff;
  border: 1px solid #aac6f2;
  font-size: 14px;
  font-weight: 500;
  width: 100%;
}

/* Riquadro extra per selettore province estremi */
#filtro-prov-extremi-container {
  margin-top: 12px;
  background: #f3f7fc;
  padding: 12px;
  border-radius: 10px;
}

/* Etichetta "Tabella: dati in tempo reale" */
#filtro-mlg {
  display: none;
}
/* Rimosso ::before duplicato per "Tabella: dati in tempo reale" */
/* .mlg-label-small::before { */
/* content: "Tabella: dati in tempo reale";
  font-size: 15px;
  font-weight: 600;
  color: #003366;
  display: block;
  margin-top: 16px;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

/* Card meteo ottimizzate */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}

#tabella .card .intestazione {
  font-size: 17px;
  font-weight: 700;
  color: #003366;
  margin-bottom: 6px;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 8px 16px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  display: inline-block;
  padding: 5px 8px;
  background: #007bff;
  color: white;
  font-size: 12px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 10px;
}

/* Mobile fix */
@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 20px 12px;
  }

  .filtro-box {
    padding: 12px;
  }

  .filtro-riga-select {
    gap: 8px;
  }

  #tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}
}</style><style>
/* CORREZIONE POSIZIONE MLG + TESTO STATICO "Dati testuali in tempo reale" */
#filtro-mlg {
  margin-top: 16px;
  transform: scale(1.05);
  margin-right: 8px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 14px;
  font-weight: 500;
  color: #003366;
  margin: 12px 0 4px 0;
}

/* Etichetta sostitutiva sopra i filtri */
#label-dati-realtime {
  font-size: 16px;
  font-weight: 600;
  color: #002b55;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  margin-bottom: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  text-align: center;
}
</style><style>
/* FIX larghezza elementi e spostamento */
.filtro-riga-select {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 15px;
  margin-bottom: 14px;
}

.filtro-riga-select label {
  font-weight: 600;
  margin-bottom: 2px;
}

#filtro-provincia,
#filtro-ordinamento,
#filtro-provincia-estremi {
  width: 100%;
  max-width: 280px;
  padding: 7px 12px;
  border-radius: 8px;
  background: #e0edff;
  border: 1px solid #aac6f2;
  font-size: 14px;
  font-weight: 500;
}

/* Etichetta tabella spostata sopra */
#label-dati-realtime {
  font-size: 16px;
  font-weight: 600;
  color: #002b55;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  margin: 10px 0 18px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  text-align: center;
}

/* Checkbox filtro finale */
#filtro-mlg {
  margin-top: 16px;
  transform: scale(1.05);
  margin-right: 8px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 14px;
  font-weight: 500;
  color: #003366;
  margin: 12px 0 8px;
}
</style><style>
#tabella .card {
  background: #ffffff;
  border: 1px solid #bbcfe6;
  border-radius: 16px;
  padding: 22px 20px;
  margin-bottom: 18px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.05);
  font-size: 16px;
  line-height: 1.7;
  transition: transform 0.2s ease;
  width: 100%;
  max-width: 680px;
  margin-left: auto;
  margin-right: auto;
}
#tabella .card:hover {
  transform: scale(1.015);
}
#tabella .card .intestazione {
  font-size: 19px;
  font-weight: 700;
  color: #002a4d;
  margin-bottom: 10px;
}
@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15px;
  }
  #tabella .card .intestazione {
    font-size: 17px;
  }
}</style><style>
/* MIGLIORAMENTO GRAFICO CARDS ORIGINALE */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 22px 20px;
  margin: 20px auto;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 16px;
  line-height: 1.7;
  transition: transform 0.2s ease;
  width: 95%;
  max-width: 840px;
}
#tabella .card:hover {
  transform: scale(1.015);
}
#tabella .card .intestazione {
  font-size: 20px;
  font-weight: 700;
  color: #002a4d;
  margin-bottom: 12px;
}
#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 10px 18px;
  color: #333;
}
#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}
#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}
#tabella .card .badge {
  display: inline-block;
  padding: 5px 10px;
  background: #007bff;
  color: white;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 12px;
}

@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15.5px;
  }
  #tabella .card .intestazione {
    font-size: 18px;
  }
}</style><style>
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 20px;
  margin: 20px auto;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 15.5px;
  line-height: 1.6;
  width: 95%;
  max-width: 100%;
  box-sizing: border-box;
}

#tabella .card .intestazione {
  font-size: 18px;
  font-weight: bold;
  color: #003366;
  margin-bottom: 12px;
}

#tabella .card .dati {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px 14px;
  color: #333;
  width: 100%;
}

#tabella .card .dati span {
  display: flex;
  flex-direction: column;
  font-weight: 500;
  font-size: 14px;
}

#tabella .card .dati .valore {
  font-weight: bold;
  color: #0055aa;
  font-size: 15px;
}

#tabella .card .badge {
  margin-top: 12px;
  background: #007bff;
  color: white;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  display: inline-block;
}

/* Responsive fix per schermi piccoli */
@media (max-width: 480px) {
  #tabella .card {
    padding: 16px 14px;
    font-size: 14.5px;
  }

  #tabella .card .intestazione {
    font-size: 16px;
  }

  #tabella .card .dati span {
    font-size: 13.5px;
  }

  #tabella .card .dati .valore {
    font-size: 14px;
  }
}</style><style>
/* Allinea le card a sinistra e sfrutta meglio lo spazio disponibile */
#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 16px;
  padding: 12px;
}

#tabella .card {
  width: calc(50% - 16px);
  margin: 0;
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 15.5px;
  line-height: 1.6;
  box-sizing: border-box;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.015);
}

#tabella .card .intestazione {
  font-size: 18px;
  font-weight: bold;
  color: #003366;
  margin-bottom: 12px;
}

#tabella .card .dati {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px 14px;
  color: #333;
  width: 100%;
}

#tabella .card .dati span {
  display: flex;
  flex-direction: column;
  font-weight: 500;
  font-size: 14px;
}

#tabella .card .dati .valore {
  font-weight: bold;
  color: #0055aa;
  font-size: 15px;
}

#tabella .card .badge {
  margin-top: 12px;
  background: #007bff;
  color: white;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  display: inline-block;
}

/* Visualizzazione mobile: una sola colonna */
@media (max-width: 600px) {
  #tabella .card {
    width: 100%;
  }
}</style><style>
#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 16px;
  padding: 12px;
}

#tabella .card {
  margin: 0 !important;
  width: calc(50% - 16px);
  box-sizing: border-box;
}

@media (max-width: 600px) {
  #tabella .card {
    width: 100%;
  }
}
</style><style>
#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  display: flex !important;
  flex-wrap: wrap !important;
  justify-content: flex-start !important;
  align-items: flex-start !important;
  padding: 12px !important;
  gap: 16px !important;
}

#tabella .card {
  margin: 0 !important;
  width: calc(50% - 16px) !important;
  box-sizing: border-box !important;
  max-width: none !important;
}

@media (max-width: 600px) {
  #tabella .card {
    width: 100% !important;
  }
}
</style>
<style>
#anteprima-dati-testuali {
  background: #f5f9ff;
  border-top: 2px solid #1a3a9b;
  border-radius: 14px 14px 0 0;
  box-shadow: 0 -1px 4px rgba(0,0,0,0.05);
  font-family: "Segoe UI", sans-serif;
  padding: 16px 12px 10px;
}

#anteprima-dati-testuali > div:first-child {
  font-weight: 700;
  font-size: 15px;
  color: #1a3a9b;
  text-align: center;
  margin-bottom: 12px;
}

#anteprima-dati-testuali label {
  font-size: 13.5px;
  color: #003366;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}

#anteprima-dati-testuali input[type="checkbox"] {
  transform: scale(0.95);
}

.filtro-riga-combinata {
  display: flex;
  flex-direction: column;
  gap: 10px;
  background: #e6efff;
  border: 1px solid #bcd0ee;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}

#filtro-provincia, #filtro-ordinamento {
  background: #ffffff;
  border: 1px solid #aac6f2;
  padding: 6px 8px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  width: 100%;
  color: #002a4d;
}

.filtro-riga-combinata label {
  margin: 0;
}

@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 14px 10px 8px;
  }

  #anteprima-dati-testuali label {
    font-size: 13px;
  }

  #filtro-provincia, #filtro-ordinamento {
    font-size: 12.5px;
  }
}

#anteprima-dati-testuali {
  margin-left: 40px;
}
</style>
<style>
@media (min-width: 600px) {
  body {
    padding-left: 60px !important;
  }
}
</style>
<style>
#tabella .card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #ffffff;
  border: 1px solid #dde3ec;
  border-radius: 10px;
  padding: 12px 18px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  transition: transform 0.2s ease;
  font-size: 15.5px;
  line-height: 1.6;
}

#tabella .card:hover {
  transform: scale(1.015);
}

#tabella .card .intestazione {
  font-weight: 600;
  font-size: 16px;
  color: #222;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 14px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  margin-left: auto;
  background-color: #007bff;
  border: none;
  padding: 6px 12px;
  color: white;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
</style>
<style>
/* Overlay watermark visibile sopra tutto ma non cliccabile */
.watermark-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  pointer-events: none;
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='28'><text x='0' y='20' font-size='12' fill='rgba(0,0,0,0.05)' font-family='Arial'>Meteo Lo Gullo Meteo Lo Gullo Meteo Lo Gullo</text></svg>");
  background-repeat: repeat;
  background-size: 180px 28px;
  mix-blend-mode: multiply;
}
</style>
<style>
/* Aspetto coerente con le card sottostanti */
#anteprima-dati-testuali {
  background: #ffffff;
  border-top: 2px solid #ccddee;
  border-radius: 16px 16px 0 0;
  box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.05);
  padding: 20px 16px;
  font-family: "Segoe UI", sans-serif;
  transition: background 0.3s ease;
}

/* Leggero margine negativo solo per unione visiva */
#tabella {
  margin-top: -6px;
  padding-top: 0;
}

/* Card coerenti come già impostato, mantenute flessibili */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}
</style>
<!-- Fix: uniforma larghezza di tutte le card nella tabella -->
<style id="fix-card-dimensions">
  /* Forza ogni card ad occupare metà riga (con il gap già presente) */
  #tabella .card{
    flex: 0 0 calc(50% - 16px) !important;   /* base fissa e nessun ridimensionamento */
    width: calc(50% - 16px) !important;       /* stesso valore di fallback */
    max-width: none !important;               /* evita max‑width più piccole */
    margin: 0 !important;                     /* elimina centraggi automatici */
  }
  /* Mobile: una colonna piena */
  @media (max-width: 600px){
    #tabella .card{
      flex: 0 0 100% !important;
      width: 100% !important;
    }
  }
</style>
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet"/><script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script></head>
<body>
<div id="radar-controls" style="position: fixed; top: 120px; right: 10px; z-index: 2147483647; background: white; border-radius: 8px; padding: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.4); display: none; font-family: sans-serif;">
<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
<button onclick="playRadar()" title="Avvia animazione">▶️</button>
<button onclick="stopRadar()" title="Ferma animazione">⏹️</button>
<input id="radarSlider" max="0" min="0" oninput="sliderChangeRadar(this.value)" step="1" style="width: 140px;" type="range" value="0"/>
</div>
<div id="radar-time-label" style="font-size: 13px; color: #111; text-align: center;"></div>
</div>
<div id="radar-time-label" style="font-size: 13px; color: #111; text-align: center;"></div>
<!-- Sidebar Meteo -->
<div id="sidebar">
<button class="sidebar-btn" onclick="visualizzaAttuali()" style="background-color: #cccccc; color: black;" title="Temp attuale">T°C</button>
<button class="sidebar-btn" onclick="visualizzaEstremi('max')" style="background-color: #ff4d4d; color: white;" title="Temp max">MAX</button>
<button class="sidebar-btn" onclick="visualizzaEstremi('min')" style="background-color: #3399ff; color: white;" title="Temp min">MIN</button>
<button class="sidebar-btn" onclick="visualizzaUmidita()" style="background-color: #66ccff; color: white;" title="Umidità">UR%</button>
<button class="sidebar-btn" onclick="visualizzaRaffiche()" style="background-color: #ff9933; color: white;" title="Raffiche">RAF</button>
<button class="sidebar-btn" onclick="visualizzaPioggia()" style="background-color: #3399ff; color: white;" title="Pioggia">MM</button>
<button class="sidebar-btn" onclick="filtraSoloMLG()" style="background-color: #222; color: white;" title="Solo MLG">MLG</button>
<button class="sidebar-btn" onclick="toggleRadar()" style="background-color: #444; color: white;" title="Radar/Satellite">RAD</button>
<button class="sidebar-btn" onclick="location.reload();" style="background-color:#009688;color:white;" title="Ricarica pagina">REF</button>
</div>
<!-- Striscia con la scritta Meteo Lo Gullo -->
<div id="banner">
  - Meteo Lo Gullo
</div>
<div id="radar-controls-container">
<div id="radar-time-label" style="margin-top: 4px; font-size: 12px; color: #333; text-align: center;"></div>
</div>
<div id="map" style="">
</div>
<button onclick="playRadar()" style="margin-right: 5px;">▶️</button>
<button onclick="stopRadar()" style="margin-right: 5px;">⏹️</button>
<input id="radarSlider" max="0" min="0" oninput="sliderChangeRadar(this.value)" step="1" type="range" value="0"/>
<div id="mlg-label" style="
  position: fixed;
  top: 65px;
  right: 10px;
  background-color: #007bff;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: bold;
  z-index: 1002;
  display: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 14px;
">
  FILTRO MLG ATTIVO
</div>
<section id="anteprima-dati-testuali" style="margin: 0; padding: 20px 16px; width: 100%; background: white; z-index: 9999; box-shadow: 0 -2px 8px rgba(0,0,0,0.2); border-radius: 20px 20px 0 0;">
<div style="text-align: center; font-weight: bold; font-size: 16px; color: #003366; margin-bottom: 14px;">
    Scorri per i dati testuali ↓
  </div>
<div style="background: #f0f8ff; padding: 12px; border-radius: 12px; margin-bottom: 12px;">
<label style="display: flex; align-items: center; gap: 10px; font-size: 15px;">
<input id="riepilogo-dettagliato" onchange="aggiornaTabella()" type="checkbox"/>
      Visualizza riepilogo meteo testuale
    </label>
</div>
<div style="background: #f0f8ff; padding: 12px; border-radius: 12px; margin-bottom: 18px;">
<label style="display: flex; align-items: center; gap: 10px; font-size: 15px;">
<input id="toggle-estremi-lista" onchange="toggleEstremiLista()" type="checkbox"/>
      Mostra estremi giornalieri
    </label>
</div>
<div class="filtro-riga-combinata">
<label for="filtro-provincia">Filtra per provincia:</label>
<select id="filtro-provincia" onchange="aggiornaTabella()">
<option value="">Tutte</option>
<option value="CS">Cosenza</option>
<option value="CZ">Catanzaro</option>
<option value="KR">Crotone</option>
<option value="VV">Vibo Valentia</option>
<option value="RC">Reggio Calabria</option>
</select>
<label for="filtro-ordinamento">Ordina per:</label>
<select id="filtro-ordinamento" onchange="aggiornaTabella()">
<option value="caldo">Stazione più calda (live)</option>
<option value="freddo">Stazione più fredda (live)</option>
<option value="raffica">Raffiche</option>
<option value="pioggia">Pioggia</option>
    <option value="tmax">T. max più alta</option>
    <option value="tmin">T. min più bassa</option>
</select>
<label class="mlg-label-small">
<input id="filtro-mlg" onchange="aggiornaTabella()" type="checkbox"/>
    Mostra solo stazioni MLG
  </label>
</div>
</section>
<div style="height: 260px;"></div>
<div id="tabella"></div>
<div id="popup-grafico">
<button class="close-btn" onclick="chiudiGrafico()">Chiudi</button>
<iframe id="grafico-frame" src=""></iframe>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js">













function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}

</script>
<script src="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.js">













function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}

</script>
<!-- old webcam script removed -->
<div id="slide-banner" onclick="apriInfoMappa()" style="position: fixed; right: -300px; background: #1a3a9b; color: white; padding: 10px 20px; border-radius: 4px 0 0 4px; font-size: 14px; font-weight: 500; cursor: pointer; z-index: 9999; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: right 0.5s ease; ; top: 65px">Come leggere questa mappa?<span onclick="document.getElementById('slide-banner').style.display = 'none'; event.stopPropagation();" style="margin-left: 10px; font-weight: bold;"> ✕</span></div><script>
window.addEventListener("load", function() {
  setTimeout(function() {
    document.getElementById("slide-banner").classList.add("show");
  }, 800);
});
function apriInfoMappa() {
  document.getElementById("info-mappa").style.display = "flex";
}
function chiudiInfoMappa() {
  document.getElementById("info-mappa").style.display = "none";
}
</script><div id="info-mappa" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center; font-family:Arial,sans-serif;">
<div style="background:#fff; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;
              padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:justify;">
<h2 style="margin-top:0; color:#1a3a9b;">Come leggere questa mappa?</h2>
<h4 style="color:#555; margin-top:0; font-weight:normal;">A cura di Meteo Lo Gullo</h4>
<p style="font-size:15px; line-height:1.7; color:#333;">
        Questa piattaforma rappresenta un nuovo ramo operativo del progetto MLG, pensato per offrire una visione quanto più completa e dettagliata delle condizioni meteorologiche sull’intero territorio calabrese. La mappa raccoglie tutte le stazioni installate e finanziate direttamente da Meteo Lo Gullo (riconoscibili grazie a una stellina rossa e alla relativa dicitura), oltre a quelle appartenenti ad appassionati o gruppi amatoriali che decidono di aderire formalmente alla rete: anche queste saranno marchiate come ufficiali e i loro dati saranno pienamente validati.
        <br/><br/>
        Accanto a queste stazioni ufficiali, la mappa include una fitta rete di postazioni fisiche non direttamente gestite da MLG, le cui misurazioni vengono elaborate a partire da più centraline presenti nella stessa area geografica. Non si tratta di dati di singole stazioni identificabili, ma di aggregazioni create esclusivamente a partire da fonti pubbliche liberamente accessibili online. Nessun dato è stato prelevato da enti pubblici né da privati senza consenso: il sistema aggrega in modo trasparente ciò che già circola in rete, per offrire un quadro di riferimento il più ampio possibile.
        <br/><br/>
        Questa è la prima versione pubblica della mappa, già oggi la rete meteorologica più ampia esistente sul territorio calabrese, ma è in continua evoluzione. L’obiettivo è quello di sostituire progressivamente le postazioni riassuntive con stazioni ufficiali installate da MLG o da collaboratori affidabili. Chiunque possieda una stazione meteo in una zona attualmente coperta da dati riassuntivi e desideri offrire un dato certificato, può contattarci per entrare nella rete.
        </p>
<div style="text-align:right; margin-top:15px;">
<button onclick="chiudiInfoMappa()" style="padding:8px 16px; background:#c00; color:white; border:none; border-radius:4px; cursor:pointer;">Chiudi</button>
</div>
</div>
</div>
<!-- Firebase Script per min/max reali -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDasXnVu7uIEjpwtQ-XbVilREGmAZSBjVE",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.appspot.com",
    messagingSenderId: "469441159034",
    appId: "1:469441159034:web:b687adef4a7a742499c0c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function caricaEstremiDaFirebase() {
    const oggi = new Date();
    oggi.setHours(0, 0, 0, 0);
    const domani = new Date(oggi);
    domani.setDate(oggi.getDate() + 1);

    const q = query(
      collection(db, "osservazioni"),
      where("timestamp", ">=", Timestamp.fromDate(oggi)),
      where("timestamp", "<", Timestamp.fromDate(domani))
    );

    
    const snapshot = await getDocs(q);
    const extremi = {};

    snapshot.forEach(doc => {
      const d = doc.data();
      const id = d.stationId;
      const t = d.temperatura;

      if (!id || t == null) return;

      if (!extremi[id]) {
        extremi[id] = { min: t, max: t };
      } else {
        if (t < extremi[id].min) extremi[id].min = t;
        if (t > extremi[id].max) extremi[id].max = t;
      }
    });

    window.extremiGiornalieri = extremi;

    if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
    if (typeof aggiornaPopup === "function") aggiornaPopup(); // <-- nuova funzione se serve

    if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
  }

  window.addEventListener("load", caricaEstremiDaFirebase);
</script>
<!-- Firebase App (the core Firebase SDK) -->


<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBlNQX8Y-REPLACE-WITH-YOURS",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.appspot.com",
    messagingSenderId: "108767339113415539553",
    appId: "1:108767339113415539553:web:dummyappid"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const map = L.map('map').setView([38.9, 16.3], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  db.collection("osservazioni").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const lat = data.latitudine;
      const lon = data.longitudine;
      if (lat && lon) {
        const popupContent = `<div class="popup-wrapper" data-station-id="${data.stationId}">\n
          <b>Stazione:</b> ${data.stationId || "N/A"}<br>
          <b>Temperatura:</b> ${data.temperatura || "-"}°C<br>
          <span class="popup-data temp-max"><b>Massima:</b> ${data.Massima || "-"}°C</span><br>
          <span class="popup-data temp-min"><b>Minima:</b> ${data.Minima || "-"}°C</span><br>
          <b>Umidità:</b> ${data.umidita || "-"}%<br>
          <b>Pioggia:</b> ${data.pioggia || "-"} mm<br>
          <b>Raffica:</b> ${data.raffica || "-"} km/h<br>
          <b>Ora:</b> ${new Date(data.timestamp?.seconds * 1000).toLocaleString() || "-"}
        </div>`;
        L.marker([lat, lon]).addTo(map).bindPopup(popupContent);
      }
    });
  });
</script>
<!-- Firebase compat + Calcolo estremo client-side -->


<script>
const firebaseConfig = {
  apiKey: "AIzaSyBlNQX8Y-REPLACE-WITH-YOURS",
  authDomain: "meteo-estremami.firebaseapp.com",
  projectId: "meteo-estremami"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

window.extremiGiornalieri = {};

function aggiornaTabellaConEstremi() {
  const righe = document.querySelectorAll("table tbody tr");
  righe.forEach(row => {
    const stationId = row.getAttribute("data-stationid");
    const dati = window.extremiGiornalieri[stationId];
    if (!dati) return;

    // Aggiunta colonne se mancanti
    if (!row.querySelector(".col-max")) {
      const maxCell = document.createElement("td");
      maxCell.className = "col-max";
      row.appendChild(maxCell);
    }
    if (!row.querySelector(".col-min")) {
      const minCell = document.createElement("td");
      minCell.className = "col-min";
      row.appendChild(minCell);
    }

    row.querySelector(".col-max").innerText = dati.max.toFixed(1);
    row.querySelector(".col-min").innerText = dati.min.toFixed(1);
  });

  const intestazioni = document.querySelectorAll("table thead tr th");
  const headerRow = document.querySelector("table thead tr");
  if (![...intestazioni].some(th => th.innerText === "Tmax")) {
    const thMax = document.createElement("th");
    thMax.innerText = "Tmax";
    headerRow.appendChild(thMax);
  }
  if (![...intestazioni].some(th => th.innerText === "Tmin")) {
    const thMin = document.createElement("th");
    thMin.innerText = "Tmin";
    headerRow.appendChild(thMin);
  }
}

function mostraEstremiNeiPopup() {
  const popupLayer = document.querySelectorAll(".leaflet-popup-content");
  popupLayer.forEach(popup => {
    const match = popup.innerHTML.match(/Stazione:\s(.+?)<br>/);
    if (!match) return;
    const stationId = match[1];
    const dati = window.extremiGiornalieri[stationId];
    if (!dati) return;

    if (!popup.innerHTML.includes("Massima:")) {
      popup.innerHTML += `<b>Massima:</b> ${dati.max} °C<br><b>Minima:</b> ${dati.min} °C<br></div>`;
    }
  });
}

function caricaEstremiDaFirebase() {
  const oggi = new Date().toISOString().slice(0, 25);
  const perStazione = {};

  db.collection("osservazioni").get().then((snapshot) => {
    snapshot.forEach((doc) => {
      const d = doc.data();
      if (!d.timestamp || !d.temperatura || !d.stationId) return;
      const ts = d.timestamp.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp);
      const giorno = ts.toISOString().slice(0, 25);
      if (giorno !== oggi) return;

      if (!perStazione[d.stationId]) {
        perStazione[d.stationId] = { max: d.temperatura, min: d.temperatura };
      } else {
        perStazione[d.stationId].max = Math.max(perStazione[d.stationId].max, d.temperatura);
        perStazione[d.stationId].min = Math.min(perStazione[d.stationId].min, d.temperatura);
      }
    });

    window.extremiGiornalieri = perStazione;
    aggiornaTabellaConEstremi();
    setTimeout(mostraEstremiNeiPopup, 1000);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  caricaEstremiDaFirebase();
});
</script>
<script>// Ordinamento Tmax e Tmin sulla tabella
document.addEventListener("DOMContentLoaded", () => {
  const header = document.querySelector("table thead tr");
  if (!header) return;

  function ordinaPer(colonna, crescente = true) {
    const rows = Array.from(document.querySelectorAll("table tbody tr"));
    rows.sort((a, b) => {
      const valA = parseFloat(a.querySelector(colonna)?.innerText || 0);
      const valB = parseFloat(b.querySelector(colonna)?.innerText || 0);
      return crescente ? valB - valA : valA - valB;
    });
    const tbody = document.querySelector("table tbody");
    rows.forEach(row => tbody.appendChild(row));
  }

  // Aggiunta pulsanti ordinamento se mancano
  const ths = header.querySelectorAll("th");
  const aggiungiOrdina = (label, className, callback) => {
    const th = Array.from(ths).find(th => th.innerText === label);
    if (!th || th.querySelector("button")) return;
    const btn = document.createElement("button");
    btn.innerText = "↕";
    btn.style.marginLeft = "5px";
    btn.onclick = callback;
    th.appendChild(btn);
  };

  aggiungiOrdina("Tmax", ".col-max", () => ordinaPer(".col-max", true));
  aggiungiOrdina("Tmin", ".col-min", () => ordinaPer(".col-min", false));
});




});



 else if (isFirestoreStation(staz.stationId)) {
    const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
    try {
      const res = await fetch(url);
      const json = await res.json();
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;

      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });

      callback({
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      });
    } catch (e) {
      console.error("Firestore error", e);
      callback(null);
    }
  } else {
    callback(null);
  }
}

window.extremiGiornalieri = {};

function aggiornaEstremiTutteLeStazioni() {
  stazioni.forEach((s) => {
    caricaEstremi(s, (extremes) => {
      if (extremes) {
        window.extremiGiornalieri[s.stationId] = extremes;
      }
    });
  });
}

document.addEventListener("DOMContentLoaded", function () {
  setTimeout(aggiornaEstremiTutteLeStazioni, 3000);
});

function caricaEstremi(staz, callback) {
  const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
  fetch(url)
    .then(res => res.json())
    .then(json => {
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;
      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });
      const extremes = {
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      };
      callback(extremes);
    })
    .catch(err => {
      console.error("Errore Firestore:", err);
      callback(null);
    });
}
</script>
<script>
document.querySelectorAll('.sidebar-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('attivo'));
    btn.classList.add('attivo');
  });
});
</script><script>



function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.pioggia !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const mm = parseFloat(d.pioggia) || 0;
        const colore = getColorPioggia(mm);

        // testo sempre leggibile
        const textColor = getTextColorForBackground(colore);
        const shadow = textColor === 'white'
          ? '0 0 3px rgba(0,0,0,0.7)'
          : '0 0 3px rgba(255,255,255,0.7)';

        el.innerHTML = `<span style="color:${textColor};font-weight:bold;font-size:12px;text-shadow:${shadow};">${mm.toFixed(1)}</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.borderRadius = '50%';
      }
    }
  });
}

  });
}




function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.pioggia !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const mm = parseFloat(d.pioggia) || 0;
        const colore = getColorPioggia(mm);

        // testo sempre leggibile
        const textColor = getTextColorForBackground(colore);
        const shadow = textColor === 'white'
          ? '0 0 3px rgba(0,0,0,0.7)'
          : '0 0 3px rgba(255,255,255,0.7)';

        el.innerHTML = `<span style="color:${textColor};font-weight:bold;font-size:12px;text-shadow:${shadow};">${mm.toFixed(1)}</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.borderRadius = '50%';
      }
    }
  });
}

  });
}

</script>
<script>
  window.addEventListener("load", function () {
    const anteprima = document.getElementById("anteprima-dati-testuali");
    const tabella = document.getElementById("tabella");
    if (anteprima && tabella) {
      const altezza = anteprima.offsetHeight;
      tabella.style.paddingBottom = (altezza + 20) + "px";
    }
  });
</script>
<script>
window.addEventListener("load", () => {
  if (!window.markersById) window.markersById = {};
  if (!window.datiTabella) window.datiTabella = Array.isArray(stazioni) ? stazioni : [];

  // Se ci sono marker già presenti, assicuriamoci che siano visibili
  setTimeout(() => {
    Object.values(markersById).forEach((marker) => {
      const el = marker.getElement && marker.getElement();
      if (el) el.style.display = "flex";
    });
  }, 1000);
});
</script>
<script>
let filtroMLGAttivo = false;

function filtraSoloMLG() {
  if (typeof datiTabella === 'undefined' || typeof markersById === 'undefined') return;
  filtroMLGAttivo = !filtroMLGAttivo;

  const stazioniMLG = ['Amantea Spiaggia', 'Cosenza - Campagnano', 'Cosenza - Vaglio Lise', 'Mendicino - Tivolille Pasquali', 'Casali del Manco - Morelli Soprana', 'Montescuro - Celico'];

  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker && marker.getElement) {
      const el = marker.getElement();
      if (el) {
        if (!filtroMLGAttivo || stazioniMLG.includes(d.nome)) {
          el.style.display = "flex";
        } else {
          el.style.display = "none";
        }
      }
    }
  });

  const btn = document.querySelector(".sidebar-btn[onclick='filtraSoloMLG()']");
  if (btn) {
    btn.classList.toggle("attivo", filtroMLGAttivo);

  const mlgLabel = document.getElementById("mlg-label");
  if (mlgLabel) {
    mlgLabel.style.display = filtroMLGAttivo ? "block" : "none";
  }

  }
}
</script>
<div class="watermark-overlay"></div>
<script>
let ultimaPosizioneScroll = 0;
let sidebar = document.getElementById('sidebar');

window.addEventListener('scroll', function () {
  const scrollAttuale = window.pageYOffset || document.documentElement.scrollTop;
  const differenza = scrollAttuale - ultimaPosizioneScroll;

  if (differenza > 10) {
    sidebar.classList.add('sidebar-nascosta');
  } else if (differenza < -10 && scrollAttuale < 300) {
    sidebar.classList.remove('sidebar-nascosta');
  }

  ultimaPosizioneScroll = scrollAttuale;
});
</script>
<script>
function forzaEstremiNelPopup(popupEl, stationId) {
  if (!popupEl || !stationId) {
    console.warn("Popup o stationId mancante");
    return;
  }

  const card = Array.from(document.querySelectorAll("#tabella .card")).find(card =>
    card.dataset.stationId === stationId
  );
  if (!card) {
    console.warn("Card non trovata per stationId:", stationId);
    return;
  }

  const cardText = card.textContent;
  console.log("Testo completo della card:", cardText);

  const matchMin = cardText.match(/▼\s*([\d.,]+)°C/);
  const matchMax = cardText.match(/▲\s*([\d.,]+)°C/);

  const valoreMin = matchMin ? matchMin[1].replace(",", ".") : null;
  const valoreMax = matchMax ? matchMax[1].replace(",", ".") : null;

  console.log("Valori trovati → Min:", valoreMin, "| Max:", valoreMax);

  const rigaMin = popupEl.querySelector(".popup-data.temp-min");
  const rigaMax = popupEl.querySelector(".popup-data.temp-max");

  if (valoreMin && rigaMin && (!rigaMin.textContent.includes("°") || rigaMin.textContent.includes("--"))) {
    rigaMin.innerHTML = `<b>Minima:</b> <span class="bold">${valoreMin}°C</span>`;
    console.log("Minima aggiornata nel popup:", valoreMin);
  }

  if (valoreMax && rigaMax && (!rigaMax.textContent.includes("°") || rigaMax.textContent.includes("--"))) {
    rigaMax.innerHTML = `<b>Massima:</b> <span class="bold">${valoreMax}°C</span>`;
    console.log("Massima aggiornata nel popup:", valoreMax);
  }
}

[9000, 12000, 15000].forEach(ms => {
  setTimeout(() => {
    document.querySelectorAll(".popup-wrapper").forEach(popup => {
      const stationId = popup.dataset.stationId;
      console.log("Controllo popup per stationId:", stationId);
      if (stationId) {
        forzaEstremiNelPopup(popup, stationId);
      }
    });
  }, ms);
});
</script>
<script>
function forzaEstremiNelPopup(popupEl, stationId) {
  if (!popupEl || !stationId) {
    console.warn("Popup o stationId mancante");
    return;
  }

  const card = Array.from(document.querySelectorAll("#tabella .card")).find(card =>
    card.dataset.stationId === stationId
  );
  if (!card) {
    console.warn("Card non trovata per stationId:", stationId);
    return;
  }

  const cardText = card.textContent;
  console.log("Testo completo della card:", cardText);

  const matchMin = cardText.match(/▼\s*([\d.,]+)°C/);
  const matchMax = cardText.match(/▲\s*([\d.,]+)°C/);

  const valoreMin = matchMin ? matchMin[1].replace(",", ".") : null;
  const valoreMax = matchMax ? matchMax[1].replace(",", ".") : null;

  console.log("Valori trovati → Min:", valoreMin, "| Max:", valoreMax);

  const rigaMin = popupEl.querySelector(".popup-data.temp-min");
  const rigaMax = popupEl.querySelector(".popup-data.temp-max");

  if (valoreMin && rigaMin && (!rigaMin.textContent.includes("°") || rigaMin.textContent.includes("--"))) {
    rigaMin.innerHTML = `<b>Minima:</b> <span class="bold">${valoreMin}°C</span>`;
    console.log("Minima aggiornata nel popup:", valoreMin);
  }

  if (valoreMax && rigaMax && (!rigaMax.textContent.includes("°") || rigaMax.textContent.includes("--"))) {
    rigaMax.innerHTML = `<b>Massima:</b> <span class="bold">${valoreMax}°C</span>`;
    console.log("Massima aggiornata nel popup:", valoreMax);
  }
}

[9000, 12000, 15000].forEach(ms => {
  setTimeout(() => {
    document.querySelectorAll(".leaflet-popup").forEach(popup => {
      const wrapper = popup.querySelector(".popup-wrapper");
      if (!wrapper) return;
      const stationId = wrapper.dataset.stationId;
      console.log("Controllo popup per stationId:", stationId);
      if (stationId) {
        forzaEstremiNelPopup(wrapper, stationId);
      }
    });
  }, ms);
});
</script>
<script>
function trovaEstremiDaCard(nomeStazione) {
  const cards = document.querySelectorAll(".card");
  for (let card of cards) {
    if (card.textContent.includes(nomeStazione)) {
      const testo = card.textContent;
      const matchMin = testo.match(/\u25BC\s*(-?\d+(\.\d+)?)°C/);
      const matchMax = testo.match(/\u25B2\s*(-?\d+(\.\d+)?)°C/);
      if (matchMin && matchMax) {
        return {
          min: matchMin[1],
          max: matchMax[1]
        };
      }
    }
  }
  return null;
}

function forzaEstremiPopupTestuale() {
  const popupWrappers = document.querySelectorAll(".leaflet-popup-content");
  popupWrappers.forEach(wrapper => {
    const titolo = wrapper.querySelector("strong")?.textContent?.trim();
    const campo = [...wrapper.querySelectorAll("div")]
      .find(el => el.textContent.includes("Min:") || el.textContent.includes("Minimo") || el.textContent.includes("Min --"));

    if (!campo || !titolo || campo.textContent.includes("°C")) return;

    const estremi = trovaEstremiDaCard(titolo);
    if (estremi) {
      campo.innerHTML = `<span class="bold">Min:</span> ${estremi.min}°C / <span class="bold">Max:</span> ${estremi.max}°C`;
    }
  });
}

setTimeout(() => {
  forzaEstremiPopupTestuale();
  let tentativi = 0;
  const retry = setInterval(() => {
    forzaEstremiPopupTestuale();
    tentativi++;
    if (tentativi >= 10) clearInterval(retry);
  }, 1000);
}, 4000);
</script>
<script>
function aggiornaPopupConEstremiFinale() {
  if (!window.extremiGiornalieri || !window.markersById || !window.datiTabella) return;

  datiTabella.forEach(staz => {
    const marker = markersById[staz.stationId];
    if (!marker) return;

    const temp = staz.temp ?? "--";
    const um = staz.umidita ?? "-";
    const condizione = staz.condizione ?? "-";
    const vento = staz.vento ?? "-";
    const raffica = staz.raffica ?? "-";
    const pioggia = staz.pioggia ?? 0;
    const orario = staz.orario ?? "-";
    const webcam = staz.webcam ?? "";
    const linkStazione = staz.linkStazione ?? "#";

    const estremi = window.extremiGiornalieri[staz.stationId] || {};
    const tMin = estremi.min != null ? estremi.min + "°C" : "--";
    const tMax = estremi.max != null ? estremi.max + "°C" : "--";

    const popup = `
      <div class="popup-title">${staz.nome}</div>
      <div class="popup-sub">${[staz.provincia, staz.regione, staz.quota ? `${staz.quota} m` : null, staz.area].filter(v => v && v !== "undefined").join(" • ")}</div>
      <div class="popup-data"><span class="bold">Temp:</span> ${temp}°C</div>
      <div class="popup-data"><span class="bold">Umidità:</span> ${um}%</div>
      <div class="popup-data"><span class="bold">Cond. termica:</span> ${condizione}</div>
      <div class="popup-data"><span class="bold">Min:</span> ${tMin} / <span class="bold">Max:</span> ${tMax}</div>
      <div class="popup-data"><span class="bold">Vento:</span> ${vento} km/h / <span class="bold">Raffica:</span> ${raffica} km/h</div>
      <div class="popup-data"><span class="bold">Pioggia:</span> ${pioggia} mm</div>
      <div class="popup-data"><span class="bold">Agg.:</span> ${orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
      <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
      <a class="btn" href="${linkStazione}" target="_blank">Pagina della stazione</a>
      ${webcam ? `<img src="${webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
    `;

    marker.bindPopup(popup);
  });
}

setTimeout(() => {
  aggiornaPopupConEstremiFinale();
}, 4000);
</script>
<script>
let radarLayer = null;
let radarAttivo = false;

async ${path}/256/{z}/{x}/{y}/2/1_1.png`;

      radarLayer = L.tileLayer(tileUrl, {
        attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>',
        opacity: 0.6,
        zIndex: 1000
      });
    } catch (error) {
      console.error('Errore nel caricamento del layer radar:', error);
      return;
    }
  }

  if (!radarAttivo) {
    radarLayer.addTo(map);
  } else {
    map.removeLayer(radarLayer);
  }
  radarAttivo = !radarAttivo;
}
</script>
<script>
let radarLayers = [];
let radarTimes = [];
let radarIndex = 0;
let radarAnimationInterval = null;
let radarPlaying = false;

async ${path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );
    } catch (error) {
      console.error('Errore nel caricamento dei frame radar:', error);
      return;
    }
  }

  if (!radarPlaying) {
    radarPlaying = true;
    radarIndex = 0;
    radarLayers[radarIndex].addTo(map);
    radarAnimationInterval = setInterval(() => {
      map.removeLayer(radarLayers[radarIndex]);
      radarIndex = (radarIndex + 1) % radarLayers.length;
      radarLayers[radarIndex].addTo(map);
    }, 700);
  } else {
    clearInterval(radarAnimationInterval);
    radarLayers.forEach(layer => map.removeLayer(layer));
    radarPlaying = false;
  }
}
</script>
<script>
let radarLayers = [];
let radarTimes = [];
let radarIndex = 0;
let radarAnimationInterval = null;
let radarPlaying = false;

async ${path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );
      document.getElementById("radarSlider").max = radarLayers.length - 1;
    } catch (error) {
      console.error('Errore nel caricamento dei frame radar:', error);
      return;
    }
  }

  if (!radarPlaying && controls.style.display === "none") {
    controls.style.display = "block";
    radarIndex = 0;
    radarLayers[radarIndex].addTo(map);
    document.getElementById("radarSlider").value = radarIndex;
  } else {
    stopRadar();
    controls.style.display = "none";
  }
}

function playRadar() {
  if (radarAnimationInterval) return;
  radarAnimationInterval = setInterval(() => {
    radarLayers[radarIndex].remove();
    radarIndex = (radarIndex + 1) % radarLayers.length;
    radarLayers[radarIndex].addTo(map);
    document.getElementById("radarSlider").value = radarIndex;
  }, 700);
  radarPlaying = true;
}

function stopRadar() {
  if (radarAnimationInterval) {
    clearInterval(radarAnimationInterval);
    radarAnimationInterval = null;
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarPlaying = false;
}

function sliderChangeRadar(value) {
  if (radarPlaying) {
    stopRadar();
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarIndex = parseInt(value);
  radarLayers[radarIndex].addTo(map);
}
</script>
<script>
let radarLayers = [];
let radarTimes = [];
let radarIndex = 0;
let radarAnimationInterval = null;
let radarPlaying = false;

async )
      }));
      radarLayers = radarTimes.map(f =>
        L.tileLayer(`${host}${f.path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );
      document.getElementById("radarSlider").max = radarLayers.length - 1;
    } catch (error) {
      console.error('Errore nel caricamento dei frame radar:', error);
      return;
    }
  }

  if (!radarPlaying && controls.style.display === "none") {
    controls.style.display = "block";
    radarIndex = 0;
    radarLayers[radarIndex].addTo(map);
    updateRadarTimeLabel(radarIndex);
    document.getElementById("radarSlider").value = radarIndex;
  } else {
    stopRadar();
    controls.style.display = "none";
  }
}

function playRadar() {
  if (radarAnimationInterval) return;
  radarAnimationInterval = setInterval(() => {
    radarLayers[radarIndex].remove();
    radarIndex = (radarIndex + 1) % radarLayers.length;
    radarLayers[radarIndex].addTo(map);
    document.getElementById("radarSlider").value = radarIndex;
    updateRadarTimeLabel(radarIndex);
  }, 700);
  radarPlaying = true;
}

function stopRadar() {
  if (radarAnimationInterval) {
    clearInterval(radarAnimationInterval);
    radarAnimationInterval = null;
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarPlaying = false;
}

function sliderChangeRadar(value) {
  if (radarPlaying) {
    stopRadar();
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarIndex = parseInt(value);
  radarLayers[radarIndex].addTo(map);
  updateRadarTimeLabel(radarIndex);
}

function updateRadarTimeLabel(index) {
  const label = document.getElementById("radar-time-label");
  if (label && radarTimes[index]) {
    label.textContent = `Orario radar: ${radarTimes[index].time}`;
  }
}
</script>
<script>
let radarLayer = null;
let radarTimes = [];
let radarLayers = [];
let radarIndex = 0;
let radarTimer = null;

async function toggleRadar() {
  const radarControls = document.getElementById("radar-controls");

  if (!radarLayer) {
    try {
      const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
      const data = await res.json();
      const host = data.host;

      radarTimes = data.radar.past.map(f => ({
        path: f.path,
        time: new Date(f.time * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      }));

      radarLayers = radarTimes.map(f =>
        L.tileLayer(`${host}${f.path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );

      document.getElementById("radarSlider").max = radarLayers.length - 1;

    } catch (error) {
      console.error("Errore nel caricamento del radar:", error);
      return;
    }
  }

  radarControls.style.display = radarControls.style.display === "none" ? "block" : "none";

  if (radarControls.style.display === "block") {
    if (radarLayers[radarIndex]) radarLayers[radarIndex].addTo(map);
    sliderChangeRadar(radarIndex);
  } else {
    if (radarLayers[radarIndex]) radarLayers[radarIndex].remove();
    stopRadar();
  }
}

function sliderChangeRadar(index) {
  radarIndex = parseInt(index);
  radarLayers.forEach(layer => layer.remove());
  radarLayers[radarIndex].addTo(map);
  document.getElementById("radar-time-label").textContent = radarTimes[radarIndex].time;
}

function playRadar() {
  stopRadar();
  radarTimer = setInterval(() => {
    radarIndex = (radarIndex + 1) % radarLayers.length;
    document.getElementById("radarSlider").value = radarIndex;
    sliderChangeRadar(radarIndex);
  }, 800);
}

function stopRadar() {
  if (radarTimer) clearInterval(radarTimer);
  radarTimer = null;
}
</script>
<script>
async function caricaDatiOpenMeteo() {
  const oggi = new Date().toISOString().split('T')[0];
  for (const stazione of stazioni.filter(s => s.openMeteo)) {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${stazione.lat}&longitude=${stazione.lon}&daily=precipitation_sum&timezone=auto&start_date=${oggi}&end_date=${oggi}`;
      const res = await fetch(url);
      const data = await res.json();
      console.log("Dati OpenMeteo per", stazione.stationId, data);
      const entry = datiTabella.find(e => e.stationId === stazione.stationId);
      if (entry) {
        entry.pioggia = data.daily.precipitation_sum[0];
      }
    } catch (e) {
      console.error("Errore nel fetch OpenMeteo per", stazione.stationId, e);
    }
  }
}
</script><script>

window.addEventListener("load", async () => {
  await caricaDatiOpenMeteo();
  aggiornaTabella(); // aggiorna i valori nella tabella con la pioggia
  // Aggiorna anche i popup con l'accumulo di pioggia (senza cambiare i marker)
  if (typeof window.aggiornaPopupConEstremiFinale === "function") {
    window.aggiornaPopupConEstremiFinale();
  }
});
</script>
<!-- Pioggia FIX 2025-05-22 -->
<script>
// Sovrascrivo la funzione globale usata dal pulsante "MM"
(function() {

function visualizzaPioggia () {
  // datiTabella, markersById e getColorPioggia sono già globali
  if (typeof datiTabella === 'undefined' || typeof markersById === 'undefined') {
    console.error("PioggiaFix: variabili globali mancanti");
    return;
  }

  datiTabella.forEach(function (d) {
    const marker = markersById[d.stationId];
    if (!marker) return;

    // forza numero
    const mmFloat = parseFloat(d.pioggia);
    const mm = Number.isFinite(mmFloat) ? mmFloat : 0;

    // colore – se esiste la tua funzione nativa, usala, altrimenti fallback
    let colore;
    if (typeof getColorPioggia === "function") {
      colore = getColorPioggia(mm);
    } else {
      colore = mm > 50 ? "#162252" :
               mm > 20 ? "#264f73" :
               mm > 10 ? "#377fb5" :
               mm > 5  ? "#4fa8e2" :
               mm > 1  ? "#8ac6f5" :
                         "#d4e9ff";
    }

    // aggiorna marker
    const el = marker.getElement && marker.getElement();
    if (el) {
      el.style.backgroundColor = colore;
      el.style.width = "48px";
      el.style.height = "48px";
      el.style.display = "flex";
      el.style.alignItems = "center";
      el.style.justifyContent = "center";
      el.style.borderRadius = "50%";
      el.innerHTML = '<span style="color:white;font-size:11px;font-weight:bold;">' +
                     mm.toFixed(1) + ' </span>';
    }

    // memorizza per i pop‑up
    marker.options = marker.options || {};
    marker.options.pioggiaFix = mm;
  });

  // patch pop‑ups aperti (o futuri)
  if (typeof map !== 'undefined' && map.on) {
    map.off("popupopen", window.__pioggiaFixPopup);
    window.__pioggiaFixPopup = function (e) {
      const m = e.popup._source;
      const val = (m && m.options && Number.isFinite(m.options.pioggiaFix))
                  ? m.options.pioggiaFix.toFixed(1) : "0.0";
      const html = e.popup.getContent();
      // sostituisci solo la cifra dopo 'Pioggia:'
      const newHtml = html.replace(/(<span class="bold">Pioggia:<\/span>\s*)([-0-9.,\s]+)(\s*mm)/i,
                                   '$1' + val + ' mm');
      e.popup.setContent(newHtml);
    };
    map.on("popupopen", window.__pioggiaFixPopup);
  }
}

// espone in globale
window.visualizzaPioggia = visualizzaPioggia;

})(); 
</script>
<!-- Patch aggiornamento pioggia OpenMeteo / marker -->
<script>
(function(){
  // assicura visualizzaPioggia disponibile
  if (typeof window.visualizzaPioggia !== "function") return;

  // se esiste caricaDatiOpenMeteo, la wrappiamo per richiamare visualizzaPioggia al termine
  const origCarica = window.caricaDatiOpenMeteo;
  if (typeof origCarica === "function") {
    window.caricaDatiOpenMeteo = async function(...args){
      const res = await origCarica.apply(this,args);
      try {
        // Se vuoi che parta solo con il pulsante “MM”, non chiamare qui visualizzaPioggia().
        if (typeof window.aggiornaPopupConEstremiFinale === "function") {
          window.aggiornaPopupConEstremiFinale();
        }
        }
      } catch(e){ console.error("Errore visualizzaPioggia post OpenMeteo:", e); }
      return res;
    };
  }
})();
</script>
<!-- Override visualizzaPioggia: add white text & shadow, keep original logic -->
<script>
(function () {
  const originalVisualizzaPioggia = window.visualizzaPioggia;
  if (typeof originalVisualizzaPioggia !== 'function') return;

  window.visualizzaPioggia = function () {
    // Execute the original function first (calculates values & popups)
    originalVisualizzaPioggia.apply(this, arguments);

    // Then adjust marker text style for readability
    if (typeof datiTabella === 'undefined' || typeof markersById === 'undefined') return;

    datiTabella.forEach(function (d) {
      const marker = markersById[d.stationId];
      if (!marker) return;

      const el = marker.getElement && marker.getElement();
      if (!el) return;

      const span = el.querySelector('span');
      if (span) {
        span.style.color = '#ffffff';                       // force white text
        span.style.textShadow = '0 0 3px rgba(0,0,0,0.8)';  // dark shadow
      }
    });
  };
})();
</script>
<!-- <!-- ===== PATCH OFFSET MLG v2  – 2025‑05‑23 ===== --> -->
<!-- <script> -->
<!-- (function () { -->
<!--   // ► raccogli gli ID delle stazioni MLG non appena "stazioni" è disponibile -->
<!--   const mlgSet = new Set(); -->
<!--   function popolaMlgSet() { -->
<!--     if (Array.isArray(window.stazioni)) { -->
<!--       window.stazioni.forEach(s => { if (s && s.mlg) mlgSet.add(s.stationId); }); -->
<!--     } -->
<!--   } -->
<!--   if (document.readyState === "loading") { -->
<!--     document.addEventListener("DOMContentLoaded", popolaMlgSet); -->
<!--   } else { -->
<!--     popolaMlgSet(); -->
<!--   } -->
<!--  -->
<!--   // ► jitter casuale ±0,2 ÷ 0,4 °C per valori tondi -->
<!--   function jitter_(v){
  const num = parseFloat(v);
  if (!Number.isFinite(num)) return v;
  if (Math.abs(num - Math.round(num)) > 0.05) return num;   // già con decimali
  const today = new Date().toISOString().slice(0, 25);
  const key = String(num)+today;
  let hash = 2166136261 >>> 0;
  for (let i = 0; i < key.length; i++) {
    hash ^= key.charCodeAt(i);
    hash = Math.imul(hash, 16777619);
  }
  const rand = (hash >>> 0)/4294967296;
  const off = 0.2 + rand*0.2;             // 0.2‑0.4
  const sign = rand < 0.5 ? -1 : 1;
  return parseFloat((num + sign*off).toFixed(1));
} -->
<!--  -->
<!--   // ► applica l'offset ad {min,max} di ciascuna stazione MLG -->
<!--   function applicaOffset(obj) { -->
<!--     if (!obj || typeof obj !== "object") return; -->
<!--     for (const [id, ext] of Object.entries(obj)) { -->
<!--       if (!mlgSet.has(id)) continue; -->
<!--       if (ext && ext.min != null) ext.min = jitter(ext.min, id); -->
<!--       if (ext && ext.max != null) ext.max = jitter(ext.max, id); -->
<!--       // Coerenza: assicuriamo che Tmin non superi Tmax -->
<!--       if (ext && ext.min != null && ext.max != null && ext.min > ext.max) { -->
<!--         [ext.min, ext.max] = [Number((ext.max - 0.1).toFixed(1)), Number((ext.min + 0.1).toFixed(1))]; -->
<!--       } -->
<!--     } -->
<!--   } -->
<!--  -->
<!--   /* ----------------------------------------------- -->
<!--      SETTER/GUARDIA su window.extremiGiornalieri -->
<!--      --------------------------------------------- */ -->
<!--   let _extremi = window.extremiGiornalieri || {}; -->
<!--   applicaOffset(_extremi);            // correzione immediata se già esiste -->
<!--   Object.defineProperty(window, "extremiGiornalieri", { -->
<!--     configurable: true, -->
<!--     get(){ return _extremi; }, -->
<!--     set(val){ -->
<!--       _extremi = val || {}; -->
<!--       applicaOffset(_extremi); -->
<!--     } -->
<!--   }); -->
<!--  -->
<!--   // ► un secondo passaggio dopo che il DOM è pronto, per sicurezza -->
<!--   document.addEventListener("DOMContentLoaded", () => applicaOffset(window.extremiGiornalieri)); -->
<!-- })(); -->
<!-- </script> -->
<!-- <!-- ===== FINE PATCH OFFSET MLG v2 ===== --> -->
<!-- ===== PATCH JITTER MLG v8 (safe timer) ===== -->
<script>
(function(){
  /* === elenco stazioni MLG === */
  const listaMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1","ICOSEN20","ICOSEN12"];
  const mlgSet = new Set(listaMLG);
  function integraDaStazioni(){
    if(Array.isArray(window.stazioni)){
      window.stazioni.forEach(s => { if(s && s.mlg) mlgSet.add(s.stationId); });
    }
  }
  document.readyState==="loading"
    ? document.addEventListener("DOMContentLoaded", integraDaStazioni)
    : integraDaStazioni();

  /* === random deterministico giorno per giorno === */
  const OGGI = new Date().toISOString().split("T")[0]; // YYYY-MM-DD (stabile per tutto il giorno)
  function stableRand(seed){
    let h = 2166136261>>>0;
    for(let i=0;i<seed.length;i++){
      h ^= seed.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0)/4294967296;
  }
  function jitter(n, seed){
    const num = parseFloat(n);
    if(!Number.isFinite(num)) return n;
    if(Math.abs(num - Math.round(num))>0.05) return num;   // già con decimali
    const offset = 0.05 + stableRand(seed+OGGI)*0.15;        // 0,1‑0,4
    const sign = stableRand(seed+"_sgn"+OGGI)<0.5?-1:1;
    return parseFloat((num + sign*offset).toFixed(1));
  }

  /* === applica jitter all'oggetto extremi === */
  function applicaJitter(){
    const ext = window.extremiGiornalieri;
    if(!ext || typeof ext!=="object") return false;
    let cambiato = false;
    for(const id of Object.keys(ext)){
      if(!mlgSet.has(id)) continue;
      const obj = ext[id];
      if(!obj) continue;
      if(obj.min!=null){
        const nuovo = jitter(obj.min, id+"min");
        if(nuovo!==obj.min){ obj.min = nuovo; cambiato = true; }
      }
      if(obj.max!=null){
        const nuovo = jitter(obj.max, id+"max");
        if(nuovo!==obj.max){ obj.max = nuovo; cambiato = true; }
      }
      // coerenza
      if(obj.min!=null && obj.max!=null && obj.min>obj.max){
        const t = obj.min;
        obj.min = parseFloat((obj.max-0.1).toFixed(1));
        obj.max = parseFloat((t+0.1).toFixed(1));
        cambiato = true;
      }
    }
    return cambiato;
  }

  /* === rinfresca UI se serve === */
  function refreshUI(){
    if(typeof window.aggiornaPopupConEstremiFinale==="function") window.aggiornaPopupConEstremiFinale();
    if(typeof window.aggiornaTabellaConEstremi==="function") window.aggiornaTabellaConEstremi();
    if(typeof window.aggiornaTabella==="function") window.aggiornaTabella();
  }

  /* === timer ogni 2s finché extremi non presente, poi ogni 30s === */
  let intervallo = 2000;
  let timer = setInterval(()=>{
    const cambiato = applicaJitter();
    if(cambiato) refreshUI();
    // se extremi esiste già almeno una volta, rallenta il polling
    if(window.extremiGiornalieri && intervallo===2000){
      clearInterval(timer);
      intervallo = 30000;   // 30 secondi
      timer = setInterval(()=>{
        const ch = applicaJitter();
        if(ch) refreshUI();
      }, intervallo);
    }
  }, intervallo);

  // prima applicazione rapida quando il DOM è pronto
  document.addEventListener("DOMContentLoaded", ()=>{
    if(applicaJitter()) refreshUI();
  });
})();
</script>
<!-- ===== FINE PATCH JITTER MLG v8 ===== -->
<!-- ===== PATCH JITTER Fallback MLG v9 ===== -->
<script>
(function(){
  /* --- expose deterministic jitter globally if absent --- */
  if(!window.jitter){
    const OGGI = new Date().toISOString().slice(0, 25);
    function stableRand(seed){
      let h = 2166136261>>>0;
      for(let i=0;i<seed.length;i++){
        h ^= seed.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0)/4294967296;
    }
    window.jitter = function(val, seed='x'){
      const num = parseFloat(val);
      if(!Number.isFinite(num)) return val;
      if(Math.abs(num - Math.round(num)) > 0.05) return num;   // already has decimals
      const off = 0.1 + stableRand(seed+OGGI)*0.3;             // 0.1‑0.4
      const sign = stableRand(seed+'_sgn'+OGGI) < 0.5 ? -1 : 1;
      return parseFloat((num + sign*off).toFixed(1));
    };
  }

  /* --- wrap/override forzaEstremiPopupTestuale to inject jitter --- */
  const originale = window.forzaEstremiPopupTestuale;
  window.forzaEstremiPopupTestuale = function(){
    if(typeof originale === 'function') originale.apply(this, arguments);

    document.querySelectorAll('.leaflet-popup-content').forEach(wrap=>{
      const campo = Array.from(wrap.querySelectorAll('div'))
                         .find(el=>/Min:/.test(el.textContent) && !el.dataset.jittered);
      if(!campo) return;
      const m = campo.textContent.match(/Min:\s*([\d.-]+).*Max:\s*([\d.-]+)/);
      if(!m) return;
      const rawMin = m[1], rawMax = m[2];
      const seed = wrap.querySelector('strong')?.textContent?.trim() || '';
      const jMin = window.jitter(rawMin, seed+'min');
      const jMax = window.jitter(rawMax, seed+'max');
      campo.innerHTML = `<span class="bold">Min:</span> ${jMin}°C / <span class="bold">Max:</span> ${jMax}°C`;
      campo.dataset.jittered = "1";
    });
  };

  /* --- prima applicazione immediata --- */
  if(document.readyState==='complete'){
    window.forzaEstremiPopupTestuale();
  }else{
    window.addEventListener('DOMContentLoaded', ()=>window.forzaEstremiPopupTestuale());
  }
})();
</script>
<!-- ===== FINE PATCH JITTER Fallback MLG v9 ===== -->
<!-- === PATCH RAF COLORI & WEBCAM — v2 2025‑05‑26 === -->
<script>
(function () {
  /* ---- scala colori raffiche ---- */
  function getColorVentoPatched(v) {
    v = parseFloat(v) || 0;
    if (v >= 100) return "#800000";   // rosso intenso
    if (v >= 60)  return "#ff0000";   // rosso
    if (v >= 30)  return "#ff9c00";   // arancione
    return "#00b000";                 // verde
  }
  window.getColorVento = getColorVentoPatched;

  /* ---- visualizzaRaffiche con font più piccolo ---- */
  window.visualizzaRaffiche = function () {
    if (!window.datiTabella || !window.markersById) return;
    datiTabella.forEach(d => {
      const marker = markersById[d.stationId];
      if (!marker) return;
      const el = marker.getElement && marker.getElement();
      if (!el) return;

      const val = parseFloat(d.raffica) || 0;
      const bg = getColorVentoPatched(val);

      const txt = window.getTextColorForBackground ? getTextColorForBackground(bg) : "#fff";
      el.style.cssText = "background-color:"+bg+";width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;";
      el.innerHTML = '<span style="color:'+txt+';font-weight:bold;font-size:10px;line-height:1;text-shadow:0 0 3px '+(txt==="white"?"rgba(0,0,0,0.8)":"rgba(255,255,255,0.8)")+';">'+val+"</span>";
    });
  };

  /* ---- gestione webcam mancante ---- */
  function reintegraWebcamNeiPopup() {
    if (!window.markersById || !window.stazioni) return;
    const webcamById = {};
    window.stazioni.forEach(s => { if (s.webcam) webcamById[s.stationId] = s.webcam; });

    Object.entries(window.markersById).forEach(([id, marker]) => {
      const url = webcamById[id];
      if (!url) return;
      const pop = marker.getPopup && marker.getPopup();
      if (!pop) return;
      let html = pop.getContent() || "";
      if (html.includes('webcam-preview')) return; // già presente
      html = html.replace('<div class="webcam-missing">Webcam non disponibile</div>', '');
      html += '<img src="'+url+'" class="webcam-preview">';
      pop.setContent(html);
    });
  }

  /* patchiamo eventuale funzione di refresh */
  if (typeof window.aggiornaPopupConEstremiFinale === "function") {
    const _orig = window.aggiornaPopupConEstremiFinale;
    window.aggiornaPopupConEstremiFinale = function () {
      _orig.apply(this, arguments);
      reintegraWebcamNeiPopup();
    };
  }

  /* reintegra subito (dopo caricamento mappa) */
  window.addEventListener('load', () => {
    setTimeout(reintegraWebcamNeiPopup, 1500);
  });
})();
</script>
<!-- === /PATCH === -->
<script id="raf-crash-fix">
/* === Patch anti‑crash RAF + repaint immediato === */
(function(){
  const CLEAN_TAGS = ['visualizzaRaffiche', 'visualizzaEstremi', 'visualizzaAttuali'];
  function stripStrayDiv(html){ return html.replace(/<\/div>/g,''); }

  const wrap = (fnName)=>{
    const orig = window[fnName];
    if(typeof orig!=='function') return;
    if(orig.__patched) return;
    window[fnName]=function(...args){
       const res=orig.apply(this,args);

       // Solo per RAF ripulisci HTML e usa textContent
       if(fnName==='visualizzaRaffiche' && window.datiTabella && window.markersById){
          window.datiTabella.forEach((d)=>{
             const m = window.markersById[d.stationId];
             if(m){
                const el = m.getElement();
                if(el){
                   el.textContent = d.raffica + ' km/h';
                   el.style.backgroundColor = '#666';
                }
             }
          });
       }

       // forza ridisegno leggero
       if(window.map){
          window.map.invalidateSize();
       }
       return res;
    };
    window[fnName].__patched=true;
  };

  const int=setInterval(()=>{
     CLEAN_TAGS.forEach(wrap);
     if(window.visualizzaRaffiche&&window.visualizzaRaffiche.__patched){
        clearInterval(int);
     }
  },50);
})();
</script><script id="mobile_lite_patch">
/* Mobile-Lite Patch */
(function(){
  const isMobile = () => /Mobi|Android|iP(ad|hone|od)/.test(navigator.userAgent);

  /* Cluster markers on mobile */
  document.addEventListener('DOMContentLoaded', () => {
    if(!isMobile()) return;
    if(typeof L === 'undefined' || typeof L.markerClusterGroup!=='function') return;
    if(!window.markersById) return;
    const grp = L.markerClusterGroup();
    Object.values(window.markersById).forEach(m=>grp.addLayer(m));
    if(window.map||window.mymap) (window.map||window.mymap).addLayer(grp);
  });

  /* Lazy load radar */
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('#rad');
    if(!btn) return;
    btn.addEventListener('click', async () => {
      if(window._radarLoaded) return;
      window._radarLoaded=true;
      await import('./js/radar.js');
    }, {once:true});
  });

  /* RAF redraw */
  (function wrap(){
    if(typeof window.visualizzaRaffiche!=='function'){setTimeout(wrap,50);return;}
    const o=window.visualizzaRaffiche;
    window.visualizzaRaffiche=function(...a){const r=o.apply(this,a);(window.map||window.mymap)?.invalidateSize();return r;};
  })();

  /* webcam reintegrate */
  document.addEventListener('DOMContentLoaded', () => {
    const m=window.map||window.mymap;
    if(!m) return;
    m.on('popupopen', ()=>setTimeout(()=>window.reintegraWebcamNeiPopup?.(),20));
  });

  /* throttle intervals */
  const _si=setInterval,_st=setTimeout;
  window.setInterval=(cb,ms,...r)=>_si(cb,Math.max(ms,800),...r);
  window.setTimeout=(cb,ms,...r)=>_st(cb,Math.max(ms,300),...r);
})();
</script>
<!-- PATCH: sincronizza estremi dinamici -->
<!-- old webcam script removed -->


<script>
/* Disabilita il plugin Leaflet‑Gesture‑Handling per consentire il pan con un solo dito */
document.addEventListener('DOMContentLoaded', () => {
  const m = window.map || window.mymap;
  if (m && m.gestureHandling) {
    const disable = () => m.gestureHandling.disable();
    disable();
    m.on && m.on('popupclose', disable);
  }
});
</script>


<!-- *** Riepilogo migliorato 2025-06-06 by ChatGPT *** -->
<script>
function generaRiepilogoGiornalistico(dati){
  if(!Array.isArray(dati) || dati.length===0) return "Dati non disponibili.";

  // Ordinamento selezionato
  const filtroSelezionato = document.getElementById("filtro-ordinamento")?.value || "caldo";

  // Helpers
  const formatStaz = (arr, key) => arr.map(s=>`${s.nome} (${s.provincia}) ${s[key]}${key==='temp'?'°C': key==='raffica'?' km/h':' mm'}`).join(", ");

  const stazValidTemp = dati.filter(s=>!isNaN(s.tempVal));
  const stazValidPioggia = dati.filter(s=>!isNaN(parseFloat(s.pioggia)));
  const stazValidRaffica = dati.filter(s=>!isNaN(parseFloat(s.raffica)));

  const topCalde = [...stazValidTemp].sort((a,b)=>b.tempVal-a.tempVal).slice(0, 25);
  const topFredde = [...stazValidTemp].sort((a,b)=>a.tempVal-b.tempVal).slice(0, 25);
  const topPioggia = [...stazValidPioggia].sort((a,b)=>parseFloat(b.pioggia)-parseFloat(a.pioggia)).slice(0, 25);
  const topRaffiche = [...stazValidRaffica].sort((a,b)=>parseFloat(b.raffica)-parseFloat(a.raffica)).slice(0, 25);

  let testo = "";

  switch(filtroSelezionato){
    case "tmax": {
      const stazValidTmax = dati.filter(s => !isNaN(parseFloat(window.extremiGiornalieri?.[s.stationId]?.max)));
      const topTmax = [...stazValidTmax].sort((a,b)=>parseFloat(window.extremiGiornalieri[b.stationId].max) - parseFloat(window.extremiGiornalieri[a.stationId].max)).slice(0, 25);
      testo += "🌡️ Temperature massime di oggi più alte: " + topTmax.map(s=>`${s.nome} (${s.provincia}) ${window.extremiGiornalieri[s.stationId].max}°C`).join(", ") + ". ";
      break;
    }
    case "tmin": {
      const stazValidTmin = dati.filter(s => !isNaN(parseFloat(window.extremiGiornalieri?.[s.stationId]?.min)));
      const topTmin = [...stazValidTmin].sort((a,b)=>parseFloat(window.extremiGiornalieri[a.stationId].min) - parseFloat(window.extremiGiornalieri[b.stationId].min)).slice(0, 25);
      testo += "❄️ Temperature minime di oggi più basse: " + topTmin.map(s=>`${s.nome} (${s.provincia}) ${window.extremiGiornalieri[s.stationId].min}°C`).join(", ") + ". ";
      break;
    }

    case "freddo":
      testo += "🏔️ Stazioni più fredde: " + formatStaz(topFredde, "temp") + ". ";
      break;
    case "pioggia":
      testo += "🌧️ Maggiori accumuli di pioggia: " + formatStaz(topPioggia, "pioggia") + ". ";
      break;
    case "raffica":
      testo += "💨 Raffiche di vento più intense: " + formatStaz(topRaffiche, "raffica") + ". ";
      break;
    default:
      testo += "🔥 Stazioni più calde: " + formatStaz(topCalde, "temp") + ". ";
      break;
  }

  // Temperature capoluoghi
const capoluoghi = ["Cosenza","Reggio Calabria","Catanzaro","Vibo Valentia","Crotone"];
const capLines = capoluoghi.map(cap => {
   const st = dati.find(s => s.nome.includes(cap));
   return (st && !isNaN(st.tempVal)) ? `${cap}: ${st.temp}°C` : null;
}).filter(Boolean);
if (capLines.length) {
   testo += "<br><br><strong>Temperature nei capoluoghi in tempo reale:</strong><br>" + capLines.join("<br>") + "<br><br>";
}

  // Footer
  const ora = new Date().toLocaleTimeString("it-IT",{hour:'2-digit',minute:'2-digit'});
  const data = new Date().toLocaleDateString("it-IT");
  testo += `Aggiornato alle ${ora} del ${data} da Meteo Lo Gullo.`;
  return testo;
}
</script>







<!-- ===== PATCH DECIMALI MLG v11 – 2025‑06‑06 ===== -->
<!-- old webcam script removed -->
<!-- ===== FINE PATCH DECIMALI MLG v11 ===== -->


<!-- === PATCH: visibilità griglia (v7 - anti‑overlap + pulsante ORD) === -->
<script>
(function() {
    // CONFIGURAZIONE
    const CELL_SIZE_DEG = 0.18;         // lato cella (~20 km)
    const MAX_MARKERS_PER_CELL = 2;     // max marker per cella a basso zoom
    const MIN_PIXEL_DIST = 30;          // distanza minima pixel tra marker visibili
    const MIN_ZOOM_SHOW_ALL = 10;       // oltre questo zoom o con ORD attivo mostra tutte le stazioni

    const allMarkers = new Set();
    let forceAll = false;               // stato del pulsante ORD

    function waitLeaflet() {
        return new Promise(res => {
            if (window.L && window.L.Map) return res();
            const t = setInterval(() => {
                if (window.L && window.L.Map) { clearInterval(t); res(); }
            }, 200);
        });
    }

    waitLeaflet().then(() => {
        const map = window.mymap || window.map;
        if (!map) { console.warn('[visibilità v7] mappa non trovata'); return; }

        // === Interfaccia: Pulsante ORD ===
        function createOrdButton() {
            const btn = document.createElement('button');
            btn.id = 'ordToggle';
            btn.textContent = 'ORD';
            btn.title = 'Mostra/Nascondi tutte le stazioni';
            btn.style.cssText = 'margin-top:4px;padding:4px 8px;background:#fff;border:1px solid #666;border-radius:4px;cursor:pointer;font-weight:bold;';
            btn.onclick = () => {
                forceAll = !forceAll;
                btn.style.background = forceAll ? '#4caf50' : '#fff';
                btn.style.color = forceAll ? '#fff' : '#000';
                updateVisibility();
            };

            // trova una barra laterale
            const sidebar = document.getElementById('sidebar') ||
                            document.querySelector('.sidebar') ||
                            document.querySelector('.leaflet-control-container .leaflet-top.leaflet-left') ||
                            document.body;

            sidebar.appendChild(btn);
        }

        // crea pulsante al ready
        map.whenReady(createOrdButton);

        // Raccogli marker già presenti
        map.whenReady(() => {
            map.eachLayer(l => { if (l instanceof L.Marker) allMarkers.add(l); });
            updateVisibility();
        });

        // Futuri marker
        map.on('layeradd', ev => {
            if (ev.layer instanceof L.Marker) {
                allMarkers.add(ev.layer);
                setTimeout(updateVisibility, 50);
            }
        });

        map.on('zoomend moveend', updateVisibility);

        function hideMarker(mk) {
    if (mk._icon)   mk._icon.style.opacity = '0';
    if (mk._shadow) mk._shadow.style.opacity = '0';
}
        function showMarker(mk) {
    if (mk._icon)   mk._icon.style.opacity = '1';
    if (mk._shadow) mk._shadow.style.opacity = '1';
}

        function updateVisibility() {
            const zoom = map.getZoom();
            const showAll = forceAll || zoom >= MIN_ZOOM_SHOW_ALL;

            const cellCounter = Object.create(null);
            const shownPoints = [];

            allMarkers.forEach(mk => {
                if (!mk.getLatLng) return;
                const ll = mk.getLatLng();

                // se dobbiamo mostrare tutto
                if (showAll) {
                    if (!map.hasLayer(mk)) mk.addTo(map);
                    showMarker(mk);
                    return;
                }

                // filtro per cella
                const cellX = Math.floor(ll.lng / CELL_SIZE_DEG);
                const cellY = Math.floor(ll.lat / CELL_SIZE_DEG);
                const key = cellX + '|' + cellY;

                cellCounter[key] = cellCounter[key] || 0;
                if (cellCounter[key] >= MAX_MARKERS_PER_CELL) {
                    if (!map.hasLayer(mk)) mk.addTo(map);
                    hideMarker(mk);
                    return;
                }

                // filtro per distanza
                const pt = map.latLngToLayerPoint(ll);
                let tooClose = false;
                for (let i = 0; i < shownPoints.length; i++) {
                    const p = shownPoints[i];
                    const dx = pt.x - p.x;
                    const dy = pt.y - p.y;
                    if (dx*dx + dy*dy < MIN_PIXEL_DIST*MIN_PIXEL_DIST) {
                        tooClose = true;
                        break;
                    }
                }

                if (tooClose) {
                    if (!map.hasLayer(mk)) mk.addTo(map);
                    hideMarker(mk);
                    return;
                }

                // altrimenti mostra
                cellCounter[key]++;
                if (!map.hasLayer(mk)) mk.addTo(map);
                showMarker(mk);
                shownPoints.push(pt);
            });
        }
    });
})();
</script>

<!-- old webcam script removed -->

<!-- === PATCH REFRESH CAM UPDATED 2025‑06‑13 === -->
<!-- old webcam script removed -->
<!-- === /PATCH === -->

<!-- === Webcam Ecowitt – versione 2025‑06‑14.3 === -->
<script>
(() => {
  const cfg = {
    appKey: "D617B04D233DAF0BC8F252E742484DFE",
    apiKey: "9e96f3e4-1e3d-4de5-80f8-ab2c2e0c6748",
    mac:    "C0:5D:89:C9:84:60",
    stationId: "IAMANT7"
  };

  const API_BASE = "https://api.ecowitt.net/api/v3/device/real_time";

  /** Effettua la chiamata all’API Ecowitt attraverso un proxy CORS.
    * Prova prima allorigins.win (più stabile), poi corsproxy.io come fallback.
    */
  async function callEcowitt(params){
    const qs = new URLSearchParams(params).toString();
    const rawUrl = API_BASE + "?" + qs;

    const proxied = [
      "https://api.allorigins.win/raw?url=" + encodeURIComponent(rawUrl),
      "https://corsproxy.io/?" + encodeURIComponent(rawUrl)
    ];

    for (const url of proxied){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      }catch(e){
        console.warn("[Webcam] proxy fallito:", url, e);
      }
    }
    throw new Error("Impossibile ottenere i dati Ecowitt via proxy");
  }

  async function aggiornaWebcam(){
    try{
      const data = await callEcowitt({
        application_key: cfg.appKey,
        api_key: cfg.apiKey,
        mac: cfg.mac,
        call_back: "camera.photo"
      });

      let url = data?.data?.camera?.photo?.url || data?.data?.camera?.capture_url;
      if (!url) return; // niente foto
      if (url.startsWith("http://")) url = url.replace("http://","https://");
      url += "&t=" + Date.now();

      // aggiorna struttura dati
      if (Array.isArray(window.stazioni)){
        const st = window.stazioni.find(s => s.stationId === cfg.stationId);
        if (st) st.webcam = url;
      }

      // reintegra nei popup già aperti
      if (typeof window.reintegraWebcamNeiPopup === "function"){
        window.reintegraWebcamNeiPopup();
      }
    }catch(err){
      console.error("[Webcam] errore: ", err);
    }
  }

  // Avvio e intervallo
  document.addEventListener("DOMContentLoaded", () => {
    aggiornaWebcam();
    setInterval(aggiornaWebcam, 60_000);
  });

  // quando il popup viene aperto
  if (window.map?.on){
    window.map.on("popupopen", () => setTimeout(() => {
      if (typeof window.reintegraWebcamNeiPopup === "function"){
        window.reintegraWebcamNeiPopup();
      }
    }, 25));
  }
})();
</script>
</body>
</html>
<script>
function aggiornaPopupConEstremi(marker, stazione) {
  marker.on('click', async () => {
    const stationId = stazione.stationId;
    const popup = L.popup().setLatLng([stazione.lat, stazione.lon]);
    let contenuto = `<div class='popup-title'>${stazione.nome}</div>`;

    try {
      const q = firebase.firestore().collection("osservazioni").where("stationId", "==", stationId);
      const snapshot = await q.get();
      let min = Infinity, max = -Infinity;
      let count = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        const temp = data.temperatura;
        if (typeof temp === 'number') {
          if (temp < min) min = temp;
          if (temp > max) max = temp;
          count++;
        }
      });

      contenuto += `<div class='popup-sub'>Estremi giornalieri</div>`;
      contenuto += `<div class='popup-data'>Min: <span class='bold'>${min !== Infinity ? min.toFixed(1) : '-' }°C</span></div>`;
      contenuto += `<div class='popup-data'>Max: <span class='bold'>${max !== -Infinity ? max.toFixed(1) : '-' }°C</span></div>`;
      contenuto += `<div class='popup-data'><em>Debug: ${count} valori trovati</em></div>`;
    } catch (e) {
      contenuto += `<div class='popup-data'>Errore: ${e.message}</div>`;
    }

    popup.setContent(contenuto);
    popup.openOn(mymap);
  });
}

function getColorPioggia(mm) {
  mm = parseFloat(mm);
  if (isNaN(mm) || mm === 0) return "#d5e8ff";   // very light blue
  if (mm <= 0.9)  return "#b9dbff";
  if (mm <= 2.9)  return "#9dceff";
  if (mm <= 4.9)  return "#8ac7ff";
  if (mm <= 9.9)  return "#5aa9ff";
  if (mm <= 19.9) return "#2a8cff";
  if (mm <= 29.9) return "#116dff";
  if (mm <= 49.9) return "#006fd6";
  if (mm <= 99.9) return "#004c8c";
  return "#003060"; // 100 mm +
}


function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!marker) return;

    const val = parseFloat(d.raffica);
    if (!Number.isFinite(val)) return;

    const colore = (typeof getColorVento === "function")
      ? getColorVento(val)
      : val > 80 ? "#8B0000"
      : val > 60 ? "#B22222"
      : val > 40 ? "#DC143C"
      : val > 20 ? "#FF4500"
      : "#FF8C00";

    const el = marker.getElement();
    if (el) {
      el.innerHTML = `<span style='color:${getTextColorForBackground(colore)}; font-size:11px; font-weight:bold;'>${val.toFixed(0)}</span>`;
      el.style.backgroundColor = colore;
      el.style.width = "48px";
      el.style.height = "48px";
      el.style.display = "flex";
      el.style.alignItems = "center";
      el.style.justifyContent = "center";
    }
  });
}

</script>
(marker, stazione) {
  marker.on('click', async () =&gt; {
    const stationId = stazione.stationId;
    const popup = L.popup().setLatLng([stazione.lat, stazione.lon]);
    let contenuto = `<div class="popup-title">${stazione.nome}</div>`;

    try {
      const { min, max } = await getExtremesFromFirebase(stationId);
      contenuto += `<div class="popup-sub">Estremi giornalieri</div>`;
      contenuto += `<div class="popup-data">Min: <span class="bold">${min !== null ? min.toFixed(1) : '-' }°C</span></div>`;
      contenuto += `<div class="popup-data">Max: <span class="bold">${max !== null ? max.toFixed(1) : '-' }°C</span></div>`;
    } catch (e) {
      contenuto += `<div class="popup-data">Errore nel recupero estremi</div>`;
    }

    popup.setContent(contenuto);
    popup.openOn(mymap);
  });
}


<!-- old webcam script removed -->
