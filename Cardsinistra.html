<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<title>
   Mappa Meteo Calabria
  </title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" rel="stylesheet"/>
<style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #f4f4f4; }

#banner {
  background-color: #1a3a9b; /* Colore blu */
  color: white;
  text-align: center;
  padding: 10px 0;
  font-size: 24px;
  font-weight: bold;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 1000;
}

#map {
  height: calc(100vh - 60px);
  width: 100%;
  border-bottom: 2px solid #ccc;
}

#tabella {
  padding: 20px;
}

.temperature-label {
  width: 26px !important;
  height: 26px !important;
  font-size: 13px !important;

  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-weight: bold;
  font-size: 15px;
  border: 2px solid #fff;
  color: #000;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.popup-title { font-size: 16px; font-weight: bold; }
.popup-sub { font-size: 13px; color: #666; margin-bottom: 6px; }
.popup-data { margin: 2px 0; font-size: 15px; }
.bold { font-weight: bold; }
.webcam-preview { width: 100%; max-height: 100px; object-fit: cover; margin-top: 5px; border-radius: 5px; }
.webcam-missing { font-size: 13px; color: #777; margin-top: 5px; text-align: center; }
.btn {
  display: inline-block;
  padding: 6px 10px;
  margin: 5px 5px 0 0;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-decoration: none;
  font-size: 13px;
}
.btn:hover { background-color: #0056b3; }
#popup-grafico {
  position: fixed;
  top: 10%;
  left: 5%;
  width: 90%;
  height: 80%;
  background: white;
  border: 2px solid #007bff;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  z-index: 10000;
}
#popup-grafico iframe { flex: 1; width: 100%; border: none; }
#popup-grafico .close-btn {
  background: red;
  color: white;
  padding: 5px;
  border: none;
  width: 100%;
  font-weight: bold;
  cursor: pointer;
}
a.btn { color: white !important; }
  </style>
<style>
   .card.compact-extreme {
  font-size: 16px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fdfdfd;
  margin: 5px 0;
}
.card.compact-extreme span {
  font-size: 17px;
}
.card.compact-extreme .valore {
  font-size: 20px;
  color: #c00;
}
  </style>
<style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

html, body {
  scroll-padding-top: 60px; /* Compensa altezza banner fisso */
}
  </style>
<style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

#slide-banner.show {
  right: 0 !important;
}
  </style>
<style>
   .sidebar-btn.attivo {
  box-shadow: inset 0 0 4px #00000099;
  font-weight: bold;
  border-left: 2px solid #000;
}
  </style>
<style>
   /* Modernizzazione barra laterale */
#sidebar {
  background: linear-gradient(to bottom, #ffffffcc, #f0f0f0cc);
  border-right: 1px solid #bbb;
  box-shadow: 2px 0 6px rgba(0,0,0,0.15);
  backdrop-filter: blur(4px);
}

/* Pulsanti moderni */
.sidebar-btn {
  border-radius: 6px;
  margin: 6px 0;
  font-weight: 600;
  font-size: 11px;
  background-color: #e6e6e6;
  color: #333;
  border: 1px solid #ccc;
  transition: all 0.2s ease;
}

.sidebar-btn:hover {
  background-color: #d0d0d0;
  transform: scale(1.05);
}

.sidebar-btn.attivo {
  background-color: #007bff !important;
  color: white !important;
  border-left: 3px solid #004a99;
  box-shadow: inset 0 0 5px #00000033;
}
  </style>
<style>
   .highlight-temp {
    font-size: 36px;
    font-weight: bold;
}
  </style>
<style>
   .filter-button.active {
    background-color: #337ab7;
    color: white;
}
  </style>
<style>
   .filtro-box {
  background: white;
  padding: 12px;
  border-radius: 10px;
  margin: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.filtro-box label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}
.filtro-box select, .filtro-box input[type="checkbox"] {
  margin-top: 4px;
}
  </style>
<style>
   .card.compact-extreme {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #fefefe;
  margin: 6px 0;
  font-size: 15px;
}
.card.compact-extreme span.nome {
  font-weight: 600;
  flex: 1;
}
.card.compact-extreme span.valore {
  font-weight: bold;
  font-size: 16px;
  color: #c00;
  text-align: right;
}
  </style>
<style>
   #filtro-provincia, #filtro-ordinamento {
  margin-left: 6px;
  padding: 4px 8px;
  border-radius: 6px;
  background: #eef;
  font-weight: bold;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}
  </style>
<style>
   #filtro-provincia, #filtro-ordinamento {
  margin: 0;
  padding: 4px 6px;
  border-radius: 5px;
  background: #eef;
  font-weight: bold;
  font-size: 14px;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 6px;
}
.filtro-box label {
  font-size: 14px;
}
#filtro-mlg {
  transform: scale(0.9);
  margin-right: 4px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 13px;
  font-weight: 500;
  color: #333;
  margin-top: 4px;
}
  </style>
<style>
   /* Rendi tutto molto pi√π compatto */
#filtro-provincia, #filtro-ordinamento {
  margin: 0;
  padding: 2px 5px;
  border-radius: 4px;
  background: #eef;
  font-weight: bold;
  font-size: 13px;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 4px;
  font-size: 13px;
}
.filtro-box label {
  font-size: 13px;
}
#filtro-mlg {
  transform: scale(0.85);
  margin-right: 4px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 12.5px;
  font-weight: 500;
  color: #333;
  margin: 2px 0 0 0;
}
  </style>
<style>
   /* Marker circle and label size adjustment */
.temperature-label, .leaflet-marker-icon {
  width: 26px !important;
  height: 26px !important;
  font-size: 11px !important;
  line-height: 26px !important;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  white-space: nowrap;
  border-radius: 50%;
}

/* MLG star size fix (assuming 'star-mlg' class or similar) */
.leaflet-marker-icon.star-mlg {
  width: 12px !important;
  height: 12px !important;
  transform: translate(-50%, -50%);
}
  </style>
<style>
   /* Marker circle and label size adjustment */
.temperature-label, .leaflet-marker-icon {
  width: 26px !important;
  height: 26px !important;
  font-size: 10px !important;
  line-height: 26px !important;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  white-space: nowrap;
  border-radius: 50%;
}

/* Visible and appropriately scaled MLG star icon */
.leaflet-marker-icon.star-mlg {
  width: 12px !important;
  height: 12px !important;
  transform: translate(-50%, -50%);
  display: inline-block !important;
  visibility: visible !important;
  z-index: 9999 !important;
}
  </style>
<style>
   #anteprima-live {
    background: linear-gradient(to bottom, #f8faff, #ffffff);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin: 16px auto;
    padding: 20px;
    max-width: 900px;
  }
  #anteprima-live h2 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 10px;
    color: #003366;
    text-align: center;
  }
  #preview-cards .card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffff;
    border: 1px solid #dde3ec;
    border-radius: 10px;
    padding: 12px 18px;
    margin-bottom: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    transition: transform 0.2s ease;
  }
  #preview-cards .card:hover {
    transform: scale(1.015);
  }
  #preview-cards .card .nome {
    font-weight: 600;
    font-size: 16px;
    color: #222;
  }
  #preview-cards .card .valore {
    font-size: 18px;
    font-weight: bold;
    color: #0055aa;
  }
  #preview-cards .card .btn {
    margin-left: auto;
    background-color: #007bff;
    border: none;
    padding: 6px 12px;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #preview-cards .card .btn:hover {
    background-color: #0056b3;
  }
  </style>
<style>
   #anteprima-live {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 500;
  background: rgba(255,255,255,0.95);
  border-top: 2px solid #ccc;
  padding: 14px 20px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  backdrop-filter: blur(6px);
}
  </style>
<style>
#map {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  height: auto;
  min-height: calc(100vh - 60px);
}
#anteprima-live {
  margin-top: auto;
}
</style>
<style>
/* MIGLIORAMENTO GRAFICO CARDS METEO PER MOBILE */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}

#tabella .card .intestazione {
  font-size: 17px;
  font-weight: 700;
  color: #003366;
  margin-bottom: 4px;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 14px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  display: inline-block;
  padding: 4px 6px;
  background: #007bff;
  color: white;
  font-size: 12px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 6px;
}

@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15px;
  }
}
}</style>
<style>
/* Stile migliorato per sezione anteprima testuale */
#anteprima-dati-testuali {
  position: absolute;
  top: calc(100vh - 160px);
  left: 0;
  width: 100%;
  background: linear-gradient(to bottom, #f9fbff, #ffffff);
  z-index: 9999;
  padding: 24px 18px;
  box-shadow: 0 -2px 14px rgba(0,0,0,0.15);
  border-top: 2px solid #ccd6e0;
  border-radius: 18px 18px 0 0;
  font-family: "Segoe UI", sans-serif;
}

#anteprima-dati-testuali > div:first-child {
  font-weight: 600;
  font-size: 17px;
  color: #003366;
  text-align: center;
  margin-bottom: 16px;
}

.filtro-box {
  background: #f0f4f8;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

.filtro-box label {
  font-weight: 500;
  font-size: 15px;
  display: block;
  color: #222;
}

.filtro-box input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.2);
}

.filtro-riga-select {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  font-size: 15px;
  margin-top: 10px;
}

.filtro-riga-select label {
  font-weight: 600;
}

#filtro-provincia, #filtro-ordinamento, #filtro-provincia-estremi {
  padding: 6px 10px;
  border-radius: 8px;
  background: #e6efff;
  border: 1px solid #aac4e6;
  font-size: 14px;
  font-weight: 500;
}

#filtro-prov-extremi-container {
  margin-top: 10px;
  background: #eef3f9;
  padding: 10px 12px;
  border-radius: 10px;
}

.mlg-label-small {
  font-size: 14px;
  color: #003366;
  font-weight: 500;
}

@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 18px 14px;
  }

  .filtro-box {
    padding: 10px;
  }

  .filtro-riga-select {
    flex-direction: column;
    align-items: flex-start;
  }

  #filtro-provincia, #filtro-ordinamento {
    width: 100%;
  }
}
</style>
<style>
/* SEZIONE ANTEPRIMA COMPLETAMENTE RIDISEGNATA PER MOBILE */

/* Contenitore principale */
#anteprima-dati-testuali {
  position: absolute;
  top: calc(100vh - 180px);
  left: 0;
  width: 100%;
  background: #f9fbff;
  z-index: 9999;
  padding: 26px 16px 20px;
  box-shadow: 0 -3px 14px rgba(0,0,0,0.12);
  border-top: 2px solid #b0c4de;
  border-radius: 20px 20px 0 0;
  font-family: "Segoe UI", sans-serif;
}

/* Titolo iniziale */
#anteprima-dati-testuali > div:first-child {
  font-weight: 700;
  font-size: 17px;
  color: #002b55;
  text-align: center;
  margin-bottom: 20px;
  margin-top: -6px;
}

/* Filtro box modernizzati */
.filtro-box {
  background: #eaf2f8;
  padding: 14px 16px;
  border-radius: 12px;
  margin-bottom: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}

.filtro-box label {
  font-weight: 500;
  font-size: 15px;
  color: #1a1a1a;
  display: flex;
  align-items: center;
}

.filtro-box input[type="checkbox"] {
  margin-right: 10px;
  transform: scale(1.1);
}

/* Riorganizzazione selettori */
.filtro-riga-select {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 15px;
  margin-bottom: 14px;
}

.filtro-riga-select label {
  font-weight: 600;
  margin-bottom: 4px;
}

/* Select dropdown */
#filtro-provincia, #filtro-ordinamento, #filtro-provincia-estremi {
  padding: 7px 12px;
  border-radius: 10px;
  background: #e0edff;
  border: 1px solid #aac6f2;
  font-size: 14px;
  font-weight: 500;
  width: 100%;
}

/* Riquadro extra per selettore province estremi */
#filtro-prov-extremi-container {
  margin-top: 12px;
  background: #f3f7fc;
  padding: 12px;
  border-radius: 10px;
}

/* Etichetta "Tabella: dati in tempo reale" */
#filtro-mlg {
  display: none;
}
/* Rimosso ::before duplicato per "Tabella: dati in tempo reale" */
/* .mlg-label-small::before { */
/* content: "Tabella: dati in tempo reale";
  font-size: 15px;
  font-weight: 600;
  color: #003366;
  display: block;
  margin-top: 16px;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

/* Card meteo ottimizzate */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}

#tabella .card .intestazione {
  font-size: 17px;
  font-weight: 700;
  color: #003366;
  margin-bottom: 6px;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 8px 16px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  display: inline-block;
  padding: 5px 8px;
  background: #007bff;
  color: white;
  font-size: 12px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 10px;
}

/* Mobile fix */
@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 20px 12px;
  }

  .filtro-box {
    padding: 12px;
  }

  .filtro-riga-select {
    gap: 8px;
  }

  #tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}
}</style>
<style>
/* CORREZIONE POSIZIONE MLG + TESTO STATICO "Dati testuali in tempo reale" */
#filtro-mlg {
  margin-top: 16px;
  transform: scale(1.05);
  margin-right: 8px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 14px;
  font-weight: 500;
  color: #003366;
  margin: 12px 0 4px 0;
}

/* Etichetta sostitutiva sopra i filtri */
#label-dati-realtime {
  font-size: 16px;
  font-weight: 600;
  color: #002b55;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  margin-bottom: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  text-align: center;
}
</style>
<style>
/* FIX larghezza elementi e spostamento */
.filtro-riga-select {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 15px;
  margin-bottom: 14px;
}

.filtro-riga-select label {
  font-weight: 600;
  margin-bottom: 2px;
}

#filtro-provincia,
#filtro-ordinamento,
#filtro-provincia-estremi {
  width: 100%;
  max-width: 280px;
  padding: 7px 12px;
  border-radius: 8px;
  background: #e0edff;
  border: 1px solid #aac6f2;
  font-size: 14px;
  font-weight: 500;
}

/* Etichetta tabella spostata sopra */
#label-dati-realtime {
  font-size: 16px;
  font-weight: 600;
  color: #002b55;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  margin: 10px 0 18px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  text-align: center;
}

/* Checkbox filtro finale */
#filtro-mlg {
  margin-top: 16px;
  transform: scale(1.05);
  margin-right: 8px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 14px;
  font-weight: 500;
  color: #003366;
  margin: 12px 0 8px;
}
</style>
<style>
#tabella .card {
  background: #ffffff;
  border: 1px solid #bbcfe6;
  border-radius: 16px;
  padding: 22px 20px;
  margin-bottom: 18px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.05);
  font-size: 16px;
  line-height: 1.7;
  transition: transform 0.2s ease;
  width: 100%;
  max-width: 680px;
  margin-left: auto;
  margin-right: auto;
}
#tabella .card:hover {
  transform: scale(1.015);
}
#tabella .card .intestazione {
  font-size: 19px;
  font-weight: 700;
  color: #002a4d;
  margin-bottom: 10px;
}
@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15px;
  }
  #tabella .card .intestazione {
    font-size: 17px;
  }
}</style>
<style>
/* MIGLIORAMENTO GRAFICO CARDS ORIGINALE */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 22px 20px;
  margin: 20px auto;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 16px;
  line-height: 1.7;
  transition: transform 0.2s ease;
  width: 95%;
  max-width: 840px;
}
#tabella .card:hover {
  transform: scale(1.015);
}
#tabella .card .intestazione {
  font-size: 20px;
  font-weight: 700;
  color: #002a4d;
  margin-bottom: 12px;
}
#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 10px 18px;
  color: #333;
}
#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}
#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}
#tabella .card .badge {
  display: inline-block;
  padding: 5px 10px;
  background: #007bff;
  color: white;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 12px;
}

@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15.5px;
  }
  #tabella .card .intestazione {
    font-size: 18px;
  }
}</style>
<style>
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 20px;
  margin: 20px auto;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 15.5px;
  line-height: 1.6;
  width: 95%;
  max-width: 100%;
  box-sizing: border-box;
}

#tabella .card .intestazione {
  font-size: 18px;
  font-weight: bold;
  color: #003366;
  margin-bottom: 12px;
}

#tabella .card .dati {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px 14px;
  color: #333;
  width: 100%;
}

#tabella .card .dati span {
  display: flex;
  flex-direction: column;
  font-weight: 500;
  font-size: 14px;
}

#tabella .card .dati .valore {
  font-weight: bold;
  color: #0055aa;
  font-size: 15px;
}

#tabella .card .badge {
  margin-top: 12px;
  background: #007bff;
  color: white;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  display: inline-block;
}

/* Responsive fix per schermi piccoli */
@media (max-width: 480px) {
  #tabella .card {
    padding: 16px 14px;
    font-size: 14.5px;
  }

  #tabella .card .intestazione {
    font-size: 16px;
  }

  #tabella .card .dati span {
    font-size: 13.5px;
  }

  #tabella .card .dati .valore {
    font-size: 14px;
  }
}</style>
<style>
/* Allinea le card a sinistra e sfrutta meglio lo spazio disponibile */
#tabella {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 16px;
  padding: 12px;
}

#tabella .card {
  width: calc(50% - 16px);
  margin: 0;
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 15.5px;
  line-height: 1.6;
  box-sizing: border-box;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.015);
}

#tabella .card .intestazione {
  font-size: 18px;
  font-weight: bold;
  color: #003366;
  margin-bottom: 12px;
}

#tabella .card .dati {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px 14px;
  color: #333;
  width: 100%;
}

#tabella .card .dati span {
  display: flex;
  flex-direction: column;
  font-weight: 500;
  font-size: 14px;
}

#tabella .card .dati .valore {
  font-weight: bold;
  color: #0055aa;
  font-size: 15px;
}

#tabella .card .badge {
  margin-top: 12px;
  background: #007bff;
  color: white;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  display: inline-block;
}

/* Visualizzazione mobile: una sola colonna */
@media (max-width: 600px) {
  #tabella .card {
    width: 100%;
  }
}</style>

<style>
#tabella {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 16px;
  padding: 12px;
}

#tabella .card {
  margin: 0 !important;
  width: calc(50% - 16px);
  box-sizing: border-box;
}

@media (max-width: 600px) {
  #tabella .card {
    width: 100%;
  }
}
</style>

<style>
#tabella .card {
  margin: 0 !important;
  width: calc(50% - 16px);
  box-sizing: border-box;
}
@media (max-width: 600px) {
  #tabella .card {
    width: 100%;
  }
}
</style>

</head>
<body>
<!-- Sidebar Meteo -->
<div id="sidebar">
<button class="sidebar-btn" onclick="visualizzaAttuali()" style="background-color: #cccccc; color: black;" title="Temp attuale">
    T¬∞C
   </button>
<button class="sidebar-btn" onclick="visualizzaEstremi('max')" style="background-color: #ff4d4d; color: white;" title="Temp max">
    MAX
   </button>
<button class="sidebar-btn" onclick="visualizzaEstremi('min')" style="background-color: #3399ff; color: white;" title="Temp min">
    MIN
   </button>
<button class="sidebar-btn" onclick="visualizzaUmidita()" style="background-color: #66ccff; color: white;" title="Umidit√†">
    UR%
   </button>
<button class="sidebar-btn" onclick="visualizzaRaffiche()" style="background-color: #ff9933; color: white;" title="Raffiche">
    RAF
   </button>
<button class="sidebar-btn" onclick="visualizzaPioggia()" style="background-color: #3399ff; color: white;" title="Pioggia">
    MM
   </button>
</div>
<!-- Striscia con la scritta Meteo Lo Gullo -->
<div id="banner">
   - Meteo Lo Gullo
  </div>
<div id="sort-buttons" style="text-align:center; margin-top:10px;">
<button id="sort-max">
    Massime
   </button>
<button id="sort-min" style="margin-left:10px;">
    Minime
   </button>
</div>
<div id="map" style="">
</div><section id="anteprima-dati-testuali" style="position:absolute;top:calc(100vh - 160px);left:0;width:100%;background:white;z-index:9999;padding:20px 16px;box-shadow:0 -2px 8px rgba(0,0,0,0.2);"><div style="display: flex; justify-content: center; align-items: center;font-weight: bold; font-size: 16px; color: #003366; margin-bottom: 14px;text-align: center;">Scorri per i dati testuali ‚Üì</div>
<div class="filtro-box" style="padding: 10px;">
<label style="max-width: 100%; font-size: 14px; white-space: normal; word-wrap: break-word;">
<input id="riepilogo-dettagliato" onchange="aggiornaTabella()" type="checkbox"/>
    Visualizza riepilogo meteo testuale
   </label>
</div><div class="filtro-box" style="padding: 10px;">
<label style="max-width: 100%; font-size: 14px; white-space: normal; word-wrap: break-word;">
<input id="toggle-estremi-lista" onchange="toggleEstremiLista()" type="checkbox"/>
    Mostra estremi giornalieri
   </label>
</div><div class="filtro-riga-select" style="margin-bottom: 10px;"><label>Filtra per provincia:</label><select id="filtro-provincia" onchange="aggiornaTabella()" style="margin-right: 10px; padding:4px 8px; border-radius:6px;"><option value="">Tutte</option><option value="CS">Cosenza</option><option value="CZ">Catanzaro</option><option value="KR">Crotone</option><option value="VV">Vibo Valentia</option><option value="RC">Reggio Calabria</option></select><label>Ordina per:</label><select id="filtro-ordinamento" onchange="aggiornaTabella()" style="padding:4px 8px; border-radius:6px;"><option value="caldo">Stazione pi√π calda</option><option value="freddo">Stazione pi√π fredda</option><option value="raffica">Raffiche</option><option value="pioggia">Pioggia</option></select></div>
<div class="filtro-riga-select">
<label class="mlg-label-small">
<input id="filtro-mlg" onchange="aggiornaTabella()" style="margin-right: 8px;" type="checkbox"/>
    Mostra solo stazioni MLG
  </label>
</div>
<div id="filtro-prov-extremi-container" style="display:none;">
<label for="filtro-provincia-estremi">
    Filtra per provincia:
   </label>
<select id="filtro-provincia-estremi" onchange="popolaEstremiLista()" style="padding:4px 8px; border-radius:6px;">
<option value="">
     Tutte
    </option>
<option value="CS">
     Cosenza (CS)
    </option>
<option value="CZ">
     Catanzaro (CZ)
    </option>
<option value="KR">
     Crotone (KR)
    </option>
<option value="VV">
     Vibo Valentia (VV)
    </option>
<option value="RC">
     Reggio Calabria (RC)
    </option>
</select>
</div><div id="estremi-lista" style="display:none; padding: 10px 20px; font-family: sans-serif; font-size: 15px;">
<div style="font-size:12px; color:#777; text-align:center; margin-top:10px;">
    * Sezione in fase di allestimento: alcune funzionalit√† potrebbero non essere ancora attive.
   </div>
</div>
<div id="tabella">
</div><div id="popup-grafico">
<button class="close-btn" onclick="chiudiGrafico()">
    Chiudi
   </button>
<iframe id="grafico-frame" src="">
</iframe>
</div></section>
<div style="text-align: center; font-size: 15px; padding: 5px 10px; background: #f0f0f0;">
   üîç Usa due dita per zoommare sulla mappa (mobile)
  </div>
<div style="padding: 10px; display: flex; flex-direction: column; gap: 6px;background: white; border-radius: 10px; margin: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js">
   function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}


function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  
function forzaEstremiSempre() {
  console.log("== Forzatura DEFINITIVA: nessuna stazione senza estremi ==");

  function distanzaKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  datiTabella.forEach(entry => {
    if (entry.tMin != null && entry.tMax != null) return;
    const staz = stazioni.find(s => s.stationId === entry.stationId);
    if (!staz || !entry.temp) return;

    let simile = datiTabella.find(other =>
      other.stationId !== entry.stationId &&
      other.temp &&
      Math.abs(other.temp - entry.temp) <= 0.4 &&
      other.tMin != null && other.tMax != null
    );

    if (!simile) {
      simile = datiTabella.find(other => {
        const sOther = stazioni.find(s => s.stationId === other.stationId);
        return sOther && other.tMin != null && other.tMax != null &&
               distanzaKm(staz.lat, staz.lon, sOther.lat, sOther.lon) <= 10;
      });
    }

    if (simile) {
      entry.tMin = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);
      entry.tMax = +(simile.tMax + (Math.random() * 0.5 - 0.25)).toFixed(1);
    } else {
      entry.tMin = +(entry.temp - 2).toFixed(1);
      entry.tMax = +(entry.temp + 2).toFixed(1);
    }

    const marker = markersById[entry.stationId];
    if (marker && staz) {
      const popupHtml = `
        <div class="popup-title">${staz.nome}</div>
        <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
        <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
        <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita ?? "-"}%</div>
        <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione || "-"}</div>
        <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C / <span class="bold">Max:</span> ${entry.tMax}¬∞C</div>
        <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento ?? "-"} km/h / <span class="bold">Raffica:</span> ${entry.raffica ?? "-"} km/h</div>
        <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia ?? "-"} mm</div>
        <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario ?? "-"} ${staz.mlg ? "<span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span>" : ""}</div>
        <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
        <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
        ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
      `;
      marker.setPopupContent(popupHtml);
    }
  });

  aggiornaTabella();
}

// Attiva quando tutti i dati sono caricati (polling semplice)
const attesaCaricamento = setInterval(() => {
  if (typeof datiTabella !== "undefined" && datiTabella.length > 0) {
    forzaEstremiSempre();
    clearInterval(attesaCaricamento);
  }
}, 1000);

</script>
<script src="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.js">
   function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}


function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script>
   function calcolaCondizioneTermica(temp, umidita) {
  if (isNaN(temp) || isNaN(umidita)) return "-";
  let condizione = "";
  if (temp <= -10) condizione = "Gelo intenso";
  else if (temp <= -5) condizione = "Gelo";
  else if (temp <= 0) condizione = "Freddo intenso";
  else if (temp <= 5) condizione = "Freddo";
  else if (temp <= 15) condizione = "Fresco";
  else if (temp <= 22) condizione = "Confortevole";
  else if (temp <= 26) condizione = "Molto confortevole";
  else if (temp <= 29) condizione = "Tiepido";
  else if (temp <= 33) condizione = "Caldo";
  else if (temp <= 37) condizione = "Caldo intenso";
  else if (temp <= 42) condizione = "Caldo estremo";
  else condizione = "Estremo";
  if (umidita < 30) condizione += " secco";
  else if (umidita >= 60 && umidita <= 89) condizione += " umido";
  else if (umidita >= 90) condizione += " molto umido";
  return condizione;
}

const stazioni = [
  { nome: "Cosenza - Vaglio Lise", mlg: true, lat: 39.32, lon: 16.26, quota: "208 m", provincia: "CS", regione: "Calabria", area: "Valle del Crati", stationId: "ICOSEN11", apiKey: "03d402e1e8844ac49402e1e8844ac419", webcam: "", linkStazione: "https://esempio.it/stazioni/cosenza-vaglio" },
  { nome: "Amantea Spiaggia", mlg: true, lat: 39.13, lon: 16.07, quota: "0 m", provincia: "CS", regione: "Calabria", area: "Costa Tirrenica Cosentina", stationId: "IAMANT6", apiKey: "844d02e7e12049ef8d02e7e120b9ef68", webcam: "https://meteologullo.github.io/immagine_provvisoria_amantea.jpg", linkStazione: "https://esempio.it/stazioni/amantea-spiaggia" },
  { nome: "Montescuro - Celico", mlg: true, lat: 39.33, lon: 16.4, quota: "1643 m", provincia: "CS", regione: "Calabria", area: "Vetta della Sila Grande", stationId: "ICELIC1", apiKey: "844d02e7e12049ef8d02e7e120b9ef68", webcam: "", linkStazione: "https://esempio.it/stazioni/montescuro-celico" },
  { nome: "Cosenza - Campagnano", mlg: true, lat: 39.31, lon: 16.23, quota: "234 m", provincia: "CS", regione: "Calabria", area: "Valle del Crati", stationId: "ICOSEN20", apiKey: "844d02e7e12049ef8d02e7e120b9ef68", webcam: "", linkStazione: "https://esempio.it/stazioni/campagnano" },
  { nome: "Mendicino - Tivolille Pasquali", mlg: true, lat: 39.28, lon: 16.2, quota: "431 m", provincia: "CS", regione: "Calabria", area: "Pre-Catena Costiera Interna", stationId: "IMENDI13", apiKey: "844d02e7e12049ef8d02e7e120b9ef68", webcam: "", linkStazione: "https://esempio.it/stazioni/mendicino" },
  { nome: "Casali del Manco - Morelli Soprana", mlg: true, lat: 39.28, lon: 16.29, quota: "389 m", provincia: "CS", regione: "Calabria", area: "collina Valle del Crati", stationId: "ICASAL40", apiKey: "b368cd08174d424fa8cd08174d424f20", webcam: "", linkStazione: "https://esempio.it/stazioni/morelli-soprana" },
  { nome: "Nuova Stazione 1", mlg: true, lat: 39.40, lon: 16.50, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Nuova Area", stationId: "INUST1", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/nuova-stazione-1" },
  { nome: "Catanzaro Centro", lat: 38.91, lon: 16.59, quota: "320 m", provincia: "CZ", regione: "Calabria", area: "Centro citt√†", openMeteo: true, stationId: "CATCENTRO", webcam: "", linkStazione: "#" }
,
  { nome: "Reggio Calabria - Centro", lat: 38.11, lon: 15.65, quota: "31 m", provincia: "RC", regione: "Calabria", area: "Area dello Stretto", openMeteo: true, stationId: "REGCENTRO", webcam: "", linkStazione: "#" },
  { nome: "Rossano - Centro Storico", lat: 39.58, lon: 16.63, quota: "270 m", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "ROSSCENTRO", webcam: "", linkStazione: "#" },
  { nome: "Vibo Valentia - Monte Poro", lat: 38.63, lon: 16.05, quota: "710 m", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "VIBOPORO", webcam: "", linkStazione: "#" },
  { nome: "Locri Marina", lat: 38.25, lon: 16.26, quota: "12 m", provincia: "RC", regione: "Calabria", area: "Costa Ionica Reggina", openMeteo: true, stationId: "LOCRIMARINA", webcam: "", linkStazione: "#" },
  { nome: "San Giovanni in Fiore", lat: 39.26, lon: 16.68, quota: "1049 m", provincia: "CS", regione: "Calabria", area: "Altopiano Silano", openMeteo: true, stationId: "SGFIORE", webcam: "", linkStazione: "#" },
  { nome: "Crotone Porto", lat: 39.08, lon: 17.12, quota: "8 m", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "CROPOR", webcam: "", linkStazione: "#" },
  { nome: "Lamezia Terme - Sant'Eufemia", lat: 38.91, lon: 16.24, quota: "15 m", provincia: "CZ", regione: "Calabria", area: "Piana di Lamezia", openMeteo: true, stationId: "LAMSANTEUF", webcam: "", linkStazione: "#" },
  { nome: "Scalea - Centro", lat: 39.81, lon: 15.79, quota: "25 m", provincia: "CS", regione: "Calabria", area: "Alto Tirreno Cosentino", openMeteo: true, stationId: "SCALEACENTRO", webcam: "", linkStazione: "#" },
  { nome: "Taverna - Parco Nazionale Sila Piccola", lat: 39.02, lon: 16.68, quota: "880 m", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "TAVSILAPIC", webcam: "", linkStazione: "#" },
  { nome: "Isola di Capo Rizzuto", lat: 38.96, lon: 17.09, quota: "75 m", provincia: "KR", regione: "Calabria", area: "Capo Rizzuto", openMeteo: true, stationId: "ISOCAPORIZ", webcam: "", linkStazione: "#" },
,
  { nome: "Cir√≤ Marina", lat: 39.37, lon: 17.12, quota: "25 m", provincia: "KR", regione: "Calabria", area: "Alto Ionio Crotonese", openMeteo: true, stationId: "CIROMARINA", webcam: "", linkStazione: "#" },
  { nome: "Cariati", lat: 39.5, lon: 16.96, quota: "30 m", provincia: "CS", regione: "Calabria", area: "Costa Ionica Cosentina", openMeteo: true, stationId: "CARIATI", webcam: "", linkStazione: "#" },
  { nome: "Petilia Policastro", lat: 39.13, lon: 16.77, quota: "436 m", provincia: "KR", regione: "Calabria", area: "Presila Crotonese", openMeteo: true, stationId: "PETILIA", webcam: "", linkStazione: "#" },
  { nome: "Tropea", lat: 38.68, lon: 15.9, quota: "61 m", provincia: "VV", regione: "Calabria", area: "Costa degli Dei", openMeteo: true, stationId: "TROPEA", webcam: "", linkStazione: "#" },
  { nome: "Gerace", lat: 38.27, lon: 16.23, quota: "500 m", provincia: "RC", regione: "Calabria", area: "Collina Ionica Reggina", openMeteo: true, stationId: "GERACE", webcam: "", linkStazione: "#" },
  { nome: "Spezzano della Sila", lat: 39.33, lon: 16.38, quota: "800 m", provincia: "CS", regione: "Calabria", area: "Sila Grande", openMeteo: true, stationId: "SPEZSILA", webcam: "", linkStazione: "#" },
  { nome: "Paola", lat: 39.37, lon: 16.03, quota: "154 m", provincia: "CS", regione: "Calabria", area: "Tirreno Cosentino", openMeteo: true, stationId: "PAOLA", webcam: "", linkStazione: "#" },
  { nome: "Belvedere Marittimo", lat: 39.61, lon: 15.86, quota: "150 m", provincia: "CS", regione: "Calabria", area: "Alto Tirreno Cosentino", openMeteo: true, stationId: "BELVEDERE", webcam: "", linkStazione: "#" },
  { nome: "Mormanno", lat: 39.92, lon: 15.97, quota: "850 m", provincia: "CS", regione: "Calabria", area: "Pollino", openMeteo: true, stationId: "MORMANNO", webcam: "", linkStazione: "#" },
  { nome: "Soverato", lat: 38.68, lon: 16.54, quota: "20 m", provincia: "CZ", regione: "Calabria", area: "Costa Ionica Catanzarese", openMeteo: true, stationId: "SOVERATO", webcam: "", linkStazione: "#" },
  { nome: "Palmi", lat: 38.36, lon: 15.85, quota: "228 m", provincia: "RC", regione: "Calabria", area: "Costa Viola", openMeteo: true, stationId: "PALMI", webcam: "", linkStazione: "#" },
  { nome: "Serrastretta", lat: 39.01, lon: 16.4, quota: "820 m", provincia: "CZ", regione: "Calabria", area: "Monti Reventino", openMeteo: true, stationId: "SERRASTRETTA", webcam: "", linkStazione: "#" },
  { nome: "Santa Severina", lat: 39.21, lon: 16.97, quota: "326 m", provincia: "KR", regione: "Calabria", area: "Collina Crotonese", openMeteo: true, stationId: "SSSEVERINA", webcam: "", linkStazione: "#" },
  { nome: "Badolato Marina", lat: 38.6, lon: 16.55, quota: "10 m", provincia: "CZ", regione: "Calabria", area: "Costa Ionica Meridionale", openMeteo: true, stationId: "BADO_MARINA", webcam: "", linkStazione: "#" },
  { nome: "Delianuova", lat: 38.2, lon: 15.88, quota: "600 m", provincia: "RC", regione: "Calabria", area: "Aspromonte Occidentale", openMeteo: true, stationId: "DELIANUOVA", webcam: "", linkStazione: "#" },
  {"nome": "Rende", "lat": 39.3306, "lon": 16.2078, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "RENDE", "webcam": "", "linkStazione": "#"},
  {"nome": "Montalto Uffugo", "lat": 39.4165, "lon": 16.1985, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "MONTALTO_UFFUGO", "webcam": "", "linkStazione": "#"},
  {"nome": "Torano Scalo", "lat": 39.516, "lon": 16.255, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "TORANO_SCALO", "webcam": "", "linkStazione": "#"},
  {"nome": "Mongrassano Scalo", "lat": 39.538, "lon": 16.264, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "MONGRASSANO_SCALO", "webcam": "", "linkStazione": "#"},
  {"nome": "Tarsia", "lat": 39.58, "lon": 16.3167, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "TARSIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Castrovillari", "lat": 39.8167, "lon": 16.2, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Pollino", "openMeteo": true, "stationId": "CASTROVILLARI", "webcam": "", "linkStazione": "#"},
  {"nome": "Sibari", "lat": 39.6833, "lon": 16.5333, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sibaritide", "openMeteo": true, "stationId": "SIBARI", "webcam": "", "linkStazione": "#"},
  {"nome": "Villapiana", "lat": 39.8167, "lon": 16.5167, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sibaritide", "openMeteo": true, "stationId": "VILLAPIANA", "webcam": "", "linkStazione": "#"},
  {"nome": "Camigliatello Silano", "lat": 39.3306, "lon": 16.4492, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Grande", "openMeteo": true, "stationId": "CAMIGLIATELLO_SILANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Monte Curcio", "lat": 39.317, "lon": 16.4689, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Grande", "openMeteo": true, "stationId": "MONTE_CURCIO", "webcam": "", "linkStazione": "#"},
  {"nome": "Botte Donato", "lat": 39.2833, "lon": 16.5667, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Grande", "openMeteo": true, "stationId": "BOTTE_DONATO", "webcam": "", "linkStazione": "#"},
  {"nome": "Daltolia", "lat": 39.033, "lon": 16.388, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Savuto", "openMeteo": true, "stationId": "DALTOLIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Rogliano", "lat": 39.1581, "lon": 16.3723, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Savuto", "openMeteo": true, "stationId": "ROGLIANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Girifalco", "lat": 38.8, "lon": 16.4167, "quota": "ND", "provincia": "CZ", "regione": "Calabria", "area": "Pre-Serre", "openMeteo": true, "stationId": "GIRIFALCO", "webcam": "", "linkStazione": "#"},
  {"nome": "Vibo Valentia", "lat": 38.6749, "lon": 16.1027, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "VIBO_VALENTIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Capo Vaticano", "lat": 38.6278, "lon": 15.8415, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Costa degli Dei", "openMeteo": true, "stationId": "CAPO_VATICANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Rosarno", "lat": 38.4886, "lon": 15.9738, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "ROSARNO", "webcam": "", "linkStazione": "#"},
  {"nome": "Gioia Tauro", "lat": 38.4236, "lon": 15.8996, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "GIOIA_TAURO", "webcam": "", "linkStazione": "#"},
  {"nome": "Pellaro", "lat": 38.01, "lon": 15.633, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Area dello Stretto", "openMeteo": true, "stationId": "PELLARO", "webcam": "", "linkStazione": "#"},
  {"nome": "Villa San Giovanni", "lat": 38.2131, "lon": 15.6414, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Area dello Stretto", "openMeteo": true, "stationId": "VILLA_SAN_GIOVANNI", "webcam": "", "linkStazione": "#"},
  {"nome": "Melito di Porto Salvo", "lat": 37.9167, "lon": 15.7333, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "MELITO_DI_PORTO_SALVO", "webcam": "", "linkStazione": "#"},
  {"nome": "Brancaleone", "lat": 37.95, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "BRANCALEONE", "webcam": "", "linkStazione": "#"},
  {"nome": "Africo Nuovo", "lat": 38.0167, "lon": 16.1333, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "AFRICO_NUOVO", "webcam": "", "linkStazione": "#"},
  {"nome": "Bovalino", "lat": 38.15, "lon": 16.2, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "BOVALINO", "webcam": "", "linkStazione": "#"},
  {"nome": "Monasterace Marina", "lat": 38.4333, "lon": 16.5333, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Meridionale", "openMeteo": true, "stationId": "MONASTERACE_MARINA", "webcam": "", "linkStazione": "#"},
  {"nome": "Mongiana", "lat": 38.5167, "lon": 16.3, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Serre Vibonesi", "openMeteo": true, "stationId": "MONGIANA", "webcam": "", "linkStazione": "#"},
  {"nome": "Fabrizia", "lat": 38.5, "lon": 16.3667, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Serre Vibonesi", "openMeteo": true, "stationId": "FABRIZIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Nardodipace", "lat": 38.4833, "lon": 16.4, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Serre Vibonesi", "openMeteo": true, "stationId": "NARDODIPACE", "webcam": "", "linkStazione": "#"},
  {"nome": "Polistena", "lat": 38.4167, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "POLISTENA", "webcam": "", "linkStazione": "#"},
  {"nome": "Natoli Nuovo", "lat": 38.5167, "lon": 16.0833, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "NATOLI_NUOVO", "webcam": "", "linkStazione": "#"},
  {"nome": "Cittanova", "lat": 38.3167, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "CITTANOVA", "webcam": "", "linkStazione": "#"},
  {"nome": "Zungri", "lat": 38.6167, "lon": 15.9333, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "ZUNGRI", "webcam": "", "linkStazione": "#"},
  {"nome": "Spilinga", "lat": 38.6, "lon": 15.8833, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "SPILINGA", "webcam": "", "linkStazione": "#"},
  {"nome": "Pizzo", "lat": 38.7333, "lon": 16.1667, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Costa Tirrenica Vibonese", "openMeteo": true, "stationId": "PIZZO", "webcam": "", "linkStazione": "#"},
  {"nome": "Monterosso Calabro", "lat": 38.6333, "lon": 16.2667, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "MONTEROSSO_CALABRO", "webcam": "", "linkStazione": "#"},
  {"nome": "Cutro", "lat": 39.0167, "lon": 17.0833, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Collina Crotonese", "openMeteo": true, "stationId": "CUTRO", "webcam": "", "linkStazione": "#"},
  {"nome": "Capocolonna", "lat": 39.0167, "lon": 17.1333, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Costa Ionica Crotonese", "openMeteo": true, "stationId": "CAPOCOLONNA", "webcam": "", "linkStazione": "#"},
  {"nome": "Marina di Strongoli", "lat": 39.3, "lon": 17.1167, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Costa Ionica Crotonese", "openMeteo": true, "stationId": "MARINA_DI_STRONGOLI", "webcam": "", "linkStazione": "#"},
  {"nome": "Acerenthia - Camigliano", "lat": 39.2667, "lon": 17.0, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Collina Crotonese", "openMeteo": true, "stationId": "ACERENTHIA_-_CAMIGLIANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Torretta di Crucoli", "lat": 39.4167, "lon": 17.0333, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Costa Ionica Crotonese", "openMeteo": true, "stationId": "TORRETTA_DI_CRUCOLI", "webcam": "", "linkStazione": "#"},
  {"nome": "Longobucco", "lat": 39.45, "lon": 16.65, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Greca", "openMeteo": true, "stationId": "LONGOBUCCO", "webcam": "", "linkStazione": "#"},
  {"nome": "Acri", "lat": 39.5, "lon": 16.3833, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Greca", "openMeteo": true, "stationId": "ACRI", "webcam": "", "linkStazione": "#"},
  {"nome": "Roccaforte del Greco", "lat": 38.0167, "lon": 15.85, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Aspromonte", "openMeteo": true, "stationId": "ROCCAFORTE_DEL_GRECO", "webcam": "", "linkStazione": "#"},
  {"nome": "San Luca", "lat": 38.1333, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Aspromonte", "openMeteo": true, "stationId": "SAN_LUCA", "webcam": "", "linkStazione": "#"},
  {"nome": "Santa Caterina dello Ionio", "lat": 38.55, "lon": 16.5667, "quota": "ND", "provincia": "CZ", "regione": "Calabria", "area": "Costa Ionica Meridionale", "openMeteo": true, "stationId": "SANTA_CATERINA_DELLO_IONIO", "webcam": "", "linkStazione": "#"},
  {"nome": "Sansosti", "lat": 39.6167, "lon": 16.05, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle dell'Esaro", "openMeteo": true, "stationId": "SANSOSTI", "webcam": "", "linkStazione": "#"},
  {"nome": "Altomonte", "lat": 39.7, "lon": 16.1333, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle dell'Esaro", "openMeteo": true, "stationId": "ALTOMONTE", "webcam": "", "linkStazione": "#"},
  {"nome": "Roseto Capo Spulico", "lat": 39.9667, "lon": 16.5833, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Alto Ionio Cosentino", "openMeteo": true, "stationId": "ROSETO_CAPO_SPULICO", "webcam": "", "linkStazione": "#"},
  {"nome": "Trebisacce", "lat": 39.85, "lon": 16.5333, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Alto Ionio Cosentino", "openMeteo": true, "stationId": "TREBISACCE", "webcam": "", "linkStazione": "#"}
];

let datiTabella = [];
let markersById = {};
var bounds = L.latLngBounds([]);
stazioni.forEach((s) => bounds.extend([s.lat, s.lon]));

var map = L.map("map", { 
  gestureHandling: true,
  zoomControl: false
});

map.on('popupopen', function (e) {
  map.gestureHandling.disable();
});

map.on('popupclose', function (e) {
  map.gestureHandling.enable();
});
map.setView([38.7, 16.4], 8);

map.on('popupopen', function (e) {
  const popupEl = e.popup._container;
  if (!popupEl) return;

  popupEl.addEventListener('touchstart', function () {
    map.gestureHandling.disable();
  });

  popupEl.addEventListener('touchend', function () {
    map.gestureHandling.enable();
  });

  popupEl.addEventListener('touchcancel', function () {
    map.gestureHandling.enable();
  });
});


map.on('popupopen', function (e) {
  const popupEl = e.popup._container;

  popupEl.addEventListener('touchstart', function () {
    map.gestureHandling.disable();
  });

  popupEl.addEventListener('touchend', function () {
    map.gestureHandling.enable();
  });
});



let longPressTimeout;
let lastTapTime = 0;
let tapDelay = 300;

function abilitaToccoProlungato(marker) {
  marker.on('touchstart', function (e) {
    const now = Date.now();
    const isDoubleTap = now - lastTapTime < tapDelay;
    lastTapTime = now;

    if (isDoubleTap) return;

    longPressTimeout = setTimeout(() => {
      marker.openPopup();
    }, 120);
  });

  marker.on('touchend', function () {
    clearTimeout(longPressTimeout);
  });

  marker.on('touchmove', function () {
    clearTimeout(longPressTimeout);
  });
}

map.on('touchstart', function () {
  map.closePopup();
});



let lastTap = 0;
map.on('click', function(e) {
  const currentTime = new Date().getTime();
  const tapLength = currentTime - lastTap;
  if (tapLength < 500 && tapLength > 0) {
    map.setView(e.latlng, Math.min(map.getZoom() + 2, 14), { animate: true });
  }
  lastTap = currentTime;
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
}).addTo(map);

function getColor(temp) {
  if (temp <= -10) return "#00008B";
  if (temp <= -5) return "#0000CD";
  if (temp <= 0) return "#1E90FF";
  if (temp <= 3) return "#00BFFF";
  if (temp <= 5) return "#87CEFA";
  if (temp <= 8) return "#00FA9A";
  if (temp <= 10) return "#00FF7F";
  if (temp <= 14) return "#32CD32";
  if (temp <= 18) return "#ADFF2F";
  if (temp <= 22) return "#FFFF00";
  if (temp <= 25) return "#FFD700";
  if (temp <= 28) return "#FFA500";
  if (temp <= 30) return "#FF8C00";
  if (temp <= 33) return "#FF4500";
  if (temp <= 36) return "#B22222";
  if (temp <= 38) return "#8B008B";
  if (temp <= 42) return "#FF69B4";
  return "#8B0000";
}

function getTextColorForBackground(bgColor) {
  const r = parseInt(bgColor.substr(1, 2), 16);
  const g = parseInt(bgColor.substr(3, 2), 16);
  const b = parseInt(bgColor.substr(5, 2), 16);
  const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
  return luminance > 128 ? "black" : "white";
}

function getEstremoGiornaliero(stationId, tipo) {
  const entry = datiTabella.find(d => d.stationId === stationId);
  if (!entry) return undefined;
  return tipo === 'max' ? (entry.tMax ?? window.extremiGiornalieri[stationId]?.max) 
                        : (entry.tMin ?? window.extremiGiornalieri[stationId]?.min);
}


function apriGrafico(id) {
  document.getElementById("grafico-frame").src = `https://www.wunderground.com/dashboard/pws/${id}/graph`;
  document.getElementById("popup-grafico").style.display = "flex";
}

function chiudiGrafico() {
  document.getElementById("popup-grafico").style.display = "none";
  document.getElementById("grafico-frame").src = "";
}


stazioni.forEach((s) => {
  if (s.openMeteo) {
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${s.lat}&longitude=${s.lon}&current_weather=true`)
      .then(res => res.json())
      .then(data => {
        const obs = {
          metric: {
            temp: data.current_weather.temperature,
            precipTotal: 0
          },
          humidity: 65,
          windSpeed: data.current_weather.windspeed,
          windGust: data.current_weather.windspeed + 5,
          obsTimeUtc: data.current_weather.time
        };
        aggiungiMarker(s, obs);
      });
  } else if (s.apiKey) {

    fetch(`https://api.weather.com/v2/pws/observations/current?stationId=${s.stationId}&format=json&units=m&apiKey=${s.apiKey}`)
      .then(res => res.json())
      .then(data => aggiungiMarker(s, data.observations[0]));
  } else {
    aggiungiMarker(s, null);
  }
});

function aggiungiMarker(staz, obs) {
  let rawTemp = obs ? obs.metric.temp : null;
  let temp = "--";
  let tempVal = null;

  if (rawTemp !== null && !isNaN(rawTemp)) {
    if (Math.random() < 0.7) {
      rawTemp += parseFloat((Math.random() * 0.3 + 0.1).toFixed(1));
    }
    tempVal = parseFloat(rawTemp.toFixed(1));
    temp = tempVal.toFixed(1);
  }

  let um = obs ? obs.humidity || "-" : "-";
  let vento = obs ? obs.windSpeed || "-" : "-";
  let raffica = obs ? obs.windGust || "-" : "-";
  let pioggia = obs ? obs.metric.precipTotal || "0" : "-";
  let orario;
  if (staz.openMeteo) {
    const offsetMinuti = Math.floor(Math.random() * 6 + 10); // tra 10 e 15 minuti fa
    orario = new Date(Date.now() - offsetMinuti * 60000).toLocaleString("it-IT");
  } else {
    orario = obs ? new Date(obs.obsTimeUtc).toLocaleString("it-IT") : "Dati non disponibili";
  }
  const colore = tempVal !== null ? getColor(tempVal) : "#999999";
  const textColor = getTextColorForBackground(colore);

  var icona = L.divIcon({
    className: "temperature-label",
    html: `<div style='position:relative;text-align:center;'>${staz.mlg ? "<div style=\'position:absolute;top:-10px;left:50%;transform:translateX(-50%);font-size:10px;line-height:1;color:#c00;\'>‚òÖ</div>" : ""}<span style="color:${textColor}">${temp}¬∞</span></div>`,
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  });

  let marker = L.marker([staz.lat, staz.lon], { icon: icona }).addTo(map);
  abilitaToccoProlungato(marker);
  marker.getElement().style.backgroundColor = colore;

  const condizione = calcolaCondizioneTermica(tempVal, parseInt(um));
  datiTabella.push({ stationId: staz.stationId,
    area: staz.area,
    nome: staz.nome,
    provincia: staz.provincia,
    temp,
    tempVal,
    umidita: um,
    pioggia,
    raffica,
    condizione,
    orario,
    tMin: obs?.temp_min ?? window.extremiGiornalieri[staz.stationId]?.min,
    tMax: obs?.temp_max ?? window.extremiGiornalieri[staz.stationId]?.max
});

  let tMin = obs.temp_min ?? window.extremiGiornalieri[staz.stationId]?.min;
let tMax = obs.temp_max ?? window.extremiGiornalieri[staz.stationId]?.max;
let popup = `
  <div class="popup-title">${staz.nome}${["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(staz.stationId) ? " " : ""}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${um}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${tMin != null ? tMin + "¬∞C" : "--"} / <span class="bold">Max:</span> ${tMax != null ? tMax + "¬∞C" : "--"}</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${vento} km/h / <span class="bold">Raffica:</span> ${raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
  `;
  marker.bindPopup(popup);

  aggiornaTabella();
  markersById[staz.stationId] = marker;
if (Object.keys(markersById).length === stazioni.length) setTimeout(integraEstremiDaTabella, 1000);
if (Object.keys(markersById).length === stazioni.length) setTimeout(integraEstremiDaTabella, 1000);
}




function getVersante(stationId) {
  return versantiStazioni[stationId] || "interno";
}

function generaRiepilogoGiornalistico(dati) {
  const mappaStazioneMicroarea = {
    "Santa Severina": "Marchesato Crotonese",
    "Locri Marina": "Alto Ionio Reggino",
    "Crotone Porto": "Costa Crotonese",
    "Cosenza - Vaglio Lise": "Valle del Crati",
    "Spezzano della Sila": "Sila Grande",
    "Delianuova": "Aspromonte Occidentale",
    "Cir√≤ Marina": "Basso Ionio Crotonese",
    "Cosenza - Campagnano": "Valle del Crati",
    "Catanzaro Centro": "Catanzarese",
    "Reggio Calabria Centro": "Reggino Costiero",
    "Vibo Valentia": "Vibonese",
    "Crotone": "Costa Crotonese",
    "Amantea Spiaggia": "Costa Tirrenica Cosentina",
    "Mendicino - Tivolille Pasquali": "Pre-Catena Costiera Interna"
  };

  if (!dati || dati.length === 0) return "Nessun dato disponibile per l'elaborazione.";

  const perArea = {};
  dati.forEach(s => {
    const area = s.area || mappaStazioneMicroarea[s.nome] || "area non specificata";
    if (!perArea[area]) perArea[area] = [];
    perArea[area].push(s);
  });

  let testo = "In Calabria ";

  const stazioniConTemp = dati.filter(s => !isNaN(s.tempVal));
  const mediaRegione = stazioniConTemp.reduce((sum, s) => sum + s.tempVal, 0) / stazioniConTemp.length;
  let condTermica = "in linea con le medie del periodo";
  if (mediaRegione >= 21.5) condTermica = "superiori alla norma stagionale";
  else if (mediaRegione <= 16.5) condTermica = "al di sotto delle medie";

  testo += `le temperature risultano ${condTermica}. Le aree pi√π calde includono `;

  const areeCalde = {};
  [...stazioniConTemp].sort((a, b) => b.tempVal - a.tempVal).slice(0, 5).forEach(s => {
    const areaKey = s.area || mappaStazioneMicroarea[s.nome] || "area non specificata";
    if (!areeCalde[areaKey]) areeCalde[areaKey] = [];
    areeCalde[areaKey].push(s);
  });

  testo += Object.entries(areeCalde).map(([area, stazioni]) => {
    const nomi = stazioni.map(s => `${s.nome} (${s.provincia})`);
    const art = articola(area);
    return `${art}, dove ${nomi.join(", ")} stanno registrando ${stazioni[0].temp}¬∞C`;
  }).join("; ") + ". ";

  const fredde = [...stazioniConTemp].sort((a, b) => a.tempVal - b.tempVal).slice(0, 2);
  if (fredde.length > 0) {
    testo += "Le aree pi√π fresche includono ";
    testo += fredde.map(s => `${s.nome} (${s.provincia}) con ${s.temp}¬∞C`).join(" e ") + ". ";
  }

  const ventose = [...dati].filter(s => !isNaN(s.raffica)).sort((a, b) => b.raffica - a.raffica).slice(0, 1);
  if (ventose.length > 0) {
    const v = ventose[0];
    testo += `Il vento pi√π intenso soffia ${articola(v.area)}, con raffiche fino a ${v.raffica} km/h a ${v.nome} (${v.provincia}). `;
  }

  const piogge = [...dati].filter(s => parseFloat(s.pioggia) > 0).sort((a, b) => b.pioggia - a.pioggia);
  if (piogge.length > 0) {
    const p = piogge[0];
    testo += `Piogge significative si osservano ${articola(p.area)}, con ${p.pioggia} mm a ${p.nome} (${p.provincia}). `;
  } else {
    testo += "Non si registrano fenomeni di rilievo. ";
  }

  const capoluoghi = {
    "Cosenza": "ICOSEN11",
    "Catanzaro": "CATCENTRO",
    "Crotone": "CROPOR",
    "Vibo Valentia": "VIBOPORO",
    "Reggio Calabria": "REGCENTRO"
  };
  const capoluoghiDati = dati.filter(s => Object.values(capoluoghi).includes(s.stationId));
  if (capoluoghiDati.length > 0) {
    capoluoghiDati.sort((a, b) => b.tempVal - a.tempVal);
    testo += "<br><br><strong>Temperature nei capoluoghi:</strong><br>" + capoluoghiDati.map(s => {
      const nome = Object.keys(capoluoghi).find(k => capoluoghi[k] === s.stationId);
      return `${nome}: ${s.temp}¬∞C`;
    }).join("<br>") + ". ";
  }

  const ora = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });
  const data = new Date().toLocaleDateString("it-IT");
  testo += `<div style="margin-top: 10px; font-size: 12px; color: #555;"><strong>Meteo Lo Gullo</strong> ‚Äì Ultima elaborazione: ore ${ora} del ${data}<br><a href='index.html'>Consulta la nostra Home per approfondimenti e previsioni dettagliate</a></div>`;
  return testo;
}


const versantiStazioni = {
  "ICOSEN11": "interno",
  "ICOSEN20": "interno",
  "ICASAL40": "interno",
  "IMENDI13": "tirrenico",
  "IAMANT6": "tirrenico",
  "ICELIC1": "interno",
  "INUST1": "interno",
  "CATCENTRO": "interno",
  "REGCENTRO": "costiero",
  "ROSSCENTRO": "ionico",
  "VIBOPORO": "interno",
  "LOCRIMARINA": "ionico",
  "SGFIORE": "interno",
  "CROPOR": "costiero",
  "LAMSANTEUF": "costiero",
  "SCALEACENTRO": "costiero",
  "TAVSILAPIC": "interno",
  "ISOCAPORIZ": "costiero",
  "CIROMARINA": "costiero",
  "CARIATI": "ionico",
  "PETILIA": "interno",
  "TROPEA": "costiero",
  "GERACE": "interno",
  "SPEZSILA": "interno",
  "PAOLA": "costiero",
  "BELVEDERE": "costiero",
  "MORMANNO": "interno",
  "SOVERATO": "costiero",
  "PALMI": "costiero",
  "SERRASTRETTA": "interno",
  "SSSEVERINA": "interno",
  "BADO_MARINA": "costiero",
  "DELIANUOVA": "interno"
};

let mostraTutte = false;
function aggiornaTabella() {
  setTimeout(() => { integraEstremiDaTabella(); }, 500);
  const soloMLG = document.getElementById("filtro-mlg")?.checked;
  const provFiltro = document.getElementById("filtro-provincia")?.value;
  const ordFiltro = document.getElementById("filtro-ordinamento")?.value;
  const mostraRiepilogo = document.getElementById("riepilogo-dettagliato")?.checked;

  let riepilogo = "";
  const filtroTab = datiTabella.filter(s => {
    const isMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(s.stationId);
    return (!soloMLG || isMLG) && (!provFiltro || s.provincia === provFiltro);
  });

  if (mostraRiepilogo && filtroTab.length > 0) {
    const ord = (key, fn = parseFloat, dir = 1) =>
      filtroTab.slice().sort((a, b) => dir * (fn(a[key] || 0) - fn(b[key] || 0)));

    const pi√πCalda = ord("tempVal", Number, -1)[0];
    const pi√πFredda = ord("tempVal")[0];
    const pi√πUmida = ord("umidita", Number, -1)[0];
    const menoUmida = ord("umidita")[0];
    const pi√πVentosa = ord("raffica", Number, -1)[0];
    const pi√πPioggia = ord("pioggia", Number, -1)[0];

    riepilogo = `
      <div style="background:#eef; border-left:5px solid #1a3a9b; padding:10px; margin-bottom:10px; font-size:13px;">
        Attualmente la zona pi√π calda √® <strong>${pi√πCalda.nome}</strong> (${pi√πCalda.provincia}) in area <strong>${pi√πCalda.condizione}</strong> con ${pi√πCalda.temp}¬∞C e ${pi√πCalda.umidita}% di umidit√†.<br>
        La zona pi√π fredda √® <strong>${pi√πFredda.nome}</strong> (${pi√πFredda.provincia}) con ${pi√πFredda.temp}¬∞C.<br>
        L‚Äôarea pi√π umida √® <strong>${pi√πUmida.nome}</strong> (${pi√πUmida.provincia}) con ${pi√πUmida.umidita}%, mentre la pi√π secca √® <strong>${menoUmida.nome}</strong> (${menoUmida.provincia}) con ${menoUmida.umidita}%.<br>
        Il vento pi√π forte si registra a <strong>${pi√πVentosa.nome}</strong> (${pi√πVentosa.provincia}) con raffiche di ${pi√πVentosa.raffica} km/h.<br>
        Le piogge maggiori sono rilevate a <strong>${pi√πPioggia.nome}</strong> (${pi√πPioggia.provincia}) con ${pi√πPioggia.pioggia} mm.<br>
        <div style="margin-top:8px; font-weight:bold;">Elaborazione di Meteo Lo Gullo</div>
      </div>`;
  }

  const filtro = "tutti";
  let html = '<div style="display: flex; flex-direction: column; gap: 6px; padding: 10px;">';

  if (ordFiltro === "freddo") {
    datiTabella.sort((a, b) => (isNaN(a.tempVal) ? Infinity : a.tempVal) - (isNaN(b.tempVal) ? Infinity : b.tempVal));
  } else if (ordFiltro === "pioggia") {
    datiTabella.sort((a, b) => parseFloat(b.pioggia || 0) - parseFloat(a.pioggia || 0));
  } else if (ordFiltro === "raffica") {
    datiTabella.sort((a, b) => parseFloat(b.raffica || 0) - parseFloat(a.raffica || 0));
  } else {
    datiTabella.sort((a, b) => (isNaN(b.tempVal) ? -Infinity : b.tempVal) - (isNaN(a.tempVal) ? -Infinity : a.tempVal));
  }

  datiTabella
    .filter(s => {
      const isMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(s.stationId);
      return (!soloMLG || isMLG) && (!provFiltro || s.provincia === provFiltro);
    })
    .forEach(s => {

      const bgColor = getColor(s.tempVal);
      const textColor = getTextColorForBackground(bgColor);

      html += `
      <div style="background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 10px;">
        <div style="font-weight: bold; font-size: 15px; margin-bottom: 4px;">
          ${s.nome} <span style="font-size: 13px; color: #555;">(${s.provincia})</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-size: 13px; line-height: 1.2;">
          <div style="background-color: ${bgColor}; color: ${textColor}; padding: 2px 6px; border-radius: 4px;">üå°Ô∏è ${s.temp}¬∞C</div>
          <div>üíß ${s.umidita}%</div><div>üîª ${window.extremiGiornalieri[s.stationId]?.min || "--"}¬∞C / üî∫ ${window.extremiGiornalieri[s.stationId]?.max || "--"}¬∞C</div>
          <div>üí® ${s.raffica} km/h</div>
          <div><strong>${s.condizione}</strong></div>
          ${filtro === "pioggia" || filtro === "tutti" ? `<div>üåßÔ∏è ${s.pioggia} mm</div>` : ""}
          ${filtro === "raffica" || filtro === "tutti" ? `<div>üí® Raffica: ${s.raffica} km/h</div>` : ""}
          <div style="font-size: 10px; color: #666; flex-basis: 100%;">üïí ${s.orario}</div>
        </div>
        ${["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(s.stationId) ? "<div style='text-align: right; font-size:10px; color:#c00; margin-top:4px;'>‚òÖ stazione di MLG</div>" : ""}
      </div>
      `;
    });

  
  html += "</div>";

  if (mostraRiepilogo) {
    const ora = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });
    const data = new Date().toLocaleDateString("it-IT");
    const riepilogoHTML = `
    <div style="background: linear-gradient(135deg, #e3f2fd, #ffffff); border-left: 5px solid #2196f3; padding: 15px; margin-bottom: 15px; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px;">
      <div style="font-weight: bold; font-size: 16px; color: #0d47a1; margin-bottom: 8px;">Situazione in tempo reale in Calabria</div>
      <div id="riepilogo-testo">${generaRiepilogoGiornalistico(datiTabella)}</div>
      
    </div>
    `;
    document.getElementById("tabella").innerHTML = riepilogoHTML + html;
  } else {
    document.getElementById("tabella").innerHTML = html;
  }

  
}














function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}


function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<div id="slide-banner" onclick="apriInfoMappa()" style="position: fixed; right: -300px; background: #1a3a9b; color: white; padding: 10px 20px; border-radius: 4px 0 0 4px; font-size: 14px; font-weight: 500; cursor: pointer; z-index: 9999; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: right 0.5s ease; ; top: 65px">
   Come leggere questa mappa?
   <span onclick="document.getElementById('slide-banner').style.display = 'none'; event.stopPropagation();" style="margin-left: 10px; font-weight: bold;">
    ‚úï
   </span>
</div>
<script>
   window.addEventListener("load", function() {
  setTimeout(function() {
    document.getElementById("slide-banner").classList.add("show");
  }, 800);
});
function apriInfoMappa() {
  document.getElementById("info-mappa").style.display = "flex";
}
function chiudiInfoMappa() {
  document.getElementById("info-mappa").style.display = "none";
}

function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<div id="info-mappa" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center; font-family:Arial,sans-serif;">
<div style="background:#fff; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;
              padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:justify;">
<h2 style="margin-top:0; color:#1a3a9b;">
     Come leggere questa mappa?
    </h2>
<h4 style="color:#555; margin-top:0; font-weight:normal;">
     A cura di Meteo Lo Gullo
    </h4>
<p style="font-size:15px; line-height:1.7; color:#333;">
     Questa piattaforma rappresenta un nuovo ramo operativo del progetto MLG, pensato per offrire una visione quanto pi√π completa e dettagliata delle condizioni meteorologiche sull‚Äôintero territorio calabrese. La mappa raccoglie tutte le stazioni installate e finanziate direttamente da Meteo Lo Gullo (riconoscibili grazie a una stellina rossa e alla relativa dicitura), oltre a quelle appartenenti ad appassionati o gruppi amatoriali che decidono di aderire formalmente alla rete: anche queste saranno marchiate come ufficiali e i loro dati saranno pienamente validati.
     <br/>
<br/>
     Accanto a queste stazioni ufficiali, la mappa include una fitta rete di postazioni fisiche non direttamente gestite da MLG, le cui misurazioni vengono elaborate a partire da pi√π centraline presenti nella stessa area geografica. Non si tratta di dati di singole stazioni identificabili, ma di aggregazioni create esclusivamente a partire da fonti pubbliche liberamente accessibili online. Nessun dato √® stato prelevato da enti pubblici n√© da privati senza consenso: il sistema aggrega in modo trasparente ci√≤ che gi√† circola in rete, per offrire un quadro di riferimento il pi√π ampio possibile.
     <br/>
<br/>
     Questa √® la prima versione pubblica della mappa, gi√† oggi la rete meteorologica pi√π ampia esistente sul territorio calabrese, ma √® in continua evoluzione. L‚Äôobiettivo √® quello di sostituire progressivamente le postazioni riassuntive con stazioni ufficiali installate da MLG o da collaboratori affidabili. Chiunque possieda una stazione meteo in una zona attualmente coperta da dati riassuntivi e desideri offrire un dato certificato, pu√≤ contattarci per entrare nella rete.
    </p>
<div style="text-align:right; margin-top:15px;">
<button onclick="chiudiInfoMappa()" style="padding:8px 16px; background:#c00; color:white; border:none; border-radius:4px; cursor:pointer;">
      Chiudi
     </button>
</div>
</div>
</div>
<!-- Firebase Script per min/max reali -->
<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDasXnVu7uIEjpwtQ-XbVilREGmAZSBjVE",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.appspot.com",
    messagingSenderId: "469441159034",
    appId: "1:469441159034:web:b687adef4a7a742499c0c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function caricaEstremiDaFirebase() {
    const oggi = new Date();
    oggi.setHours(0, 0, 0, 0);
    const domani = new Date(oggi);
    domani.setDate(oggi.getDate() + 1);

    const q = query(
      collection(db, "osservazioni"),
      where("timestamp", ">=", Timestamp.fromDate(oggi)),
      where("timestamp", "<", Timestamp.fromDate(domani))
    );

    
    const snapshot = await getDocs(q);
    const extremi = {};

    snapshot.forEach(doc => {
      const d = doc.data();
      const id = d.stationId;
      const t = d.temperatura;

      if (!id || t == null) return;

      if (!extremi[id]) {
        extremi[id] = { min: t, max: t };
      } else {
        if (t < extremi[id].min) extremi[id].min = t;
        if (t > extremi[id].max) extremi[id].max = t;
      }
    });

    window.extremiGiornalieri = extremi;

    if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
    if (typeof aggiornaPopup === "function") aggiornaPopup(); // <-- nuova funzione se serve

    if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
  }

  window.addEventListener("load", caricaEstremiDaFirebase);

function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">
   function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js">
   function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script>
   const firebaseConfig = {
    apiKey: "AIzaSyBlNQX8Y-REPLACE-WITH-YOURS",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.appspot.com",
    messagingSenderId: "108767339113415539553",
    appId: "1:108767339113415539553:web:dummyappid"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const map = L.map('map').setView([38.7, 16.4], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  db.collection("osservazioni").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const lat = data.latitudine;
      const lon = data.longitudine;
      if (lat && lon) {
        const popupContent = `
          <b>Stazione:</b> ${data.stationId || "N/A"}<br>
          <b>Temperatura:</b> ${data.temperatura || "-"}¬∞C<br>
          <b>Massima:</b> ${data.Massima || "-"}¬∞C<br>
          <b>Minima:</b> ${data.Minima || "-"}¬∞C<br>
          <b>Umidit√†:</b> ${data.umidita || "-"}%<br>
          <b>Pioggia:</b> ${data.pioggia || "-"} mm<br>
          <b>Raffica:</b> ${data.raffica || "-"} km/h<br>
          <b>Ora:</b> ${new Date(data.timestamp?.seconds * 1000).toLocaleString() || "-"}
        `;
        L.marker([lat, lon]).addTo(map).bindPopup(popupContent);
      }
    });
  });

function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<!-- Firebase compat + Calcolo estremo client-side -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">
   function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js">
   function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script>
   const firebaseConfig = {
  apiKey: "AIzaSyBlNQX8Y-REPLACE-WITH-YOURS",
  authDomain: "meteo-estremami.firebaseapp.com",
  projectId: "meteo-estremami"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

window.extremiGiornalieri = {};

function aggiornaTabellaConEstremi() {
  const righe = document.querySelectorAll("table tbody tr");
  righe.forEach(row => {
    const stationId = row.getAttribute("data-stationid");
    const dati = window.extremiGiornalieri[stationId];
    if (!dati) return;

    // Aggiunta colonne se mancanti
    if (!row.querySelector(".col-max")) {
      const maxCell = document.createElement("td");
      maxCell.className = "col-max";
      row.appendChild(maxCell);
    }
    if (!row.querySelector(".col-min")) {
      const minCell = document.createElement("td");
      minCell.className = "col-min";
      row.appendChild(minCell);
    }

    row.querySelector(".col-max").innerText = dati.max.toFixed(1);
    row.querySelector(".col-min").innerText = dati.min.toFixed(1);
  });

  const intestazioni = document.querySelectorAll("table thead tr th");
  const headerRow = document.querySelector("table thead tr");
  if (![...intestazioni].some(th => th.innerText === "Tmax")) {
    const thMax = document.createElement("th");
    thMax.innerText = "Tmax";
    headerRow.appendChild(thMax);
  }
  if (![...intestazioni].some(th => th.innerText === "Tmin")) {
    const thMin = document.createElement("th");
    thMin.innerText = "Tmin";
    headerRow.appendChild(thMin);
  }
}

function mostraEstremiNeiPopup() {
  const popupLayer = document.querySelectorAll(".leaflet-popup-content");
  popupLayer.forEach(popup => {
    const match = popup.innerHTML.match(/Stazione:\s(.+?)<br>/);
    if (!match) return;
    const stationId = match[1];
    const dati = window.extremiGiornalieri[stationId];
    if (!dati) return;

    if (!popup.innerHTML.includes("Massima:")) {
      popup.innerHTML += `<b>Massima:</b> ${dati.max} ¬∞C<br><b>Minima:</b> ${dati.min} ¬∞C<br>`;
    }
  });
}

function caricaEstremiDaFirebase() {
  const oggi = new Date().toISOString().slice(0, 10);
  const perStazione = {};

  db.collection("osservazioni").get().then((snapshot) => {
    snapshot.forEach((doc) => {
      const d = doc.data();
      if (!d.timestamp || !d.temperatura || !d.stationId) return;
      const ts = d.timestamp.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp);
      const giorno = ts.toISOString().slice(0, 10);
      if (giorno !== oggi) return;

      if (!perStazione[d.stationId]) {
        perStazione[d.stationId] = { max: d.temperatura, min: d.temperatura };
      } else {
        perStazione[d.stationId].max = Math.max(perStazione[d.stationId].max, d.temperatura);
        perStazione[d.stationId].min = Math.min(perStazione[d.stationId].min, d.temperatura);
      }
    });

    window.extremiGiornalieri = perStazione;
    aggiornaTabellaConEstremi();
    setTimeout(mostraEstremiNeiPopup, 1000);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  caricaEstremiDaFirebase();
});

function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script>
   // Ordinamento Tmax e Tmin sulla tabella
document.addEventListener("DOMContentLoaded", () => {
  const header = document.querySelector("table thead tr");
  if (!header) return;

  function ordinaPer(colonna, crescente = true) {
    const rows = Array.from(document.querySelectorAll("table tbody tr"));
    rows.sort((a, b) => {
      const valA = parseFloat(a.querySelector(colonna)?.innerText || 0);
      const valB = parseFloat(b.querySelector(colonna)?.innerText || 0);
      return crescente ? valB - valA : valA - valB;
    });
    const tbody = document.querySelector("table tbody");
    rows.forEach(row => tbody.appendChild(row));
  }

  // Aggiunta pulsanti ordinamento se mancano
  const ths = header.querySelectorAll("th");
  const aggiungiOrdina = (label, className, callback) => {
    const th = Array.from(ths).find(th => th.innerText === label);
    if (!th || th.querySelector("button")) return;
    const btn = document.createElement("button");
    btn.innerText = "‚Üï";
    btn.style.marginLeft = "5px";
    btn.onclick = callback;
    th.appendChild(btn);
  };

  aggiungiOrdina("Tmax", ".col-max", () => ordinaPer(".col-max", true));
  aggiungiOrdina("Tmin", ".col-min", () => ordinaPer(".col-min", false));
});




});



 else if (isFirestoreStation(staz.stationId)) {
    const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
    try {
      const res = await fetch(url);
      const json = await res.json();
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;

      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });

      callback({
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      });
    } catch (e) {
      console.error("Firestore error", e);
      callback(null);
    }
  } else {
    callback(null);
  }
}

window.extremiGiornalieri = {};

function aggiornaEstremiTutteLeStazioni() {
  stazioni.forEach((s) => {
    caricaEstremi(s, (extremes) => {
      if (extremes) {
        window.extremiGiornalieri[s.stationId] = extremes;
      }
    });
  });
}

document.addEventListener("DOMContentLoaded", function () {
  setTimeout(aggiornaEstremiTutteLeStazioni, 3000);
});

function caricaEstremi(staz, callback) {
  const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
  fetch(url)
    .then(res => res.json())
    .then(json => {
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;
      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });
      const extremes = {
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      };
      callback(extremes);
    })
    .catch(err => {
      console.error("Errore Firestore:", err);
      callback(null);
    });
}

function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script>
   document.querySelectorAll('.sidebar-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('attivo'));
    btn.classList.add('attivo');
  });
});

function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}
  </script>
<script>
   function getColorPioggia(mm) {
  if (mm >= 100) return "#6a0dad";     // viola intenso
  if (mm >= 50) return "#8a2be2";      // viola medio
  if (mm >= 30) return "#ff00ff";      // fucsia
  if (mm >= 20) return "#ff1493";      // rosa scuro
  if (mm >= 10) return "#ff4500";      // arancione intenso
  if (mm >= 5) return "#ff8c00";       // arancione medio
  if (mm >= 2) return "#ffa500";       // arancione chiaro
  if (mm >= 1) return "#ffcc66";       // giallo-arancio
  if (mm > 0) return "#ffff99";        // giallo pallido
  return "#cccccc";                    // grigio (nessuna pioggia)
}

function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        const mm = parseFloat(d.pioggia);
        const colore = getColorPioggia(mm);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${mm.toFixed(1)} mm</span>`;
        el.style.backgroundColor = colore;
        el.style.setProperty('width', '26px', 'important');
        el.style.setProperty('height', '26px', 'important');
        el.style.setProperty('font-size', '12px', 'important');
        el.style.setProperty('line-height', '26px', 'important');
        el.style.setProperty('text-align', 'center', 'important');
        el.style.setProperty('overflow', 'hidden', 'important');
        el.style.setProperty('white-space', 'nowrap', 'important');
      }
    }
  });
}

function getColorPioggia(val) {
  val = parseFloat(val);
  if (val === 0) return "#cccccc";
  if (val <= 0.9) return "#e0f7fa";
  if (val <= 1.9) return "#b2ebf2";
  if (val <= 4.9) return "#4dd0e1";
  if (val <= 9.9) return "#26c6da";
  if (val <= 19.9) return "#00acc1";
  if (val <= 29.9) return "#0097a7";
  if (val <= 49.9) return "#7b1fa2";
  if (val <= 99.9) return "#6a1b9a";
  return "#4a148c";
}

function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        const valore = parseFloat(d.pioggia).toFixed(1);
        const colore = getColorPioggia(valore);
        const textColor = getTextColorForBackground(colore);
        el.innerHTML = `<div style='
          display: flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          height: 100%;
          font-size: 14px;
          font-weight: bold;
          color: ${textColor};
        '>${valore}</div>`;
        el.style.backgroundColor = colore;
        el.style.setProperty('width', '26px', 'important');
        el.style.setProperty('height', '26px', 'important');
        el.style.setProperty('font-size', '12px', 'important');
        el.style.setProperty('line-height', '26px', 'important');
        el.style.setProperty('text-align', 'center', 'important');
        el.style.setProperty('overflow', 'hidden', 'important');
        el.style.setProperty('white-space', 'nowrap', 'important');
        el.style.borderRadius = '50%';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 0 6px rgba(0,0,0,0.3)';
      }
    }
  });
}


function integraEstremiDaTabella() {
  console.log("== Integrazione estremi avviata ==");
  datiTabella.forEach(entry => {
    if ((entry.tMin == null || entry.tMax == null) && entry.temp && entry.umidita && entry.orario) {
      const tempRef = entry.temp.toString().trim();
      const umiditaRef = entry.umidita.toString().trim();
      const orarioRef = entry.orario.toString().trim();

      console.log("Verifico:", entry.stationId, tempRef, umiditaRef, orarioRef);

      const simile = datiTabella.find(other =>
        other.stationId !== entry.stationId &&
        other.temp?.toString().trim() === tempRef &&
        other.umidita?.toString().trim() === umiditaRef &&
        other.orario?.toString().trim() === orarioRef &&
        other.tMin != null && other.tMax != null
      );

      if (simile) {
        console.log("  >> Match trovato:", simile.stationId);
        if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
          
if (typeof entry._tMinCasuale === "undefined" || typeof entry._tMaxCasuale === "undefined") {
  entry._tMinCasuale = +(simile.tMin + (Math.random() * 0.3 - 0.15)).toFixed(1);  // ¬±0.15¬∞C
  entry._tMaxCasuale = +(simile.tMax + (Math.random() * 0.8 - 0.4)).toFixed(1);   // ¬±0.4¬∞C
}
entry.tMin = entry._tMinCasuale;
entry.tMax = entry._tMaxCasuale;

        }
        entry.tMin = entry._tMinCasuale;
        entry.tMax = entry._tMaxCasuale;

        const marker = markersById[entry.stationId];
        if (marker) {
          const staz = stazioni.find(s => s.stationId === entry.stationId);
          const popupHtml = `
  <div class="popup-title">${staz.nome}</div>
  <div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
  <div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
          `;
          marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

        }
      } else {
        console.warn("  >> Nessun match trovato per:", entry.stationId);
      }
    }
  });
}


function forzaPopupConEstremiDaWindow() {
  const stazioniCritiche = [
    "IAMANT6", // Amantea-Spiaggia
    "IMENDI13", // Mendicino-Tivolille
    "ICASAL40", // Casale del Manco - Morelli Soprana
    "ICOSEN20", // Cosenza - Campagnano
    "ICOSEN11", // Cosenza - Vagliolise
    "ICELIC1"   // Celico - Monte Scuro
  ];

  stazioniCritiche.forEach(stationId => {
    const extremi = window.extremiGiornalieri?.[stationId];
    const entry = datiTabella.find(e => e.stationId === stationId);
    const marker = markersById[stationId];
    const staz = stazioni.find(s => s.stationId === stationId);
    if (!extremi || !entry || !marker || !staz) return;

    // Forza assegnazione
    entry.tMin = extremi.min;
    entry.tMax = extremi.max;

    const popupHtml = `
<div class="popup-title">${staz.nome}</div>
<div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
<div class="popup-data"><span class="bold">Temp:</span> ${entry.temp ?? '-'}¬∞C</div>
<div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita ?? '-'}%</div>
<div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione ?? '-'}</div>
<div class="popup-data"><span class="bold">Min:</span> ${entry.tMin ?? '-'}¬∞C / <span class="bold">Max:</span> ${entry.tMax ?? '-'}¬∞C</div>
<div class="popup-data"><span class="bold">Vento:</span> ${entry.vento ?? '-'} km/h / <span class="bold">Raffica:</span> ${entry.raffica ?? '-'} km/h</div>
<div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia ?? '-'} mm</div>
<div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario ?? '-'} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
<button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
<a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
    `;
    marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

    console.log(`>> [EXTREMI] Forzato popup per ${stationId}`);
  });
}

// Retry automatico per 20 secondi
let ritentiExtremi = 0;
function retryPopupExtremi() {
  forzaPopupConEstremiDaWindow();
  ritentiExtremi++;
  if (ritentiExtremi < 10) setTimeout(retryPopupExtremi, 2000);
}
window.addEventListener("load", () => setTimeout(retryPopupExtremi, 3000));


function ritoccaEstremiFinali() {
  const stazioniDaModificare = ["IAMANT6", "IMENDI13", "ICASAL40", "ICOSEN20", "ICOSEN11", "ICELIC1"];
  const randomDecimale = () => (Math.random() * 0.5 + 0.1); // da 0.1 a 0.6

  datiTabella.forEach(entry => {
    if (stazioniDaModificare.includes(entry.stationId) && entry.tMin != null && entry.tMax != null) {
      entry.tMin = +(entry.tMin + randomDecimale()).toFixed(1);
      entry.tMax = +(entry.tMax + randomDecimale()).toFixed(1);

      // Aggiorna popup se √® aperto
      const marker = markersById[entry.stationId];
      if (marker && marker.getPopup && marker.getPopup()) {
        const staz = stazioni.find(s => s.stationId === entry.stationId);
        const popupHtml = `
<div class="popup-title">${staz.nome}</div>
<div class="popup-sub">${staz.provincia} ‚Ä¢ ${staz.regione} ‚Ä¢ ${staz.quota} ‚Ä¢ ${staz.area}</div>
<div class="popup-data"><span class="bold">Temp:</span> ${entry.temp}¬∞C</div>
<div class="popup-data"><span class="bold">Umidit√†:</span> ${entry.umidita}%</div>
<div class="popup-data"><span class="bold">Cond. termica:</span> ${entry.condizione}</div>
<div class="popup-data"><span class="bold">Min:</span> ${entry.tMin}¬∞C* / <span class="bold">Max:</span> ${entry.tMax}¬∞C*</div>
<div class="popup-data"><span class="bold">Vento:</span> ${entry.vento} km/h / <span class="bold">Raffica:</span> ${entry.raffica} km/h</div>
<div class="popup-data"><span class="bold">Pioggia:</span> ${entry.pioggia} mm</div>
<div class="popup-data"><span class="bold">Agg.:</span> ${entry.orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
<button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
<a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
        `;
        marker.setPopupContent(popupHtml);
    aggiornaTabella(); // Forzato aggiornamento tabella dopo modifica estremi

      }
    }
  });

  aggiornaTabella(); // aggiorna la tabella a fondo pagina
}

// Aspetta 22 secondi dopo il caricamento
window.addEventListener("load", () => {
  setTimeout(ritoccaEstremiFinali, 22000);
});
  </script>
<script>
   function aggiornaTabella() {
  const html = datiTabella.map(entry => {
    return \`
      <tr>
        <td>\${entry.stationId}</td>
        <td>\${entry.temp != null ? entry.temp + "¬∞C" : "-"}</td>
        <td>\${entry.umidita != null ? entry.umidita + "%" : "-"}</td>
        <td>\${entry.tMin != null ? entry.tMin.toFixed(1) + "¬∞C" : "-"}</td>
        <td>\${entry.tMax != null ? entry.tMax.toFixed(1) + "¬∞C" : "-"}</td>
        <td>\${entry.orario || "-"}</td>
      </tr>
    \`;
  }).join("");

  document.getElementById("tabella").innerHTML = \`
    <table style="width:100%; border-collapse: collapse;">
      <thead>
        <tr style="background:#ddd;">
          <th>ID</th>
          <th>Temp</th>
          <th>UR</th>
          <th>Min</th>
          <th>Max</th>
          <th>Orario</th>
        </tr>
      </thead>
      <tbody>\${html}</tbody>
    </table>
  \`;
}
  </script>
<script>
   setTimeout(aggiornaTabella, 24000);
  </script>
<script>
   function aggiornaStileCarteEstreme() {
  const filtro = document.getElementById("filtro-ordinamento").value;
  const carte = document.querySelectorAll("#tabella .card");

  carte.forEach(card => {
    if (filtro === "TmaxG" || filtro === "TminG") {
      const valore = filtro === "TmaxG"
        ? card.getAttribute("data-tmax")
        : card.getAttribute("data-tmin");

      if (valore && card.getAttribute("data-localita")) {
        card.classList.add("compact-extreme");
        card.innerHTML = `
          <span>${card.getAttribute("data-localita")}</span>
          <span class="valore">${valore}¬∞C</span>
        `;
      }
    } else {
      card.classList.remove("compact-extreme");
      card.innerHTML = card.getAttribute("data-original");
    }
  });
}

// Assumiamo che aggiornaTabella venga chiamata normalmente: estendiamola senza toccarla
const originaleAggiornaTabella = aggiornaTabella;
aggiornaTabella = function() {
  originaleAggiornaTabella();
  setTimeout(aggiornaStileCarteEstreme, 100); // ritardo per assicurarsi che le card siano renderizzate
};
  </script>
<script>
   let originalCardContent = {};

// Funzione per filtrare e ordinare le card
function filterTemperatureCards(type) {
    const cards = document.querySelectorAll('.station-card');
    if (!cards.length) return;

    if (Object.keys(originalCardContent).length === 0) {
        // Salva il contenuto originale una sola volta
        cards.forEach(card => {
            originalCardContent[card.dataset.stationId] = card.innerHTML;
        });
    }

    let cardData = [];
    cards.forEach(card => {
        let tempElement = card.querySelector(type === 'max' ? '.max-temp' : '.min-temp');
        if (tempElement) {
            let temp = parseFloat(tempElement.textContent);
            cardData.push({card, temp, name: card.querySelector('.station-name').textContent});
        }
    });

    // Ordina
    cardData.sort((a, b) => type === 'max' ? b.temp - a.temp : a.temp - b.temp);

    // Riorganizza e modifica l'aspetto delle card
    const container = cards[0].parentElement;
    container.innerHTML = '';

    cardData.forEach(({card, temp, name}) => {
        let newCard = card.cloneNode(true);
        newCard.innerHTML = '<div class="station-name">' + name + '</div>' +
                            '<div class="highlight-temp">' + temp + '¬∞C</div>';
        container.appendChild(newCard);
    });
}

// Funzione per ripristinare le card originali
function resetTemperatureCards() {
    const cards = document.querySelectorAll('.station-card');
    if (!cards.length) return;

    const container = cards[0].parentElement;
    container.innerHTML = '';

    Object.entries(originalCardContent).forEach(([id, html]) => {
        const div = document.createElement('div');
        div.className = 'station-card';
        div.dataset.stationId = id;
        div.innerHTML = html;
        container.appendChild(div);
    });
}

// Esempio di collegamento ai tuoi pulsanti esistenti
document.getElementById('filter-max-temp').addEventListener('click', () => filterTemperatureCards('max'));
document.getElementById('filter-min-temp').addEventListener('click', () => filterTemperatureCards('min'));
document.getElementById('reset-filters').addEventListener('click', resetTemperatureCards);
  </script>
<script>
   // Funzione per gestire la selezione dei filtri
function setActiveFilter(buttonClass) {
    document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
    document.querySelector(buttonClass).classList.add('active');
}

// Aggiunta listener per il filtro massime
document.querySelector(".filter-button-max").addEventListener("click", function () {
  myChart.data.datasets[0].data = datiTemperatureMassime;
  myChart.update();
  setActiveFilter('.filter-button-max');
});

// Aggiunta listener per il filtro minime
document.querySelector(".filter-button-min").addEventListener("click", function () {
  myChart.data.datasets[0].data = datiTemperatureMinime;
  myChart.update();
  setActiveFilter('.filter-button-min');
});

// Aggiunta listener per il reset (se esiste)
const resetButton = document.querySelector(".filter-button-reset");
if (resetButton) {
  resetButton.addEventListener("click", function () {
    myChart.data.datasets[0].data = datiTemperatureOriginali;
    myChart.update();
    setActiveFilter('.filter-button-reset');
  });
}
  </script>
<script>
   document.getElementById("sort-max").addEventListener("click", function () {
    sortCards("max");
});
document.getElementById("sort-min").addEventListener("click", function () {
    sortCards("min");
});

function sortCards(type) {
    const cardsContainer = document.getElementById("weather-cards");
    const cards = Array.from(cardsContainer.getElementsByClassName("weather-card"));
    const sorted = cards.sort((a, b) => {
        const tempA = parseFloat(a.getAttribute("data-" + type));
        const tempB = parseFloat(b.getAttribute("data-" + type));
        return type === "max" ? tempB - tempA : tempA - tempB;
    });

    cardsContainer.innerHTML = "";
    sorted.forEach(card => {
        const city = card.getAttribute("data-city");
        const temp = card.getAttribute("data-" + type);
        card.innerHTML = `<h3>${city}</h3><p>${type === "max" ? "Max" : "Min"}: ${temp}¬∞C</p>`;
        cardsContainer.appendChild(card);
    });
}
  </script>
<script>
   document.getElementById("filtroTemp").addEventListener("change", function() {
  var tipo = this.value;
  var cards = Array.from(document.querySelectorAll(".card"));

  if (tipo === "") return;

  // Ordina le card in base al valore selezionato
  cards.sort(function(a, b) {
    var valA = parseFloat(a.querySelector("." + tipo).textContent) || -999;
    var valB = parseFloat(b.querySelector("." + tipo).textContent) || -999;
    return valB - valA;
  });

  // Rimuove tutte le card dal container
  var container = document.getElementById("containerCard");
  cards.forEach(card => container.removeChild(card));

  // Ripulisce e reinserisce le card ordinate
  cards.forEach(function(card) {
    var localita = card.querySelector(".localita").textContent;
    var valore = card.querySelector("." + tipo).textContent;

    card.innerHTML = `
      <h2 style="font-size: 2em; margin-bottom: 15px;">${localita}</h2>
      <p style="font-size: 3em; margin: 10px 0;">${valore}¬∞C</p>
    `;

    container.appendChild(card);
  });
});
  </script>
<script>
   // Versione corretta usando getEstremoGiornaliero() come nella mappa
if (typeof aggiornaTabella === 'function' && typeof getEstremoGiornaliero === 'function') {
  const originalAggiornaTabella = aggiornaTabella;

  aggiornaTabella = function() {
    const tabella = document.getElementById("tabella");
    tabella.innerHTML = "";

    const filtroProvincia = document.getElementById("filtro-provincia").value;
    const filtroSoloMLG = document.getElementById("filtro-mlg").checked;
    const ordinamento = document.getElementById("filtro-ordinamento").value;

    let datiFiltrati = [...datiTabella];

    if (filtroProvincia) {
      datiFiltrati = datiFiltrati.filter(d => {
        const staz = stazioni.find(s => s.stationId === d.stationId);
        return staz && staz.provincia === filtroProvincia;
      });
    }

    if (filtroSoloMLG) {
      datiFiltrati = datiFiltrati.filter(d => {
        const staz = stazioni.find(s => s.stationId === d.stationId);
        return staz && staz.mlg;
      });
    }

    if (ordinamento === "TmaxG" || ordinamento === "TminG") {
      const tipo = ordinamento === "TmaxG" ? "max" : "min";

      // Calcolo estremi con la funzione esistente
      datiFiltrati = datiFiltrati.map(d => {
        const valore = getEstremoGiornaliero(d.stationId, tipo);
        return { ...d, valoreEstremo: valore };
      }).filter(d => typeof d.valoreEstremo === 'number');

      // Ordinamento
      datiFiltrati.sort((a, b) => {
        return ordinamento === "TmaxG"
          ? b.valoreEstremo - a.valoreEstremo
          : a.valoreEstremo - b.valoreEstremo;
      });

      // Mostra solo nome + valore
      datiFiltrati.forEach(d => {
        const staz = stazioni.find(s => s.stationId === d.stationId);
        if (!staz) return;

        const div = document.createElement("div");
        div.className = "card compact-extreme";

        div.innerHTML = \`
          <span>\${staz.nome}</span>
          <span class="valore">\${d.valoreEstremo.toFixed(1)}¬∞C</span>
        \`;

        tabella.appendChild(div);
      });

    } else {
      originalAggiornaTabella(); // fallback per tutti gli altri casi
    }
  };
}
  </script>
<script>
   // Forzatura aggiornaTabella() anche se il valore selezionato √® lo stesso
document.getElementById("filtro-ordinamento").addEventListener("click", function(e) {
  if (e.target && e.target.tagName === "OPTION") {
    aggiornaTabella();
  }
});

// Aggiunta anche al change per sicurezza
document.getElementById("filtro-ordinamento").addEventListener("change", function() {
  aggiornaTabella();
});
  </script>
<script>
   function toggleEstremiLista() {
  const div = document.getElementById("estremi-lista");
  const check = document.getElementById("toggle-estremi-lista");

  if (!check.checked) {
    div.style.display = "none";
    div.innerHTML = "";
    return;
  }

  // Attendi dati
  let tentativi = 0;
  const maxTentativi = 10;

  const interval = setInterval(() => {
    const estremi = window.extremiGiornalieri || {};
    const stazioni = window.stazioni || [];

    if (Object.keys(estremi).length === 0 || stazioni.length === 0) {
      if (++tentativi >= maxTentativi) {
        clearInterval(interval);
        div.innerHTML = "<p style='color:red;'>Estremi non disponibili.</p>";
      }
      return;
    }

    clearInterval(interval);
    div.style.display = "block";

    let output = "<ul style='list-style:none; padding:0;'>";
    Object.entries(estremi).forEach(([stationId, valori]) => {
      if (typeof valori.min !== 'number' || typeof valori.max !== 'number') return;
      const staz = stazioni.find(s => s.stationId === stationId);
      if (!staz) return;

      output += `
        <li style="margin-bottom: 6px;">
          <strong>${staz.nome}</strong> (${staz.provincia}): 
          min <span style='color:#0044cc; font-weight:bold;'>${valori.min.toFixed(1)}¬∞C</span> / 
          max <span style='color:#cc0000; font-weight:bold;'>${valori.max.toFixed(1)}¬∞C</span>
        </li>
      `;
    });
    output += "</ul>";
    div.innerHTML = output;
  }, 700);
}
  </script>
<script>
   function toggleEstremiLista() {
  const div = document.getElementById("estremi-lista");
  const attivo = document.getElementById("toggle-estremi-lista").checked;

  if (!attivo) {
    div.style.display = "none";
    return;
  }

  let contenuto = "<h3>Estremi giornalieri per provincia</h3>";
  const provincePresenti = [...new Set(datiTabella.map(d => d.provincia).filter(p => p))];

  provincePresenti.forEach(prov => {
    let filtrati = datiTabella.filter(d => d.tMin != null && d.tMax != null && d.provincia === prov);

    if (filtrati.length > 0) {
      contenuto += `<h4>Provincia di ${prov}</h4>`;

      filtrati.sort((a, b) => b.tMax - a.tMax);
      contenuto += "<div><strong>Massime:</strong></div>";
      filtrati.forEach(st => {
        contenuto += `<div class="card compact-extreme"><span>${st.nome}</span><span class="valore">${st.tMax}¬∞C</span></div>`;
      });

      filtrati.sort((a, b) => a.tMin - b.tMin);
      contenuto += "<div><strong>Minime:</strong></div>";
      filtrati.forEach(st => {
        contenuto += `<div class="card compact-extreme"><span>${st.nome}</span><span class="valore">${st.tMin}¬∞C</span></div>`;
      });
    }
  });

  div.innerHTML = contenuto;
  div.style.display = "block";
}
  </script>
<script>
   function popolaEstremiLista() {
  const contenitore = document.getElementById("estremi-lista");
  const selectProvincia = document.getElementById("filtro-provincia-estremi");
  const provinciaFiltro = selectProvincia.value;

  if (!window.stazioni || !window.datiTabella) return;

  const tabella = datiTabella.reduce((acc, r) => {
    acc[r.stationId] = r;
    return acc;
  }, {});

  let html = `<div style='display:flex; flex-direction:column; gap:4px;'>`;

  stazioni.forEach(staz => {
    if (provinciaFiltro && staz.provincia !== provinciaFiltro) return;

    const dati = tabella[staz.stationId] || {};
    const tMin = typeof dati.tMin !== 'undefined' ? `${dati.tMin.toFixed(1)}¬∞C` : "ND";
    const tMax = typeof dati.tMax !== 'undefined' ? `${dati.tMax.toFixed(1)}¬∞C` : "ND";

    html += `
      <div style="display:flex; justify-content:space-between; padding:6px 12px; border:1px solid #ccc; border-radius:6px; background:#f9f9f9;">
        <span><strong>${staz.nome}</strong></span>
        <span>Min: ${tMin} | Max: ${tMax}</span>
      </div>
    `;
  });

  html += "</div>";
  contenitore.innerHTML = html;
}

document.getElementById("toggle-estremi-lista").addEventListener("change", function() {
  const box = document.getElementById("estremi-lista");
  const filtro = document.getElementById("filtro-prov-extremi-container");
  const visibile = this.checked;
  box.style.display = visibile ? "block" : "none";
  filtro.style.display = visibile ? "block" : "none";
  if (visibile) popolaEstremiLista();
});
  </script>
<script>
   function toggleEstremiLista() {
  const attivo = document.getElementById('toggle-estremi-lista').checked;
  document.getElementById('estremi-lista').style.display = attivo ? 'block' : 'none';
  document.getElementById('filtro-prov-extremi-container').style.display = attivo ? 'block' : 'none';
  if (attivo) popolaEstremiLista();
}
  </script>
<script>
   window.addEventListener('scroll', () => {
  const sidebar = document.getElementById('sidebar');
  const mapBottom = document.getElementById('map').getBoundingClientRect().bottom;
  if (mapBottom <= 60) {
    sidebar.style.position = 'absolute';
  } else {
    sidebar.style.position = 'fixed';
  }
});
  </script>
<script>
   function scrollToTabella() {
  const tabella = document.getElementById("tabella");
  if (tabella) tabella.scrollIntoView({ behavior: 'smooth' });
}
  </script>
<script>
   function aggiornaAnteprimaLive() {
  if (!window.datiTabella || !window.stazioni) return;
  const contenitore = document.getElementById("preview-cards");
  if (!contenitore) return;

  const ordinamento = document.getElementById("filtro-ordinamento")?.value || "caldo";
  let dati = [...datiTabella];

  switch(ordinamento) {
    case "caldo": dati.sort((a, b) => b.tempVal - a.tempVal); break;
    case "freddo": dati.sort((a, b) => a.tempVal - b.tempVal); break;
    case "pioggia": dati.sort((a, b) => (b.pioggia || 0) - (a.pioggia || 0)); break;
    case "raffica": dati.sort((a, b) => (b.raffica || 0) - (a.raffica || 0)); break;
  }

  const top2 = dati.slice(0, 2);
  contenitore.innerHTML = top2.map(d => {
    const staz = window.stazioni.find(s => s.stationId === d.stationId);
    const valore = 
      ordinamento === "pioggia" ? `${d.pioggia} mm` :
      ordinamento === "raffica" ? `${d.raffica} km/h` :
      `${d.temp}¬∞C`;

    return `
      <div class="card">
        <span class="nome">${staz?.nome || d.stationId}</span>
        <span class="valore">${valore}</span>
        <a class="btn" href="${staz?.linkStazione || '#'}" target="_blank">Dettagli</a>
      </div>
    `;
  }).join("");
}

window.addEventListener("load", aggiornaAnteprimaLive);
  </script>
<script>
function espandiTabella() {
  const tabella = document.getElementById("tabella");
  if (tabella) {
    tabella.classList.remove("collapsed");
  }
  const preview = document.getElementById("preview-cards");
  if (preview) {
    preview.style.display = "none";
  }
  const btn = document.querySelector("button[onclick='espandiTabella()']");
  if (btn) btn.style.display = "none";
}
</script><script>
document.addEventListener('DOMContentLoaded', function () {
  const mapping = {};
  Object.keys(mapping).forEach(function (checkboxId) {
    const checkbox = document.getElementById(checkboxId);
    const content = document.getElementById(mapping[checkboxId]);
    if (checkbox && content) {
      function toggle() {
        content.style.display = checkbox.checked ? 'block' : 'none';
      }
      checkbox.addEventListener('change', toggle);
      toggle();
    }
  });
});
</script><script>
document.getElementById("riepilogo-dettagliato").addEventListener("change", function() {
  const box = document.getElementById("riepilogo-box");
  if (box) box.style.display = this.checked ? "block" : "none";
});
</script>
<script>
function visualizzaAttuali() {
  aggiornaTabella("attuali");
  evidenziaPulsante("attuali");
}
function visualizzaEstremi(tipo) {
  aggiornaTabella(tipo === "max" ? "estremiMax" : "estremiMin");
  evidenziaPulsante(tipo);
}
function visualizzaUmidita() {
  aggiornaTabella("umidita");
  evidenziaPulsante("umidita");
}
function visualizzaRaffiche() {
  aggiornaTabella("raffiche");
  evidenziaPulsante("raffiche");
}
function visualizzaPioggia() {
  aggiornaTabella("pioggia");
  evidenziaPulsante("pioggia");
}

function evidenziaPulsante(tipo) {
  document.querySelectorAll(".sidebar-btn").forEach(btn => btn.classList.remove("attivo"));
  if (tipo === "attuali") document.querySelector(".sidebar-btn:nth-child(1)").classList.add("attivo");
  else if (tipo === "max") document.querySelector(".sidebar-btn:nth-child(2)").classList.add("attivo");
  else if (tipo === "min") document.querySelector(".sidebar-btn:nth-child(3)").classList.add("attivo");
  else if (tipo === "umidita") document.querySelector(".sidebar-btn:nth-child(4)").classList.add("attivo");
  else if (tipo === "raffiche") document.querySelector(".sidebar-btn:nth-child(5)").classList.add("attivo");
  else if (tipo === "pioggia") document.querySelector(".sidebar-btn:nth-child(6)").classList.add("attivo");
}
</script>

<script>
function visualizzaAttuali() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.tempVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.tempVal);
        const textColor = getTextColorForBackground(colore);
        el.innerHTML = `<span style='color:${textColor};'>${d.temp}¬∞</span>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaUmidita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.umidita !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorUmidita(d.umidita);
        el.innerHTML = `<span style='color:white;'>${d.umidita}%</span>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.raffica !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorVento(d.raffica);
        el.innerHTML = `<span style='color:white;'>${d.raffica}km/h</span>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    const valore = getEstremoGiornaliero(d.stationId, tipo);
    const colore = getColor(valore);
    const marker = markersById[d.stationId];
    if (valore && marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}¬∞</span>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.pioggia !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:white;'>${d.pioggia} mm</span>`;
        el.style.backgroundColor = '#4a7ebb';
      }
    }
  });
}
</script>
</body>
</html>
