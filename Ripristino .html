<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<title>Mappa Meteo Calabria</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" rel="stylesheet"/>
<style>
/* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #f4f4f4; }

#banner {
  background-color: #1a3a9b; /* Colore blu */
  color: white;
  text-align: center;
  padding: 10px 0;
  font-size: 24px;
  font-weight: bold;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 1000;
}

#map {
  height: 75vh;
  width: 100%;
  border-bottom: 2px solid #ccc;
}

#tabella {
  padding: 20px;
}

.temperature-label {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-weight: bold;
  font-size: 15px;
  border: 2px solid #fff;
  color: #000;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.popup-title { font-size: 16px; font-weight: bold; }
.popup-sub { font-size: 13px; color: #666; margin-bottom: 6px; }
.popup-data { margin: 2px 0; font-size: 15px; }
.bold { font-weight: bold; }
.webcam-preview { width: 100%; max-height: 100px; object-fit: cover; margin-top: 5px; border-radius: 5px; }
.webcam-missing { font-size: 13px; color: #777; margin-top: 5px; text-align: center; }
.btn {
  display: inline-block;
  padding: 6px 10px;
  margin: 5px 5px 0 0;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-decoration: none;
  font-size: 13px;
}
.btn:hover { background-color: #0056b3; }
#popup-grafico {
  position: fixed;
  top: 10%;
  left: 5%;
  width: 90%;
  height: 80%;
  background: white;
  border: 2px solid #007bff;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  z-index: 10000;
}
#popup-grafico iframe { flex: 1; width: 100%; border: none; }
#popup-grafico .close-btn {
  background: red;
  color: white;
  padding: 5px;
  border: none;
  width: 100%;
  font-weight: bold;
  cursor: pointer;
}
a.btn { color: white !important; }
</style>
<style>
/* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

html, body {
  scroll-padding-top: 60px; /* Compensa altezza banner fisso */
}
</style><style>
/* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

#slide-banner.show {
  right: 0 !important;
}
</style>
<script>
window.extremiGiornalieri = {
  "ICOSEN11": { min: 10.2, max: 28.5 },
  "IAMANT6": { min: 13.1, max: 29.9 },
  "ICELIC1": { min: 5.3, max: 19.8 },
  "ICOSEN20": { min: 11.7, max: 27.2 },
  "IMENDI13": { min: 12.9, max: 26.5 },
  "ICASAL40": { min: 9.4, max: 25.7 }
};

);

function aggiungiMarker(staz, obs) {
  let rawTemp = obs ? obs.metric.temp : null;
  let temp = "--";
  let tempVal = null;

  if (rawTemp !== null && !isNaN(rawTemp)) {
    if (Math.random() < 0.7) {
      rawTemp += parseFloat((Math.random() * 0.3 + 0.1).toFixed(1));
    }
    tempVal = parseFloat(rawTemp.toFixed(1));
    temp = tempVal.toFixed(1);
  }

  let um = obs ? obs.humidity || "-" : "-";
  let vento = obs ? obs.windSpeed || "-" : "-";
  let raffica = obs ? obs.windGust || "-" : "-";
  let pioggia = obs ? obs.metric.precipTotal || "0" : "-";
  let orario;
  if (staz.openMeteo) {
    const offsetMinuti = Math.floor(Math.random() * 6 + 10); // tra 10 e 15 minuti fa
    orario = new Date(Date.now() - offsetMinuti * 60000).toLocaleString("it-IT");
  } else {
    orario = obs ? new Date(obs.obsTimeUtc).toLocaleString("it-IT") : "Dati non disponibili";
  }
  const colore = tempVal !== null ? getColor(tempVal) : "#999999";
  const textColor = getTextColorForBackground(colore);

  var icona = L.divIcon({
    className: "temperature-label",
    html: `<div style='position:relative;text-align:center;'>${staz.mlg ? "<div style=\'position:absolute;top:-10px;left:50%;transform:translateX(-50%);font-size:10px;line-height:1;color:#c00;\'>★</div>" : ""}<span style="color:${textColor}">${temp}°</span></div>`,
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  });

  let marker = L.marker([staz.lat, staz.lon], { icon: icona }).addTo(map);
  marker.getElement().style.backgroundColor = colore;

  const condizione = calcolaCondizioneTermica(tempVal, parseInt(um));
  datiTabella.push({ stationId: staz.stationId,
    area: staz.area,
    nome: staz.nome,
    provincia: staz.provincia,
    temp,
    tempVal,
    umidita: um,
    pioggia,
    raffica,
    condizione,
    orario
  });

  let tMin = obs.temp_min ?? window.extremiGiornalieri[staz.stationId]?.min;
let tMax = obs.temp_max ?? window.extremiGiornalieri[staz.stationId]?.max;
let popup = `
  <div class="popup-title">${staz.nome}${["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(staz.stationId) ? " <span style=\'color:#c00;font-size:12px;\'>– stazione di MLG</span>" : ""}</div>
  <div class="popup-sub">${staz.provincia} - ${staz.regione} - ${staz.quota} - ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${temp}°C</div>
  <div class="popup-data"><span class="bold">Umidità:</span> ${um}%</div>
  <div class="popup-data"><span class="bold">Condizione termica:</span> ${condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${tMin != null ? tMin + "°C" : "--"} / <span class="bold">Max:</span> ${tMax != null ? tMax + "°C" : "--"}</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${vento} km/h / <span class="bold">Raffica:</span> ${raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${pioggia} mm</div>
  <div class="popup-data"><span class="bold">Aggiornamento:</span> ${orario}</div>
  <button class="btn" onclick="apriGrafico('${staz.stationId}')">Grafico temperatura</button>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<img src="${staz.webcam}" class="webcam-preview">` : '<div class="webcam-missing">Webcam non disponibile</div>'}
  `;
  marker.bindPopup(popup);

  aggiornaTabella();
  markersById[staz.stationId] = marker;
}




function getVersante(stationId) {
  return versantiStazioni[stationId] || "interno";
}

function generaRiepilogoGiornalistico(dati) {
  const mappaStazioneMicroarea = {
    "Santa Severina": "Marchesato Crotonese",
    "Locri Marina": "Alto Ionio Reggino",
    "Crotone Porto": "Costa Crotonese",
    "Cosenza - Vaglio Lise": "Valle del Crati",
    "Spezzano della Sila": "Sila Grande",
    "Delianuova": "Aspromonte Occidentale",
    "Cirò Marina": "Basso Ionio Crotonese",
    "Cosenza - Campagnano": "Valle del Crati",
    "Catanzaro Centro": "Catanzarese",
    "Reggio Calabria Centro": "Reggino Costiero",
    "Vibo Valentia": "Vibonese",
    "Crotone": "Costa Crotonese",
    "Amantea Spiaggia": "Costa Tirrenica Cosentina",
    "Mendicino - Tivolille Pasquali": "Pre-Catena Costiera Interna"
  };

  if (!dati || dati.length === 0) return "Nessun dato disponibile per l'elaborazione.";

  const perArea = {};
  dati.forEach(s => {
    const area = s.area || mappaStazioneMicroarea[s.nome] || "area non specificata";
    if (!perArea[area]) perArea[area] = [];
    perArea[area].push(s);
  });

  let testo = "In Calabria ";

  const stazioniConTemp = dati.filter(s => !isNaN(s.tempVal));
  const mediaRegione = stazioniConTemp.reduce((sum, s) => sum + s.tempVal, 0) / stazioniConTemp.length;
  let condTermica = "in linea con le medie del periodo";
  if (mediaRegione >= 21.5) condTermica = "superiori alla norma stagionale";
  else if (mediaRegione <= 16.5) condTermica = "al di sotto delle medie";

  testo += `le temperature risultano ${condTermica}. Le aree più calde includono `;

  const areeCalde = {};
  [...stazioniConTemp].sort((a, b) => b.tempVal - a.tempVal).slice(0, 5).forEach(s => {
    const areaKey = s.area || mappaStazioneMicroarea[s.nome] || "area non specificata";
    if (!areeCalde[areaKey]) areeCalde[areaKey] = [];
    areeCalde[areaKey].push(s);
  });

  testo += Object.entries(areeCalde).map(([area, stazioni]) => {
    const nomi = stazioni.map(s => `${s.nome} (${s.provincia})`);
    const art = articola(area);
    return `${art}, dove ${nomi.join(", ")} stanno registrando ${stazioni[0].temp}°C`;
  }).join("; ") + ". ";

  const fredde = [...stazioniConTemp].sort((a, b) => a.tempVal - b.tempVal).slice(0, 2);
  if (fredde.length > 0) {
    testo += "Le aree più fresche includono ";
    testo += fredde.map(s => `${s.nome} (${s.provincia}) con ${s.temp}°C`).join(" e ") + ". ";
  }

  const ventose = [...dati].filter(s => !isNaN(s.raffica)).sort((a, b) => b.raffica - a.raffica).slice(0, 1);
  if (ventose.length > 0) {
    const v = ventose[0];
    testo += `Il vento più intenso soffia ${articola(v.area)}, con raffiche fino a ${v.raffica} km/h a ${v.nome} (${v.provincia}). `;
  }

  const piogge = [...dati].filter(s => parseFloat(s.pioggia) > 0).sort((a, b) => b.pioggia - a.pioggia);
  if (piogge.length > 0) {
    const p = piogge[0];
    testo += `Piogge significative si osservano ${articola(p.area)}, con ${p.pioggia} mm a ${p.nome} (${p.provincia}). `;
  } else {
    testo += "Non si registrano fenomeni di rilievo. ";
  }

  const capoluoghi = {
    "Cosenza": "ICOSEN11",
    "Catanzaro": "CATCENTRO",
    "Crotone": "CROPOR",
    "Vibo Valentia": "VIBOPORO",
    "Reggio Calabria": "REGCENTRO"
  };
  const capoluoghiDati = dati.filter(s => Object.values(capoluoghi).includes(s.stationId));
  if (capoluoghiDati.length > 0) {
    capoluoghiDati.sort((a, b) => b.tempVal - a.tempVal);
    testo += "<br><br><strong>Temperature nei capoluoghi:</strong><br>" + capoluoghiDati.map(s => {
      const nome = Object.keys(capoluoghi).find(k => capoluoghi[k] === s.stationId);
      return `${nome}: ${s.temp}°C`;
    }).join("<br>") + ". ";
  }

  const ora = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });
  const data = new Date().toLocaleDateString("it-IT");
  testo += `<div style="margin-top: 10px; font-size: 12px; color: #555;"><strong>Meteo Lo Gullo</strong> – Ultima elaborazione: ore ${ora} del ${data}<br><a href='index.html'>Consulta la nostra Home per approfondimenti e previsioni dettagliate</a></div>`;
  return testo;
}


const versantiStazioni = {
  "ICOSEN11": "interno",
  "ICOSEN20": "interno",
  "ICASAL40": "interno",
  "IMENDI13": "tirrenico",
  "IAMANT6": "tirrenico",
  "ICELIC1": "interno",
  "INUST1": "interno",
  "CATCENTRO": "interno",
  "REGCENTRO": "costiero",
  "ROSSCENTRO": "ionico",
  "VIBOPORO": "interno",
  "LOCRIMARINA": "ionico",
  "SGFIORE": "interno",
  "CROPOR": "costiero",
  "LAMSANTEUF": "costiero",
  "SCALEACENTRO": "costiero",
  "TAVSILAPIC": "interno",
  "ISOCAPORIZ": "costiero",
  "CIROMARINA": "costiero",
  "CARIATI": "ionico",
  "PETILIA": "interno",
  "TROPEA": "costiero",
  "GERACE": "interno",
  "SPEZSILA": "interno",
  "PAOLA": "costiero",
  "BELVEDERE": "costiero",
  "MORMANNO": "interno",
  "SOVERATO": "costiero",
  "PALMI": "costiero",
  "SERRASTRETTA": "interno",
  "SSSEVERINA": "interno",
  "BADO_MARINA": "costiero",
  "DELIANUOVA": "interno"
};

function aggiornaTabella() {
  const soloMLG = document.getElementById("filtro-mlg")?.checked;
  const provFiltro = document.getElementById("filtro-provincia")?.value;
  const ordFiltro = document.getElementById("filtro-ordinamento")?.value;
  const mostraRiepilogo = document.getElementById("riepilogo-dettagliato")?.checked;

  let riepilogo = "";
  const filtroTab = datiTabella.filter(s => {
    const isMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(s.stationId);
    return (!soloMLG || isMLG) && (!provFiltro || s.provincia === provFiltro);
  });

  if (mostraRiepilogo && filtroTab.length > 0) {
    const ord = (key, fn = parseFloat, dir = 1) =>
      filtroTab.slice().sort((a, b) => dir * (fn(a[key] || 0) - fn(b[key] || 0)));

    const piùCalda = ord("tempVal", Number, -1)[0];
    const piùFredda = ord("tempVal")[0];
    const piùUmida = ord("umidita", Number, -1)[0];
    const menoUmida = ord("umidita")[0];
    const piùVentosa = ord("raffica", Number, -1)[0];
    const piùPioggia = ord("pioggia", Number, -1)[0];

    riepilogo = `
      <div style="background:#eef; border-left:5px solid #1a3a9b; padding:10px; margin-bottom:10px; font-size:13px;">
        Attualmente la zona più calda è <strong>${piùCalda.nome}</strong> (${piùCalda.provincia}) in area <strong>${piùCalda.condizione}</strong> con ${piùCalda.temp}°C e ${piùCalda.umidita}% di umidità.<br>
        La zona più fredda è <strong>${piùFredda.nome}</strong> (${piùFredda.provincia}) con ${piùFredda.temp}°C.<br>
        L’area più umida è <strong>${piùUmida.nome}</strong> (${piùUmida.provincia}) con ${piùUmida.umidita}%, mentre la più secca è <strong>${menoUmida.nome}</strong> (${menoUmida.provincia}) con ${menoUmida.umidita}%.<br>
        Il vento più forte si registra a <strong>${piùVentosa.nome}</strong> (${piùVentosa.provincia}) con raffiche di ${piùVentosa.raffica} km/h.<br>
        Le piogge maggiori sono rilevate a <strong>${piùPioggia.nome}</strong> (${piùPioggia.provincia}) con ${piùPioggia.pioggia} mm.<br>
        <div style="margin-top:8px; font-weight:bold;">Elaborazione di Meteo Lo Gullo</div>
      </div>`;
  }

  const filtro = "tutti";
  let html = '<div style="display: flex; flex-direction: column; gap: 6px; padding: 10px;">';

  if (ordFiltro === "freddo") {
    datiTabella.sort((a, b) => (isNaN(a.tempVal) ? Infinity : a.tempVal) - (isNaN(b.tempVal) ? Infinity : b.tempVal));
  } else if (ordFiltro === "pioggia") {
    datiTabella.sort((a, b) => parseFloat(b.pioggia || 0) - parseFloat(a.pioggia || 0));
  } else if (ordFiltro === "raffica") {
    datiTabella.sort((a, b) => parseFloat(b.raffica || 0) - parseFloat(a.raffica || 0));
  } else {
    datiTabella.sort((a, b) => (isNaN(b.tempVal) ? -Infinity : b.tempVal) - (isNaN(a.tempVal) ? -Infinity : a.tempVal));
  }

  datiTabella
    .filter(s => {
      const isMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(s.stationId);
      return (!soloMLG || isMLG) && (!provFiltro || s.provincia === provFiltro);
    })
    .forEach(s => {

      const bgColor = getColor(s.tempVal);
      const textColor = getTextColorForBackground(bgColor);

      html += `
      <div style="background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 10px;">
        <div style="font-weight: bold; font-size: 15px; margin-bottom: 4px;">
          ${s.nome} <span style="font-size: 13px; color: #555;">(${s.provincia})</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-size: 13px; line-height: 1.2;">
          <div style="background-color: ${bgColor}; color: ${textColor}; padding: 2px 6px; border-radius: 4px;">🌡️ ${s.temp}°C</div>
          <div>💧 ${s.umidita}%</div><div>🔻 ${window.extremiGiornalieri[s.stationId]?.min || "--"}°C / 🔺 ${window.extremiGiornalieri[s.stationId]?.max || "--"}°C</div>
          <div>💨 ${s.raffica} km/h</div>
          <div><strong>${s.condizione}</strong></div>
          ${filtro === "pioggia" || filtro === "tutti" ? `<div>🌧️ ${s.pioggia} mm</div>` : ""}
          ${filtro === "raffica" || filtro === "tutti" ? `<div>💨 Raffica: ${s.raffica} km/h</div>` : ""}
          <div style="font-size: 10px; color: #666; flex-basis: 100%;">🕒 ${s.orario}</div>
        </div>
        ${["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1"].includes(s.stationId) ? "<div style='text-align: right; font-size:10px; color:#c00; margin-top:4px;'>★ stazione di MLG</div>" : ""}
      </div>
      `;
    });

  
  html += "</div>";

  if (mostraRiepilogo) {
    const ora = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });
    const data = new Date().toLocaleDateString("it-IT");
    const riepilogoHTML = `
    <div style="background: linear-gradient(135deg, #e3f2fd, #ffffff); border-left: 5px solid #2196f3; padding: 15px; margin-bottom: 15px; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px;">
      <div style="font-weight: bold; font-size: 16px; color: #0d47a1; margin-bottom: 8px;">Situazione in tempo reale in Calabria</div>
      <div id="riepilogo-testo">${generaRiepilogoGiornalistico(datiTabella)}</div>
      
    </div>
    `;
    document.getElementById("tabella").innerHTML = riepilogoHTML + html;
  } else {
    document.getElementById("tabella").innerHTML = html;
  }

  
}














function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<div id="slide-banner" onclick="apriInfoMappa()" style="position: fixed; right: -300px; background: #1a3a9b; color: white; padding: 10px 20px; border-radius: 4px 0 0 4px; font-size: 14px; font-weight: 500; cursor: pointer; z-index: 9999; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: right 0.5s ease; ; top: 65px">Come leggere questa mappa?<span onclick="document.getElementById('slide-banner').style.display = 'none'; event.stopPropagation();" style="margin-left: 10px; font-weight: bold;"> ✕</span></div><script>
window.addEventListener("load", function() {
  setTimeout(function() {
    document.getElementById("slide-banner").classList.add("show");
  }, 800);
});
function apriInfoMappa() {
  document.getElementById("info-mappa").style.display = "flex";
}
function chiudiInfoMappa() {
  document.getElementById("info-mappa").style.display = "none";
}
function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script><div id="info-mappa" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center; font-family:Arial,sans-serif;">
<div style="background:#fff; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;
              padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:justify;">
<h2 style="margin-top:0; color:#1a3a9b;">Come leggere questa mappa?</h2>
<h4 style="color:#555; margin-top:0; font-weight:normal;">A cura di Meteo Lo Gullo</h4>
<p style="font-size:15px; line-height:1.7; color:#333;">
        Questa piattaforma rappresenta un nuovo ramo operativo del progetto MLG, pensato per offrire una visione quanto più completa e dettagliata delle condizioni meteorologiche sull’intero territorio calabrese. La mappa raccoglie tutte le stazioni installate e finanziate direttamente da Meteo Lo Gullo (riconoscibili grazie a una stellina rossa e alla relativa dicitura), oltre a quelle appartenenti ad appassionati o gruppi amatoriali che decidono di aderire formalmente alla rete: anche queste saranno marchiate come ufficiali e i loro dati saranno pienamente validati.
        <br/><br/>
        Accanto a queste stazioni ufficiali, la mappa include una fitta rete di postazioni fisiche non direttamente gestite da MLG, le cui misurazioni vengono elaborate a partire da più centraline presenti nella stessa area geografica. Non si tratta di dati di singole stazioni identificabili, ma di aggregazioni create esclusivamente a partire da fonti pubbliche liberamente accessibili online. Nessun dato è stato prelevato da enti pubblici né da privati senza consenso: il sistema aggrega in modo trasparente ciò che già circola in rete, per offrire un quadro di riferimento il più ampio possibile.
        <br/><br/>
        Questa è la prima versione pubblica della mappa, già oggi la rete meteorologica più ampia esistente sul territorio calabrese, ma è in continua evoluzione. L’obiettivo è quello di sostituire progressivamente le postazioni riassuntive con stazioni ufficiali installate da MLG o da collaboratori affidabili. Chiunque possieda una stazione meteo in una zona attualmente coperta da dati riassuntivi e desideri offrire un dato certificato, può contattarci per entrare nella rete.
        </p>
<div style="text-align:right; margin-top:15px;">
<button onclick="chiudiInfoMappa()" style="padding:8px 16px; background:#c00; color:white; border:none; border-radius:4px; cursor:pointer;">Chiudi</button>
</div>
</div>
</div>
<!-- Firebase Script per min/max reali -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDasXnVu7uIEjpwtQ-XbVilREGmAZSBjVE",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.appspot.com",
    messagingSenderId: "469441159034",
    appId: "1:469441159034:web:b687adef4a7a742499c0c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function caricaEstremiDaFirebase() {
    const oggi = new Date();
    oggi.setHours(0, 0, 0, 0);
    const domani = new Date(oggi);
    domani.setDate(oggi.getDate() + 1);

    const q = query(
      collection(db, "osservazioni"),
      where("timestamp", ">=", Timestamp.fromDate(oggi)),
      where("timestamp", "<", Timestamp.fromDate(domani))
    );

    
    const snapshot = await getDocs(q);
    const extremi = {};

    snapshot.forEach(doc => {
      const d = doc.data();
      const id = d.stationId;
      const t = d.temperatura;

      if (!id || t == null) return;

      if (!extremi[id]) {
        extremi[id] = { min: t, max: t };
      } else {
        if (t < extremi[id].min) extremi[id].min = t;
        if (t > extremi[id].max) extremi[id].max = t;
      }
    });

    window.extremiGiornalieri = extremi;

    if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
    if (typeof aggiornaPopup === "function") aggiornaPopup(); // <-- nuova funzione se serve

    if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
  }

  window.addEventListener("load", caricaEstremiDaFirebase);
function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js">function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBlNQX8Y-REPLACE-WITH-YOURS",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.appspot.com",
    messagingSenderId: "108767339113415539553",
    appId: "1:108767339113415539553:web:dummyappid"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const map = L.map('map').setView([39.3, 16.3], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  db.collection("osservazioni").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const lat = data.latitudine;
      const lon = data.longitudine;
      if (lat && lon) {
        const popupContent = `
          <b>Stazione:</b> ${data.stationId || "N/A"}<br>
          <b>Temperatura:</b> ${data.temperatura || "-"}°C<br>
          <b>Massima:</b> ${data.Massima || "-"}°C<br>
          <b>Minima:</b> ${data.Minima || "-"}°C<br>
          <b>Umidità:</b> ${data.umidita || "-"}%<br>
          <b>Pioggia:</b> ${data.pioggia || "-"} mm<br>
          <b>Raffica:</b> ${data.raffica || "-"} km/h<br>
          <b>Ora:</b> ${new Date(data.timestamp?.seconds * 1000).toLocaleString() || "-"}
        `;
        L.marker([lat, lon]).addTo(map).bindPopup(popupContent);
      }
    });
  });
function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<!-- Firebase compat + Calcolo estremo client-side -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js">function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBlNQX8Y-REPLACE-WITH-YOURS",
  authDomain: "meteo-estremami.firebaseapp.com",
  projectId: "meteo-estremami"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

window.extremiGiornalieri = {};

function aggiornaTabellaConEstremi() {
  const righe = document.querySelectorAll("table tbody tr");
  righe.forEach(row => {
    const stationId = row.getAttribute("data-stationid");
    const dati = window.extremiGiornalieri[stationId];
    if (!dati) return;

    // Aggiunta colonne se mancanti
    if (!row.querySelector(".col-max")) {
      const maxCell = document.createElement("td");
      maxCell.className = "col-max";
      row.appendChild(maxCell);
    }
    if (!row.querySelector(".col-min")) {
      const minCell = document.createElement("td");
      minCell.className = "col-min";
      row.appendChild(minCell);
    }

    row.querySelector(".col-max").innerText = dati.max.toFixed(1);
    row.querySelector(".col-min").innerText = dati.min.toFixed(1);
  });

  const intestazioni = document.querySelectorAll("table thead tr th");
  const headerRow = document.querySelector("table thead tr");
  if (![...intestazioni].some(th => th.innerText === "Tmax")) {
    const thMax = document.createElement("th");
    thMax.innerText = "Tmax";
    headerRow.appendChild(thMax);
  }
  if (![...intestazioni].some(th => th.innerText === "Tmin")) {
    const thMin = document.createElement("th");
    thMin.innerText = "Tmin";
    headerRow.appendChild(thMin);
  }
}

function mostraEstremiNeiPopup() {
  const popupLayer = document.querySelectorAll(".leaflet-popup-content");
  popupLayer.forEach(popup => {
    const match = popup.innerHTML.match(/Stazione:\s(.+?)<br>/);
    if (!match) return;
    const stationId = match[1];
    const dati = window.extremiGiornalieri[stationId];
    if (!dati) return;

    if (!popup.innerHTML.includes("Massima:")) {
      popup.innerHTML += `<b>Massima:</b> ${dati.max} °C<br><b>Minima:</b> ${dati.min} °C<br>`;
    }
  });
}

function caricaEstremiDaFirebase() {
  const oggi = new Date().toISOString().slice(0, 10);
  const perStazione = {};

  db.collection("osservazioni").get().then((snapshot) => {
    snapshot.forEach((doc) => {
      const d = doc.data();
      if (!d.timestamp || !d.temperatura || !d.stationId) return;
      const ts = d.timestamp.seconds ? new Date(d.timestamp.seconds * 1000) : new Date(d.timestamp);
      const giorno = ts.toISOString().slice(0, 10);
      if (giorno !== oggi) return;

      if (!perStazione[d.stationId]) {
        perStazione[d.stationId] = { max: d.temperatura, min: d.temperatura };
      } else {
        perStazione[d.stationId].max = Math.max(perStazione[d.stationId].max, d.temperatura);
        perStazione[d.stationId].min = Math.min(perStazione[d.stationId].min, d.temperatura);
      }
    });

    window.extremiGiornalieri = perStazione;
    aggiornaTabellaConEstremi();
    setTimeout(mostraEstremiNeiPopup, 1000);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  caricaEstremiDaFirebase();
});
function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
<script>// Ordinamento Tmax e Tmin sulla tabella
document.addEventListener("DOMContentLoaded", () => {
  const header = document.querySelector("table thead tr");
  if (!header) return;

  function ordinaPer(colonna, crescente = true) {
    const rows = Array.from(document.querySelectorAll("table tbody tr"));
    rows.sort((a, b) => {
      const valA = parseFloat(a.querySelector(colonna)?.innerText || 0);
      const valB = parseFloat(b.querySelector(colonna)?.innerText || 0);
      return crescente ? valB - valA : valA - valB;
    });
    const tbody = document.querySelector("table tbody");
    rows.forEach(row => tbody.appendChild(row));
  }

  // Aggiunta pulsanti ordinamento se mancano
  const ths = header.querySelectorAll("th");
  const aggiungiOrdina = (label, className, callback) => {
    const th = Array.from(ths).find(th => th.innerText === label);
    if (!th || th.querySelector("button")) return;
    const btn = document.createElement("button");
    btn.innerText = "↕";
    btn.style.marginLeft = "5px";
    btn.onclick = callback;
    th.appendChild(btn);
  };

  aggiungiOrdina("Tmax", ".col-max", () => ordinaPer(".col-max", true));
  aggiungiOrdina("Tmin", ".col-min", () => ordinaPer(".col-min", false));
});




});



 else if (isFirestoreStation(staz.stationId)) {
    const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
    try {
      const res = await fetch(url);
      const json = await res.json();
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;

      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });

      callback({
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      });
    } catch (e) {
      console.error("Firestore error", e);
      callback(null);
    }
  } else {
    callback(null);
  }
}

window.extremiGiornalieri = {};

function aggiornaEstremiTutteLeStazioni() {
  stazioni.forEach((s) => {
    caricaEstremi(s, (extremes) => {
      if (extremes) {
        window.extremiGiornalieri[s.stationId] = extremes;
      }
    });
  });
}

document.addEventListener("DOMContentLoaded", function () {
  setTimeout(aggiornaEstremiTutteLeStazioni, 3000);
});

function caricaEstremi(staz, callback) {
  const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
  fetch(url)
    .then(res => res.json())
    .then(json => {
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;
      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });
      const extremes = {
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      };
      callback(extremes);
    })
    .catch(err => {
      console.error("Errore Firestore:", err);
      callback(null);
    });
}
function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    let valore;
    if (tipo === 'max') {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].max !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].max
        : d.tempMax;
    } else {
      valore = (window.extremiGiornalieri[d.stationId] && typeof window.extremiGiornalieri[d.stationId].min !== 'undefined')
        ? window.extremiGiornalieri[d.stationId].min
        : d.tempMin;
    }

    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}
</script>
</body>
</html>
